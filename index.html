
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Çavuşoğlu İsmail Yeşilyurt İHO - Sınıf Düzeyi Bilgi Yarışması</title>
    <!-- Bootstrap 4 -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <!-- Google Fonts - Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Varsayılan (Açık) Tema Renkleri */
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --info-gradient: linear-gradient(135deg, #4776E6, #8E54E9);
            --dark-color: #2c3e50;
            --light-color: #f8f9fa;
            --text-color: #333;
            --bg-color: rgba(255, 255, 255, 0.98);
            --card-bg-color: #fff;
            --header-bg-color: rgba(255, 255, 255, 0.95);
            --form-control-modern-bg: #f8f9fa;
            --form-control-modern-color: #495057;
            --form-control-modern-border: #ced4da;
            --list-group-item-bg: rgba(255,255,255,0.85);
            --rank-1-bg: #a7f3d0; --rank-1-text: #047857;
            --rank-2-bg: #bfdbfe; --rank-2-text: #1d4ed8;
            --rank-3-bg: #fef3c7; --rank-3-text: #b45309;
            --timer-display-bg: #e9ecef;
            --timer-display-text: var(--dark-color);
            --modal-header-bg: var(--dark-color);
            --modal-header-text: white;
            --btn-outline-secondary-modern-border: #6c757d;
            --btn-outline-secondary-modern-text: #6c757d;
            --btn-outline-secondary-modern-hover-bg: #6c757d;
            --btn-outline-secondary-modern-hover-text: white;
            --btn-outline-info-modern-border-image: var(--info-gradient);
            --btn-outline-info-modern-text: #4776E6;
            --btn-outline-info-modern-hover-bg: var(--info-gradient);
            --btn-outline-info-modern-hover-text: white;
            --btn-outline-success-modern-border-image: var(--success-gradient);
            --btn-outline-success-modern-text: #4FACFE;
            --btn-outline-success-modern-hover-bg: var(--success-gradient);
            --btn-outline-success-modern-hover-text: white;
            --btn-outline-danger-modern-border: #dc3545;
            --btn-outline-danger-modern-text: #dc3545;
            --btn-outline-danger-modern-hover-bg: #dc3545;
            --btn-outline-danger-modern-hover-text: white;
            --btn-outline-warning-modern-border: #ffc107;
            --btn-outline-warning-modern-text: #ffc107;
            --btn-outline-warning-modern-hover-bg: #ffc107;
            --btn-outline-warning-modern-hover-text: #212529;


            --font-base-size: 16px;
        }

        /* Koyu Tema */
        [data-theme="dark"] {
            --primary-gradient: linear-gradient(135deg, #3E4E8A 0%, #4B2A62 100%);
            --success-gradient: linear-gradient(135deg, #2f8cfe 0%, #00d2d2 100%);
            --danger-gradient: linear-gradient(135deg, #e0527a 0%, #d9c530 100%);
            --warning-gradient: linear-gradient(135deg, #d073db 0%, #d5374c 100%);
            --info-gradient: linear-gradient(135deg, #2756C6, #6E34C9);
            --dark-color: #ecf0f1;
            --light-color: #2c3e50;
            --text-color: #f1f1f1;
            --bg-color: rgba(44, 62, 80, 0.98);
            --card-bg-color: #34495e;
            --header-bg-color: rgba(44, 62, 80, 0.95);
            --form-control-modern-bg: #2c3e50;
            --form-control-modern-color: #ecf0f1;
            --form-control-modern-border: #4a637c;
            --list-group-item-bg: rgba(52, 73, 94, 0.85);
            --rank-1-bg: #1f3d2c; --rank-1-text: #a7f3d0;
            --rank-2-bg: #1e2b5e; --rank-2-text: #bfdbfe;
            --rank-3-bg: #4d2a0b; --rank-3-text: #fef3c7;
            --timer-display-bg: var(--form-control-modern-bg);
            --timer-display-text: var(--text-color);
            --modal-header-bg: var(--dark-color);
            --modal-header-text: var(--light-color);
            --btn-outline-secondary-modern-border: #bdc3c7;
            --btn-outline-secondary-modern-text: #bdc3c7;
            --btn-outline-secondary-modern-hover-bg: #bdc3c7;
            --btn-outline-secondary-modern-hover-text: #2c3e50;
            --btn-outline-info-modern-text: #4ACFFE;
            --btn-outline-success-modern-text: #00D2D2;
            --btn-outline-danger-modern-border: #e74c3c;
            --btn-outline-danger-modern-text: #e74c3c;
            --btn-outline-danger-modern-hover-bg: #e74c3c;
            --btn-outline-danger-modern-hover-text: white;
            --btn-outline-warning-modern-border: #f39c12;
            --btn-outline-warning-modern-text: #f39c12;
            --btn-outline-warning-modern-hover-bg: #f39c12;
            --btn-outline-warning-modern-hover-text: white;
        }

        /* Canlı Tema */
        [data-theme="vibrant"] {
            --primary-gradient: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
            --success-gradient: linear-gradient(135deg, #1dd1a1 0%, #48dbfb 100%);
            --danger-gradient: linear-gradient(135deg, #ff9f43 0%, #ff6b6b 100%);
            --warning-gradient: linear-gradient(135deg, #feca57 0%, #ff9f43 100%);
            --info-gradient: linear-gradient(135deg, #48dbfb, #0abde3);
            --dark-color: #1e272e;
            --light-color: #f5f6fa;
            --text-color: #2f3542;
            --bg-color: rgba(245, 246, 250, 0.98);
            --card-bg-color: #ffffff;
            --header-bg-color: rgba(255, 255, 255, 0.97);
            --form-control-modern-bg: #dfe4ea;
            --form-control-modern-color: #2f3542;
            --form-control-modern-border: #ced6e0;
            --list-group-item-bg: rgba(255,255,255,0.9);
            --rank-1-bg: #1dd1a1; --rank-1-text: white;
            --rank-2-bg: #48dbfb; --rank-2-text: #1e272e;
            --rank-3-bg: #feca57; --rank-3-text: #1e272e;
            --timer-display-bg: #ced6e0;
            --timer-display-text: var(--dark-color);
            --modal-header-bg: var(--dark-color);
            --modal-header-text: var(--light-color);
            --btn-outline-secondary-modern-border: #576574;
            --btn-outline-secondary-modern-text: #576574;
            --btn-outline-secondary-modern-hover-bg: #576574;
            --btn-outline-secondary-modern-hover-text: white;
            --btn-outline-info-modern-text: #0abde3;
            --btn-outline-success-modern-text: #10ac84;
            --btn-outline-danger-modern-border: #ff6b6b;
            --btn-outline-danger-modern-text: #ff6b6b;
            --btn-outline-danger-modern-hover-bg: #ff6b6b;
            --btn-outline-danger-modern-hover-text: white;
            --btn-outline-warning-modern-border: #ff9f43;
            --btn-outline-warning-modern-text: #ff9f43;
            --btn-outline-warning-modern-hover-bg: #ff9f43;
            --btn-outline-warning-modern-hover-text: white;
        }

        html { font-size: var(--font-base-size); }
        body {
            font-family: 'Poppins', sans-serif; background: var(--primary-gradient);
            min-height: 100vh; color: var(--text-color); padding-top: 75px;
            display: flex; flex-direction: column; align-items: center;
            transition: background 0.3s ease, color 0.3s ease;
        }
        .fixed-header {
            position: fixed; top: 0; left: 0; width: 100%;
            background: var(--header-bg-color); backdrop-filter: blur(10px);
            padding: 0.8rem 1.5rem; box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            z-index: 1030; display: flex; justify-content: space-between; align-items: center;
            transition: background-color 0.3s ease;
        }
        .fixed-header .quiz-app-title {
            font-size: 1.3rem; font-weight: 600; background: var(--primary-gradient);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
            transition: background 0.3s ease;
        }
        [data-theme="dark"] .fixed-header .quiz-app-title,
        [data-theme="vibrant"] .fixed-header .quiz-app-title {
            -webkit-text-fill-color: var(--text-color);
        }
        .fixed-header .header-buttons .btn {
            font-size: 0.85rem; padding: 0.5rem 1rem; margin-left: 0.5rem;
            border-radius: 20px; font-weight: 500; transition: all 0.3s ease;
        }
        .btn-outline-info-modern {
            border: 2px solid; border-image-slice: 1; border-image-source: var(--btn-outline-info-modern-border-image);
            color: var(--btn-outline-info-modern-text); background-color: transparent;
        }
        .btn-outline-info-modern:hover, .btn-outline-info-modern.active { background: var(--btn-outline-info-modern-hover-bg); color: var(--btn-outline-info-modern-hover-text); border-color: transparent; }

        .btn-outline-secondary-modern {
            border: 2px solid var(--btn-outline-secondary-modern-border); color: var(--btn-outline-secondary-modern-text);
        }
        .btn-outline-secondary-modern:hover, .btn-outline-secondary-modern.active { background-color: var(--btn-outline-secondary-modern-hover-bg); color: var(--btn-outline-secondary-modern-hover-text); }

        .btn-outline-success-modern {
             border: 2px solid; border-image-slice: 1; border-image-source: var(--btn-outline-success-modern-border-image); color: var(--btn-outline-success-modern-text);
        }
        .btn-outline-success-modern:hover, .btn-outline-success-modern.active { background: var(--btn-outline-success-modern-hover-bg); color: var(--btn-outline-success-modern-hover-text); border-color: transparent; }

        .btn-outline-danger-modern {
            border: 2px solid var(--btn-outline-danger-modern-border); color: var(--btn-outline-danger-modern-text);
        }
        .btn-outline-danger-modern:hover, .btn-outline-danger-modern.active { background-color: var(--btn-outline-danger-modern-hover-bg); color: var(--btn-outline-danger-modern-hover-text); }

        .btn-outline-warning-modern {
            border: 2px solid var(--btn-outline-warning-modern-border); color: var(--btn-outline-warning-modern-text);
        }
        .btn-outline-warning-modern:hover, .btn-outline-warning-modern.active { background-color: var(--btn-outline-warning-modern-hover-bg); color: var(--btn-outline-warning-modern-hover-text); }


        .container-main {
            padding: 2rem; border-radius: 18px; margin: 2rem auto; max-width: 1100px;
            background: var(--bg-color); border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); width: 90%;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        #home-page-container, #grade-selection-page {
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            min-height: calc(100vh - 150px); text-align: center;
        }
        #home-background-image-display {
            display: none; max-width: 80%; max-height: 60vh; margin-bottom: 2rem;
            border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); object-fit: contain;
        }
        h1.section-title, h3.section-title-sm {
            text-align: center; margin-bottom: 2rem; font-weight: 700; position: relative; padding-bottom: 0.7rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
            transition: background 0.3s ease;
        }
        [data-theme="dark"] h1.section-title, [data-theme="dark"] h3.section-title-sm,
        [data-theme="vibrant"] h1.section-title, [data-theme="vibrant"] h3.section-title-sm {
             -webkit-text-fill-color: var(--text-color);
        }
        h1.section-title { font-size: 2.3rem; letter-spacing: -1px; }
        h3.section-title-sm { font-size: 1.8rem; letter-spacing: -0.5px; margin-bottom: 1.5rem; }
        h1.section-title::after, h3.section-title-sm::after {
            content: ''; position: absolute; bottom: 0; left: 50%;
            transform: translateX(-50%); width: 70px; height: 3px;
            background: var(--primary-gradient); border-radius: 2px;
            transition: background 0.3s ease;
        }
        .btn-modern {
            border: none; border-radius: 25px; padding: 10px 25px; font-weight: 600;
            transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px;
            position: relative; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .btn-modern:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.15); }
        .btn-modern i { margin-right: 0.5rem; }
        .btn-primary-modern { background: var(--primary-gradient); color: white; }
        .btn-success-modern { background: var(--success-gradient); color: white; }
        [data-theme="dark"] .btn-success-modern, [data-theme="vibrant"] .btn-success-modern { color: #222; }
        .btn-danger-modern { background: var(--danger-gradient); color: #333; }
        .btn-warning-modern { background: var(--warning-gradient); color: white; }
        [data-theme="dark"] .btn-warning-modern, [data-theme="vibrant"] .btn-warning-modern { color: #222; }
        .btn-info-modern { background: var(--info-gradient); color: white;}
        .card-modern {
            background: var(--card-bg-color); border: 1px solid var(--form-control-modern-border); border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.07);
            transition: all 0.3s ease; margin-bottom: 1.5rem;
        }
        .card-modern .card-header {
            background: var(--dark-color); color: var(--light-color); padding: 0.9rem 1.3rem;
            font-size: 1.15rem; font-weight: 600; border-bottom: none;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .card-modern .card-body { padding: 1.5rem; }
        #quiz-question-text-container { display: flex; align-items: flex-start; margin-bottom: 1.5rem; }
        #quiz-question-number {
            font-size: 2.8rem; font-weight: 700; color: var(--dark-color);
            margin-right: 1rem; line-height: 1.2; align-self: flex-start; opacity: 0.7;
            transition: color 0.3s ease;
        }
        #quiz-question-text {
            font-size: 1.7rem; font-weight: bold; color: var(--text-color);
            line-height: 1.45; text-align: left !important; flex-grow: 1; margin-bottom: 0;
            transition: color 0.3s ease;
        }
        #correct-answer-display-area {
            margin-top: 1rem; padding: 1rem; background-color: #e9f7ef;
            border: 1px solid #d1e7dd; border-radius: 8px; display: none;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        [data-theme="dark"] #correct-answer-display-area {
            background-color: #1a4a32; border-color: #2a6a4a;
        }
        [data-theme="vibrant"] #correct-answer-display-area {
            background-color: #c8f7e8; border-color: #1dd1a1;
        }
        #correct-answer-display-area strong { color: #0f5132; font-size: 1.2rem; transition: color 0.3s ease;}
        [data-theme="dark"] #correct-answer-display-area strong { color: #7fe7b2; }
        [data-theme="vibrant"] #correct-answer-display-area strong { color: #10ac84; }
        #correct-answer-display-text { font-size: 1.1rem; color: #146c43; transition: color 0.3s ease;}
        [data-theme="dark"] #correct-answer-display-text { color: #a1f0c2; }
        [data-theme="vibrant"] #correct-answer-display-text { color: #10ac84; }

        .quiz-timer-layout {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1rem; flex-wrap: wrap;
        }
        .quiz-timer-layout > div { flex: 1; text-align: center; }
        .quiz-timer-layout .timer-info-box {
            font-size: 1.1rem; font-weight: 500; padding: 0.5rem 0.8rem; border-radius: 8px;
            background-color: rgba(0,0,0,0.05); color: var(--text-color);
            min-width: 180px; margin: 0.3rem;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        [data-theme="dark"] .quiz-timer-layout .timer-info-box { background-color: rgba(255,255,255,0.08); }
        [data-theme="vibrant"] .quiz-timer-layout .timer-info-box { background-color: rgba(0,0,0,0.06); }

        .quiz-timer-layout .timer-info-box .badge { font-size: 1rem; padding: 0.3em 0.5em; }
        #timer-display-wrapper { flex: 0 0 auto; margin: 0 1rem; }
        .quiz-timer-area { text-align: center; margin-bottom: 1.5rem; }
        #timer-display {
            font-size: 4.5rem; font-weight: 700; padding: 0.8rem 1.2rem; border-radius: 12px;
            background-color: var(--timer-display-bg); color: var(--timer-display-text);
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.08); display: inline-block; min-width: 150px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        #timer-display.running { /* Renk gradient olarak kalmalı */ }
        #timer-display.paused { /* Renk gradient olarak kalmalı */ animation: none; }
        #timer-display.ending { color: #d35400; animation: pulseTimer 1s infinite; }
        #timer-display.ended { /* Renk gradient olarak kalmalı */ animation: none; }

        #time-ended-message {
            font-size: 2.2rem; font-weight: bold;
            text-align: center; margin-top: 0.8rem; display: none;
        }
        #time-ended-message.text-gradient {
            background: var(--danger-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .pause-resume-quiz-timer-btn, #show-answer-btn, #start-timer-manually-btn,
        #restart-quiz-timer-btn, /* YENİ BUTON */
        #teacher-show-question-btn, #teacher-show-correct-answer-btn {
            font-size: 0.9rem; padding: 0.6rem 1.1rem; margin-top: 1rem; border-radius: 20px;
        }
        #previous-question-btn { font-size: 1rem; padding: 0.75rem 1.5rem; margin-right: 0.5rem; }
        @keyframes pulseTimer { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03); } }
        #image-preview, #quiz-question-image {
            display: block; margin: 1.5rem auto; border: 1px solid var(--form-control-modern-border); padding: 0.5rem;
            border-radius: 10px; background-color: var(--card-bg-color); max-width: 100%;
            height: auto; max-height: 300px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .player-score-table { border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.07); }
        .player-score-table th, .player-score-table td {
            vertical-align: middle; text-align: center; font-size: 1rem; padding: 0.7rem;
            color: var(--text-color);
            border-color: var(--form-control-modern-border);
            transition: color 0.3s ease, border-color 0.3s ease, background-color 0.3s ease;
        }
        .player-score-table th { background: var(--dark-color); color: var(--light-color); font-size: 1.1rem;}
        .player-score-table .rank { font-weight: 700; font-size: 1.15rem; }
        .player-score-table .player-name { font-weight: 500; font-size: 1.05rem;}
        .player-score-table .player-score { font-weight: 700; font-size: 1.25rem; }
        .player-score-table .question-score-cell { font-size: 0.9rem; min-width: 40px; }
        .player-score-table .question-header-cell {
            font-size: 0.9rem; writing-mode: vertical-rl; text-orientation: mixed;
            white-space: nowrap; min-width: 30px; padding: 5px 2px;
        }
        .player-score-table tr.rank-1 td { background-color: var(--rank-1-bg) !important; color: var(--rank-1-text); }
        .player-score-table tr.rank-2 td { background-color: var(--rank-2-bg) !important; color: var(--rank-2-text); }
        .player-score-table tr.rank-3 td { background-color: var(--rank-3-bg) !important; color: var(--rank-3-text); }
        #answer-input-section-dynamic .player-answer-row-openended {
            background: var(--list-group-item-bg); border: 1px solid var(--form-control-modern-border);
            border-radius: 10px; margin-bottom: 0.8rem; padding: 1rem; display: flex; flex-direction: column;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        #answer-input-section-dynamic .player-info-line {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;
        }
        #answer-input-section-dynamic .player-info-line span {
            font-weight: 600; color: var(--text-color); font-size: 1.1rem;
            transition: color 0.3s ease;
        }
        #answer-input-section-dynamic .player-answer-textarea {
            width: 100%; margin-bottom: 0.75rem; min-height: 80px;
            font-size: 50px !important; line-height: 1.3; padding: 10px;
            background-color: var(--form-control-modern-bg);
            color: var(--form-control-modern-color);
            border: 1px solid var(--form-control-modern-border);
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        #answer-input-section-dynamic .admin-decision-buttons .btn {
            transition: all 0.25s ease; border-radius: 20px; padding: 0.4rem 1rem;
            font-weight: 500; font-size: 0.85rem;
        }
        #answer-input-section-dynamic .admin-decision-buttons .btn.btn-success-modern.active {
            background: var(--success-gradient) !important; color: white !important;
            box-shadow: 0 4px 10px rgba(79, 172, 254, 0.3); transform: scale(1.02);
        }
        [data-theme="dark"] #answer-input-section-dynamic .admin-decision-buttons .btn.btn-success-modern.active,
        [data-theme="vibrant"] #answer-input-section-dynamic .admin-decision-buttons .btn.btn-success-modern.active {
             color: #222 !important;
        }

        #answer-input-section-dynamic .admin-decision-buttons .btn.btn-danger-modern.active {
            background: var(--danger-gradient) !important; color: #333 !important;
            box-shadow: 0 4px 10px rgba(250, 112, 154, 0.3); transform: scale(1.02);
        }
        .existing-question-item .btn-move { padding: 0.1rem 0.4rem; font-size: 0.8rem; line-height: 1; margin-left: 0.2rem; }
        .existing-question-item .question-select-checkbox {
            transform: scale(1.3); margin-right: 10px !important; vertical-align: middle;
        }
        #select-all-questions-checkbox { transform: scale(1.3); vertical-align: middle; }
        .list-group-item > .question-select-checkbox { position: relative; top: -2px; }
        .list-group-item {
             background-color: var(--list-group-item-bg) !important;
             border: 1px solid var(--form-control-modern-border) !important;
             color: var(--text-color);
             transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .form-control-modern {
            border: 1px solid var(--form-control-modern-border); border-radius: 8px; padding: 0.75rem 1rem;
            transition: all 0.3s ease; background-color: var(--form-control-modern-bg);
            color: var(--form-control-modern-color);
        }
        .form-control-modern:focus {
            border-color: var(--primary-gradient);
            box-shadow: 0 0 0 0.2rem rgba(102,126,234, 0.25);
            background-color: var(--card-bg-color);
        }
        .form-group label { font-weight: 500; margin-bottom: 0.3rem; color: var(--text-color); opacity: 0.9; transition: color 0.3s ease;}
        .time-limit-options label { margin-right: 0.5rem; font-size: 0.9rem;}
        #admin-login-modal .modal-content {
            border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            background-color: var(--card-bg-color);
            transition: background-color 0.3s ease;
        }
        #admin-login-modal .modal-header {
            background: var(--modal-header-bg); color: var(--modal-header-text);
            border-top-left-radius: 15px; border-top-right-radius: 15px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        #admin-login-modal .modal-header .close { color: var(--modal-header-text); opacity: 0.8; transition: color 0.3s ease;}
        .question-io-section { border-top: 2px dashed var(--form-control-modern-border); padding-top: 1.5rem; margin-top: 1.5rem; transition: border-color 0.3s ease;}
        .grade-selection-button { font-size: 1.2rem !important; margin-bottom: 1rem !important; padding: 0.8rem 1.5rem !important;}

        .admin-settings-section {
            background: rgba(0,0,0,0.03);
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            border: 1px solid var(--form-control-modern-border);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        [data-theme="dark"] .admin-settings-section {
            background: rgba(255,255,255,0.05);
        }
        [data-theme="vibrant"] .admin-settings-section {
            background: rgba(0,0,0,0.04);
        }
        .admin-settings-section h5 {
            margin-bottom: 1rem;
            font-weight: 600;
            color: var(--text-color);
            transition: color 0.3s ease;
        }
        .font-size-controls .form-control-modern {
            text-align: center;
            font-weight: 500;
        }
        .font-size-controls button { min-width: 45px; }

        #preview-question-text-container { display: flex; align-items: flex-start; margin-bottom: 1.5rem; }
        #preview-question-number { font-size: 2.8rem; font-weight: 700; color: var(--dark-color); margin-right: 1rem; line-height: 1.2; align-self: flex-start; opacity: 0.7; transition: color 0.3s ease;}
        #preview-question-text { font-size: 1.7rem; font-weight: bold; color: var(--text-color); line-height: 1.45; text-align: left !important; flex-grow: 1; margin-bottom: 0; transition: color 0.3s ease;}
        #preview-question-image { display: block; margin: 1.5rem auto; border: 1px solid var(--form-control-modern-border); padding: 0.5rem; border-radius: 10px; background-color: var(--card-bg-color); max-width: 100%; height: auto; max-height: 300px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: background-color 0.3s ease, border-color 0.3s ease;}
        #preview-correct-answer-display-area {
            margin-top: 1rem; padding: 1rem; background: var(--success-gradient);
            color: white; border-radius: 8px; display: none;
            transition: background 0.3s ease, color 0.3s ease;
        }
        [data-theme="dark"] #preview-correct-answer-display-area,
        [data-theme="vibrant"] #preview-correct-answer-display-area { color: #222; }
        #preview-correct-answer-display-area strong { font-size: 1.2rem; }
        #preview-correct-answer-display-text { font-size: 1.1rem; }
        #preview-navigation-buttons .btn { margin: 0 0.3rem !important; }

        /* Soru Navigasyon Butonları Stili */
        #question-navigation-buttons-container .btn {
            min-width: 40px;
            border-radius: 50%;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        #question-navigation-buttons-container .btn.btn-nav-yedek {
            /* Ana yarışmadaki yedek sorular için özel stil (isteğe bağlı) */
        }
        #question-navigation-buttons-container .btn.active {
            transform: scale(1.15);
            box-shadow: 0 0 12px rgba(var(--dark-color-rgb, 44, 62, 80), 0.3);
        }
        #question-navigation-buttons-container .btn:not(.active):hover {
            transform: translateY(-1px);
        }
        #question-navigation-buttons-container .btn.btn-outline-secondary-modern:not(.active) {
           /* Öğrenci için kilitli ama tıklanabilir butonların görünümü */
           /* CSS'de :root altında --btn-outline-secondary-modern-text vs. zaten var */
        }


        @media (max-width: 991.98px) {
             body { padding-top: 100px; }
             .fixed-header {
                padding: 0.6rem 1rem;
             }
             .fixed-header .quiz-app-title { font-size: 1.1rem; }
        }

        @media (max-width: 767.98px) {
            body { padding-top: 130px; }
            .fixed-header {
                flex-direction: column;
                align-items: center;
                padding-bottom: 0.8rem;
                text-align: center;
            }
            .fixed-header .header-buttons {
                margin-top: 0.6rem;
                flex-wrap: wrap;
                justify-content: center;
            }
             .fixed-header .header-buttons .btn { margin-bottom: 0.3rem; }

            .container-main { padding: 1.5rem; margin: 1.2rem auto; }
            h1.section-title { font-size: 1.9rem; }
            h3.section-title-sm { font-size: 1.6rem; }
            h1.quiz-title-display { font-size: 1.8rem; }
            #quiz-question-number { font-size: 2.2rem; }
            #quiz-question-text { font-size: 1.4rem; }
            .quiz-timer-layout .timer-info-box { font-size: 0.95rem; min-width: 150px;}
            #timer-display { font-size: 3.5rem; min-width: 120px; }
            #time-ended-message { font-size: 1.8rem; }
            .player-score-table th, .player-score-table td { font-size: 0.8rem; padding: 0.5rem; }
            .player-score-table .player-score { font-size: 0.9rem; }
            .player-score-table .question-header-cell { font-size: 0.8rem; writing-mode: initial; text-orientation: initial; white-space: normal; }
            #answer-input-section-dynamic .player-answer-textarea { font-size: 35px !important; }
            .nav-buttons button, .quiz-control-buttons button, .btn-modern { font-size: 0.8rem; padding: 0.5rem 0.9rem; }
            .col-md-6 { margin-bottom: 1rem !important; }
             .admin-settings-section { padding: 1rem; }
             #question-navigation-buttons-container .btn { min-width: 35px; font-size: 0.8rem; padding: 0.3rem; }
        }
        @media (max-width: 575.98px) {
            body { padding-top: 170px; }
            .fixed-header .header-buttons .btn { width: calc(50% - 0.5rem); margin-left: 0.25rem; margin-right: 0.25rem; }
            #quiz-question-number { font-size: 2rem; }
            #quiz-question-text { font-size: 1.25rem; }
            .quiz-timer-layout { flex-direction: column; }
            .quiz-timer-layout > div { margin-bottom: 0.5rem; width: 100%; }
            .quiz-timer-layout .timer-info-box { width: 100%; }
            #timer-display { font-size: 3.2rem; min-width: 100px; }
            #answer-input-section-dynamic .player-answer-textarea { font-size: 30px !important; }
            .form-control-lg { font-size: 1rem; padding: 0.6rem 1rem; }
             #answer-input-section-dynamic .player-info-line { flex-direction: column; align-items: flex-start; }
            #answer-input-section-dynamic .player-info-line .admin-decision-buttons { margin-top: 0.5rem; width: 100%; display: flex; justify-content: space-around;}
            .player-score-table .question-header-cell { font-size:0.7rem; padding: 3px 1px; }
            .admin-settings-section .form-group { flex-direction: column; align-items: stretch;}
            .admin-settings-section .form-group label { margin-bottom: 0.5rem; }
            .font-size-controls { width: 100%; }
            #question-navigation-buttons-container .btn { min-width: 30px; font-size: 0.75rem; padding: 0.25rem; margin: 2px !important; }
        }
    </style>
</head>
<body>
    <div class="fixed-header">
        <div id="main-app-title" class="quiz-app-title">Çavuşoğlu İsmail Yeşilyurt İHO - Bilgi Yarışması</div>
        <div class="header-buttons d-flex align-items-center">
            <button id="home-action-btn" class="btn btn-outline-secondary-modern btn-modern mr-2">
                <i class="fas fa-home mr-1"></i>Ana Sayfa
            </button>
            <button id="admin-panel-btn" class="btn btn-outline-warning-modern btn-modern mr-2">
                <i class="fas fa-user-shield mr-1"></i>Admin Paneli
            </button>
            <button id="show-scores-header-btn" class="btn btn-outline-info-modern btn-modern mr-2" style="display: none;">
                <i class="fas fa-clipboard-list mr-1"></i>Puanlar
            </button>
             <button id="reset-all-data-btn" class="btn btn-danger-modern btn-modern ml-auto" title="Aktif Sınıfın Tüm Yarışma Verilerini ve Puanlarını Sıfırla" style="display: none;">
                <i class="fas fa-bomb mr-1"></i>Aktif Sınıf Verilerini Sıfırla
            </button>
        </div>
    </div>

    <div id="home-page-container" class="container-main animate__animated animate__fadeIn">
        <img id="home-background-image-display" src="#" alt="Ana Sayfa Arka Planı" style="display: none;">
        <h1 class="section-title mb-4">Giriş Türü Seçiniz</h1>
        <button id="student-login-type-btn" class="btn btn-primary-modern btn-modern btn-lg mb-3 py-3 px-5" style="font-size: 1.5rem;">
            <i class="fas fa-user-graduate mr-2"></i> Öğrenci Girişi
        </button>
        <button id="teacher-login-type-btn" class="btn btn-info-modern btn-modern btn-lg mb-3 py-3 px-5" style="font-size: 1.5rem;">
            <i class="fas fa-chalkboard-teacher mr-2"></i> Öğretmen Girişi
        </button>
        <button id="student-yedek-login-type-btn" class="btn btn-success-modern btn-modern btn-lg mb-3 py-3 px-5" style="font-size: 1.5rem;">
            <i class="fas fa-eye mr-2"></i> Yedek Soruları Görüntüle
        </button>
    </div>

    <div id="grade-selection-page" class="container-main animate__animated" style="display: none;">
        <h1 id="grade-selection-title" class="section-title mb-4">Sınıf Düzeyini Seçin</h1>
        <div id="grade-buttons-container" class="d-flex flex-column align-items-center w-100">
        </div>
        <button id="back-to-home-from-grade-selection-btn" class="btn btn-outline-secondary-modern btn-modern mt-4">
            <i class="fas fa-arrow-left mr-1"></i>Geri
        </button>
    </div>

    <div id="admin-section" class="container-main animate__animated animate__fadeIn" style="display: none;">
        <div id="admin-login-form-container">
            <h1 class="section-title">Admin Girişi</h1>
            <div class="card-modern">
                <div class="card-body">
                    <form id="admin-login-form">
                        <div class="form-group">
                            <label for="admin-username">Kullanıcı Adı:</label>
                            <input type="text" id="admin-username" class="form-control form-control-modern" value="admin" required>
                        </div>
                        <div class="form-group">
                            <label for="admin-password">Şifre:</label>
                            <input type="password" id="admin-password" class="form-control form-control-modern" value="2345" required>
                        </div>
                        <button type="submit" class="btn btn-primary-modern btn-modern btn-block">Giriş Yap</button>
                        <div id="admin-login-error" class="text-danger mt-2" style="display:none;">Kullanıcı adı veya şifre yanlış!</div>
                    </form>
                </div>
            </div>
        </div>
        <div id="admin-management-panel" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                <h1 class="section-title mb-0" style="padding-bottom: 0; margin-bottom:0; font-size: 1.8rem;">Admin Yönetim Paneli</h1>
                <button id="admin-logout-btn" class="btn btn-danger-modern btn-modern mt-2 mt-md-0">
                    <i class="fas fa-sign-out-alt mr-1"></i>Çıkış Yap
                </button>
            </div>

            <div class="admin-settings-section card-modern mt-4">
                <div class="card-body">
                    <h5><i class="fas fa-palette mr-2"></i>Görünüm ve Ses Ayarları</h5>
                    <div class="row">
                        <div class="col-md-4 mb-3 mb-md-0">
                            <div class="form-group">
                                <label for="theme-select">Tema Seçin:</label>
                                <select id="theme-select" class="form-control form-control-modern">
                                    <option value="light">Açık Tema (Varsayılan)</option>
                                    <option value="dark">Koyu Tema</option>
                                    <option value="vibrant">Canlı Tema</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-5 mb-3 mb-md-0">
                            <div class="form-group">
                                <label>Yazı Tipi Boyutu:</label>
                                <div class="input-group font-size-controls">
                                    <div class="input-group-prepend">
                                        <button class="btn btn-outline-secondary-modern btn-modern" type="button" id="decrease-font-size" title="Yazı Boyutunu Küçült">-</button>
                                    </div>
                                    <input type="text" class="form-control form-control-modern" id="current-font-size-display" value="16px" readonly>
                                    <div class="input-group-append">
                                        <button class="btn btn-outline-secondary-modern btn-modern" type="button" id="increase-font-size" title="Yazı Boyutunu Büyüt">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                             <div class="form-group w-100">
                                <label>Ses Efektleri:</label>
                                <div class="custom-control custom-switch">
                                    <input type="checkbox" class="custom-control-input" id="toggle-sound-effects" checked>
                                    <label class="custom-control-label" for="toggle-sound-effects">Etkin</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group mt-4">
                <label for="admin-grade-level-select" class="h5">Yönetilecek Sınıf Düzeyi / Soru Bankası:</label>
                <select id="admin-grade-level-select" class="form-control form-control-modern form-control-lg"></select>
            </div>

             <div id="preview-quiz-btn-container" class="text-center my-3">
                 <button id="preview-quiz-btn" class="btn btn-info-modern btn-modern">
                    <i class="fas fa-eye mr-1"></i> Seçili Bankadaki Soruları Önizle (1.den itibaren)
                </button>
            </div>

             <div id="continue-quiz-btn-container" style="display: none; margin-top: 1rem; margin-bottom:1rem; text-align:center;">
                 <button id="continue-quiz-btn" class="btn btn-warning-modern btn-modern">
                    <i class="fas fa-play-circle mr-1"></i>Yarım Kalan Yarışmaya Devam Et (Öğretmen)
                </button>
            </div>

            <div id="setup-area-admin">
                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card-modern" id="admin-panel-players-card">
                            <div class="card-header"><i class="fas fa-users mr-2"></i>Yarışmacılar (<span id="current-admin-grade-display-players"></span>)</div>
                            <div class="card-body">
                                <form id="add-player-form" class="mb-3">
                                    <div class="input-group">
                                        <input type="text" class="form-control form-control-modern" id="player-name-input" placeholder="Yarışmacı Adı/Şubesi" required>
                                        <div class="input-group-append">
                                            <button type="submit" class="btn btn-success-modern btn-modern">
                                                <i class="fas fa-user-plus mr-1"></i>Ekle
                                            </button>
                                        </div>
                                    </div>
                                </form>
                                <ul id="player-list" class="list-group list-group-flush" style="max-height: 180px; overflow-y: auto;"></ul>
                            </div>
                        </div>
                         <div class="card-modern mt-4">
                            <div class="card-header"><i class="fas fa-key mr-2"></i>Admin Şifre Değiştir</div>
                            <div class="card-body">
                                <form id="change-admin-password-form">
                                    <div class="form-group">
                                        <label for="current-admin-password">Mevcut Şifre:</label>
                                        <input type="password" id="current-admin-password" class="form-control form-control-modern" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="new-admin-password">Yeni Şifre:</label>
                                        <input type="password" id="new-admin-password" class="form-control form-control-modern" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="confirm-new-admin-password">Yeni Şifre (Tekrar):</label>
                                        <input type="password" id="confirm-new-admin-password" class="form-control form-control-modern" required>
                                    </div>
                                    <button type="submit" class="btn btn-warning-modern btn-modern btn-block">Admin Şifresini Değiştir</button>
                                    <div id="change-password-message" class="mt-2"></div>
                                </form>
                            </div>
                        </div>
                        <div class="card-modern mt-4" id="teacher-password-card">
                            <div class="card-header"><i class="fas fa-chalkboard-teacher mr-2"></i>Öğretmen Giriş Şifresi (<span id="current-admin-grade-display-teacherpass"></span>)</div>
                            <div class="card-body">
                                <form id="change-teacher-login-password-form">
                                    <div class="form-group">
                                        <label for="teacher-login-password-input">Öğretmen Giriş Şifresi:</label>
                                        <input type="text" id="teacher-login-password-input" class="form-control form-control-modern" required>
                                        <small class="form-text text-muted">Bu sınıf düzeyindeki öğretmenlerin yarışmaya girmek için kullanacağı şifre.</small>
                                    </div>
                                    <button type="submit" class="btn btn-primary-modern btn-modern btn-block">Öğretmen Şifresini Kaydet</button>
                                    <div id="teacher-login-password-message" class="mt-2"></div>
                                </form>
                            </div>
                        </div>
                        <div class="card-modern mt-4">
                            <div class="card-header"><i class="fas fa-image mr-2"></i>Ana Sayfa Arka Plan Resmi (Global)</div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label for="home-background-image-input">Resim Yükle:</label>
                                    <input type="file" id="home-background-image-input" class="form-control form-control-modern" accept="image/*">
                                </div>
                                <img id="home-background-image-preview" src="#" alt="Resim Önizleme" class="mt-2 mb-3" style="max-width: 200px; display: none; border-radius: 5px; border: 1px solid #ddd;">
                                <div class="d-flex">
                                    <button type="button" id="save-home-background-btn" class="btn btn-primary-modern btn-modern mr-2 flex-grow-1">
                                        <i class="fas fa-save mr-1"></i> Resmi Kaydet
                                    </button>
                                    <button type="button" id="delete-home-background-btn" class="btn btn-danger-modern btn-modern flex-grow-1">
                                        <i class="fas fa-trash-alt mr-1"></i> Resmi Sil
                                    </button>
                                </div>
                                <div id="home-background-message" class="mt-2"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-4">
                        <div id="admin-panel-questions" class="card-modern">
                            <div class="card-header"><i class="fas fa-edit mr-2"></i><span id="question-form-title">Soru Ekle/Düzenle</span> (<span id="current-admin-grade-display-questions"></span>)</div>
                            <div class="card-body">
                                <form id="add-question-form" class="mb-4">
                                    <input type="hidden" id="editing-question-id">
                                    <div class="form-group mb-3">
                                        <label for="question-section">Bölüm Adı:</label>
                                        <input type="text" class="form-control form-control-modern" id="question-section" placeholder="Örn: Tarih">
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="question-text">Soru Metni:</label>
                                        <textarea class="form-control form-control-modern" id="question-text" rows="2" required></textarea>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="question-image">Soru Resmi (Opsiyonel):</label>
                                        <input type="file" class="form-control form-control-modern" id="question-image" accept="image/*">
                                        <img id="image-preview" src="#" alt="Önizleme" class="mt-2" style="max-width: 120px; display: none; border-radius: 5px;"/>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="correct-answer-text-input">Doğru Cevap Metni:</label>
                                        <input type="text" class="form-control form-control-modern" id="correct-answer-text-input" placeholder="Kabul edilecek cevap" required>
                                        <small class="form-text text-muted">Birden fazla kabul edilebilir cevap varsa virgülle ayırın.</small>
                                    </div>
                                    <div class="form-group time-limit-options mb-3">
                                        <label>Soru Süresi (Öğretmen Modu İçin):</label>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="questionTimeLimit" id="time30" value="30" checked>
                                            <label class="form-check-label" for="time30">30sn</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="questionTimeLimit" id="time60" value="60">
                                            <label class="form-check-label" for="time60">60sn</label>
                                        </div>
                                        <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="questionTimeLimit" id="time120" value="120">
                                            <label class="form-check-label" for="time120">120sn</label>
                                        </div>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="next-question-password-input">Sonraki Soruya Geçiş Şifresi (Opsiyonel):</label>
                                        <input type="text" class="form-control form-control-modern" id="next-question-password-input" placeholder="Boş bırakırsanız şifresiz geçiş">
                                    </div>
                                    <div class="d-flex">
                                        <button type="submit" id="submit-question-btn" class="btn btn-primary-modern btn-modern flex-grow-1 mr-2">
                                            <i class="fas fa-plus mr-1"></i>Soruyu Ekle
                                        </button>
                                        <button type="button" id="cancel-edit-btn" class="btn btn-outline-secondary-modern btn-modern" style="display:none;">
                                            <i class="fas fa-times mr-1"></i>İptal
                                        </button>
                                    </div>
                                </form>
                                <h4 class="mt-4"><i class="fas fa-list-alt mr-2"></i>Mevcut Sorular (<span id="question-count">0</span>)</h4>
                                <div class="d-flex justify-content-between align-items-center mb-2 mt-3">
                                    <div>
                                        <input type="checkbox" id="select-all-questions-checkbox" class="mr-1">
                                        <label for="select-all-questions-checkbox" class="mb-0 align-middle font-weight-normal" style="font-size:0.9rem;">Tümünü Seç/Bırak</label>
                                    </div>
                                    <button id="delete-selected-questions-btn" class="btn btn-danger-modern btn-modern btn-sm py-1 px-2">
                                        <i class="fas fa-trash-alt mr-1"></i>Seçili Soruları Sil
                                    </button>
                                </div>
                                <ul id="existing-questions" class="list-group list-group-flush" style="max-height: 200px; overflow-y: auto;"></ul>

                                <div class="question-io-section mt-4">
                                     <h5 class="section-title-sm" style="font-size:1.3rem; margin-bottom: 1rem;">Veri İşlemleri (<span id="current-admin-grade-display-dataop"></span>)</h5>
                                    <div class="form-group">
                                        <button id="export-questions-json-btn" class="btn btn-info-modern btn-modern btn-block mb-2">
                                            <i class="fas fa-file-export mr-1"></i> Soruları JSON Olarak İndir
                                        </button>
                                    </div>
                                    <div class="form-group">
                                        <label for="import-questions-json-file">Soruları JSON Dosyasından Yükle:</label>
                                        <input type="file" id="import-questions-json-file" class="form-control form-control-modern" accept=".json">
                                    </div>
                                    <div class="form-group mt-3">
                                        <button id="export-answers-csv-admin-btn" class="btn btn-success-modern btn-modern btn-block">
                                            <i class="fas fa-file-csv mr-1"></i> Seçili Sınıfın/Bankanın Cevaplarını CSV İndir
                                        </button>
                                    </div>
                                    <div class="form-group mt-3">
                                        <label for="import-answers-csv-file">Cevapları ve Puanları CSV Dosyasından Yükle:</label>
                                        <input type="file" id="import-answers-csv-file" class="form-control form-control-modern" accept=".csv">
                                    </div>
                                    <button id="upload-answers-csv-btn" class="btn btn-warning-modern btn-modern btn-block mt-2">
                                        <i class="fas fa-file-upload mr-1"></i> Seçili CSV'yi Yükle ve İşle
                                    </button>
                                    <div id="question-io-message" class="mt-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="quiz-preview-area" class="container-main animate__animated" style="display: none;">
        <h1 id="preview-title-display" class="section-title text-center">Soru Önizleme</h1>
        <div id="preview-question-container" class="card-modern mb-4" style="display:none;">
            <div class="card-body">
                <div id="preview-question-text-container">
                    <span id="preview-question-number"></span>
                    <p id="preview-question-text"></p>
                </div>
                <img id="preview-question-image" src="#" alt="Soru Resmi" class="img-fluid mb-3" style="display: none;"/>
                <div id="preview-correct-answer-display-area" class="mt-3" style="display: none;">
                    <strong>Doğru Cevap:</strong> <span id="preview-correct-answer-display-text"></span>
                </div>
            </div>
        </div>
        <div id="no-preview-questions-message" class="text-center my-4" style="display:none;">
            <p class="lead">Bu soru bankasında önizlenecek soru bulunmuyor.</p>
        </div>
        <div class="quiz-control-buttons text-center mt-3" id="preview-navigation-buttons" style="display:none;">
            <button id="preview-previous-question-btn" class="btn btn-warning-modern btn-modern mr-2"><i class="fas fa-arrow-left mr-1"></i>Önceki</button>
            <button id="preview-show-answer-btn" class="btn btn-success-modern btn-modern mr-2"><i class="fas fa-check-circle mr-1"></i>Cevabı Göster</button>
            <button id="preview-next-question-btn" class="btn btn-primary-modern btn-modern mr-2"><i class="fas fa-arrow-right mr-1"></i>Sonraki</button>
            <button id="preview-next-yedek-question-btn" class="btn btn-info-modern btn-modern" style="display: none;"><i class="fas fa-arrow-right mr-1"></i>Sonraki Yedek Soru</button>
        </div>
        <div class="text-center mt-4">
            <button id="preview-exit-btn" class="btn btn-danger-modern btn-modern"><i class="fas fa-times-circle mr-1"></i>Çıkış</button>
        </div>
    </div>

    <div id="quiz-area" class="container-main animate__animated" style="display: none;">
        <h1 id="quiz-title-display" class="quiz-title-display text-center"></h1>
        <div id="teacher-controls-wrapper">
            <div id="teacher-top-controls" class="mb-3" style="display: none;">
                 <div id="teacher-timer-controls" class="mb-3">
                    <div class="quiz-timer-layout">
                        <div id="global-question-info-display" class="timer-info-box text-left"></div>
                        <div id="timer-display-wrapper"> <div id="timer-display">00</div> </div>
                        <div id="section-question-info-display" class="timer-info-box text-right"></div>
                    </div>
                    <div class="quiz-timer-area">
                        <div id="time-ended-message" class="text-gradient">SÜRE BİTTİ!</div>
                        <button id="start-timer-manually-btn" class="btn btn-success-modern btn-modern mt-2">
                            <i class="fas fa-hourglass-start mr-1"></i>Süreyi Başlat
                        </button>
                        <button id="pause-resume-quiz-timer-btn" class="btn btn-warning-modern btn-modern pause-resume-quiz-timer-btn mt-2" style="display:none;">
                            <i class="fas fa-pause mr-1"></i>Duraklat
                        </button>
                        <button id="restart-quiz-timer-btn" class="btn btn-info-modern btn-modern mt-2" style="display:none;">
                            <i class="fas fa-redo mr-1"></i>Yeniden Başlat
                        </button>
                    </div>
                </div>
                <div class="text-center mt-2" id="teacher-main-action-buttons">
                     <button id="teacher-show-question-btn" class="btn btn-primary-modern btn-modern btn-lg">
                        <i class="fas fa-eye mr-1"></i> Soruyu Göster
                    </button>
                </div>
            </div>
        </div>
        <div id="question-container" class="card-modern mb-4" style="display: none;">
            <div class="card-body">
                <div id="quiz-question-text-container">
                    <span id="quiz-question-number"></span>
                    <p id="quiz-question-text"></p>
                </div>
                <img id="quiz-question-image" src="#" alt="Soru Resmi" class="img-fluid mb-3" style="display: none; border-radius: 10px;"/>
                <div id="teacher-question-actions" class="mt-3" style="display: none;">
                    <button id="teacher-show-correct-answer-btn" class="btn btn-success-modern btn-modern btn-block mb-2">
                        <i class="fas fa-check-circle mr-1"></i> Cevabı Göster
                    </button>
                    <button id="show-answer-btn" class="btn btn-info-modern btn-modern btn-block">
                        <i class="fas fa-edit mr-1"></i>Cevapları Al & Değerlendir
                    </button>
                </div>
                <div id="correct-answer-display-area" class="mt-3">
                    <strong>Doğru Cevap:</strong> <span id="correct-answer-display-text"></span>
                </div>
            </div>
        </div>

        <div id="question-navigation-buttons-container" class="text-center mt-4 mb-3 d-flex flex-wrap justify-content-center" style="display: none;">
            <!-- Soru navigasyon butonları buraya JS ile eklenecek -->
        </div>

        <div id="answer-input-section-dynamic" class="mt-4" style="display: none;"></div>

        <div id="teacher-csv-operations" class="text-center mt-3" style="display:none;">
            <button id="export-scores-csv-teacher-btn" class="btn btn-success-modern btn-modern mr-2">
                <i class="fas fa-file-csv mr-1"></i> Puanları CSV İndir
            </button>
            <input type="file" id="import-scores-csv-file-teacher" accept=".csv" style="display: none;">
            <button id="import-scores-csv-trigger-btn" class="btn btn-warning-modern btn-modern">
                <i class="fas fa-file-upload mr-1"></i> Puanları CSV'den Yükle
            </button>
            <div id="teacher-csv-message" class="mt-2 small"></div>
        </div>

        <div id="evaluation-controls" class="text-center" style="display:none;">
            <button id="evaluate-save-btn" class="btn btn-primary-modern btn-modern">
                <i class="fas fa-save mr-1"></i>Değerlendirmeyi Kaydet
            </button>
        </div>
         <p id="all-answers-recorded-message-dynamic" class="mt-3 text-success font-weight-bold text-center" style="display:none;">
            <i class="fas fa-check-circle mr-1"></i>Tüm yarışmacılar için değerlendirme yapıldı.
        </p>
        <div id="quiz-controls-after-answers" class="quiz-control-buttons text-center mt-3" style="display: none;">
            <button id="previous-question-btn" class="btn btn-warning-modern btn-modern btn-lg" style="display: none;">
                <i class="fas fa-arrow-left mr-1"></i>Önceki Soru
            </button>
            <button id="next-question-proceed-btn" class="btn btn-primary-modern btn-modern btn-lg">
                <i class="fas fa-arrow-right mr-1"></i>Sonraki Soru
            </button>
        </div>


        <div id="live-scoreboard-section" class="mt-5 card-modern" style="display:none;">
            <div class="card-header"><i class="fas fa-award mr-2"></i>Puan Tablosu</div>
            <div class="card-body p-0 table-responsive">
                <table class="table table-striped table-hover player-score-table mb-0">
                    <thead id="player-scores-thead"></thead>
                    <tbody id="player-scores-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="results-area" class="container-main text-center animate__animated" style="display: none;">
        <h1 id="final-quiz-title-display" class="section-title"></h1>
        <div class="card-modern p-4">
            <h2 id="winner-text-display" class="text-gradient"><i class="fas fa-trophy mr-2"></i>Kazanan(lar): <span id="winner-names" class="font-weight-bold"></span>!</h2>
        </div>
        <h3 class="section-title mt-5">Final Puan Durumu</h3>
        <div class="card-modern">
            <div class="card-body p-0 table-responsive">
                <table id="final-player-scores-table" class="table table-striped table-hover player-score-table mb-0">
                    <thead id="final-player-scores-thead"></thead>
                    <tbody id="final-player-scores-tbody"></tbody>
                </table>
            </div>
        </div>
        <button id="export-answers-csv-results-btn" class="btn btn-success-modern btn-modern btn-lg mt-3">
            <i class="fas fa-file-csv mr-1"></i> Bu Yarışmanın Cevaplarını CSV İndir
        </button>
        <button id="back-to-home-from-results-btn" class="btn btn-primary-modern btn-modern btn-lg mt-4">
            <i class="fas fa-home mr-1"></i>Ana Sayfaya Dön
        </button>
    </div>

    <div class="modal fade" id="password-prompt-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="passwordPromptModalLabel">Şifre Gerekli</h5>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <p id="password-prompt-message">Lütfen şifreyi girin.</p>
                    <input type="password" class="form-control form-control-modern" id="modal-password-input" placeholder="Şifre">
                    <div id="modal-password-error" class="text-danger mt-2" style="display:none;">Yanlış şifre!</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary-modern btn-modern" data-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary-modern btn-modern" id="modal-password-submit-btn">Onayla</button>
                </div>
            </div>
        </div>
    </div>

    <audio id="countdown-sound" src="sounds/ticktock.mp3" preload="auto"></audio>
    <audio id="correct-answer-sound" src="sounds/correct.mp3" preload="auto"></audio>
    <audio id="incorrect-answer-sound" src="sounds/incorrect.mp3" preload="auto"></audio>
    <audio id="time-up-sound" src="sounds/timeup.mp3" preload="auto" loop></audio>
    <audio id="quiz-end-applause-sound" src="sounds/applause.mp3" preload="auto"></audio>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const mainAppTitle = document.getElementById('main-app-title');
        const homePageContainer = document.getElementById('home-page-container');
        const gradeSelectionPage = document.getElementById('grade-selection-page');
        const gradeSelectionTitle = document.getElementById('grade-selection-title');
        const gradeButtonsContainer = document.getElementById('grade-buttons-container');
        const backToHomeFromGradeSelectionBtn = document.getElementById('back-to-home-from-grade-selection-btn');
        const adminSection = document.getElementById('admin-section');
        const quizArea = document.getElementById('quiz-area');
        const resultsArea = document.getElementById('results-area');
        const showScoresHeaderBtn = document.getElementById('show-scores-header-btn');
        const adminPanelBtn = document.getElementById('admin-panel-btn');
        const homeActionBtn = document.getElementById('home-action-btn');
        const resetAllDataBtn = document.getElementById('reset-all-data-btn');
        const studentLoginTypeBtn = document.getElementById('student-login-type-btn');
        const teacherLoginTypeBtn = document.getElementById('teacher-login-type-btn');
        const studentYedekLoginTypeBtn = document.getElementById('student-yedek-login-type-btn');
        const homeBackgroundImageDisplay = document.getElementById('home-background-image-display');
        const adminLoginFormContainer = document.getElementById('admin-login-form-container');
        const adminLoginForm = document.getElementById('admin-login-form');
        const adminUsernameInput = document.getElementById('admin-username');
        const adminPasswordInput = document.getElementById('admin-password');
        const adminLoginError = document.getElementById('admin-login-error');
        const adminManagementPanel = document.getElementById('admin-management-panel');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        const adminGradeLevelSelect = document.getElementById('admin-grade-level-select');
        const currentAdminGradeDisplayPlayers = document.getElementById('current-admin-grade-display-players');
        const currentAdminGradeDisplayTeacherPass = document.getElementById('current-admin-grade-display-teacherpass');
        const currentAdminGradeDisplayQuestions = document.getElementById('current-admin-grade-display-questions');
        const currentAdminGradeDisplayDataOp = document.getElementById('current-admin-grade-display-dataop');
        const adminPanelPlayersCard = document.getElementById('admin-panel-players-card');
        const continueQuizBtnContainer = document.getElementById('continue-quiz-btn-container');
        const continueQuizBtn = document.getElementById('continue-quiz-btn');
        const addPlayerForm = document.getElementById('add-player-form');
        const playerNameInput = document.getElementById('player-name-input');
        const playerListEl = document.getElementById('player-list');
        const adminPanelQuestions = document.getElementById('admin-panel-questions');
        const questionFormTitle = document.getElementById('question-form-title');
        const addQuestionForm = document.getElementById('add-question-form');
        const editingQuestionIdInput = document.getElementById('editing-question-id');
        const questionSectionEl = document.getElementById('question-section');
        const questionTextEl = document.getElementById('question-text');
        const questionImageEl = document.getElementById('question-image');
        const imagePreviewEl = document.getElementById('image-preview');
        const correctAnswerTextInputEl = document.getElementById('correct-answer-text-input');
        const nextQuestionPasswordInputEl = document.getElementById('next-question-password-input');
        const submitQuestionBtn = document.getElementById('submit-question-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const questionCountEl = document.getElementById('question-count');
        const existingQuestionsList = document.getElementById('existing-questions');
        const changeAdminPasswordForm = document.getElementById('change-admin-password-form');
        const currentAdminPasswordInput = document.getElementById('current-admin-password');
        const newAdminPasswordInput = document.getElementById('new-admin-password');
        const confirmNewAdminPasswordInput = document.getElementById('confirm-new-admin-password');
        const changePasswordMessage = document.getElementById('change-password-message');
        const teacherPasswordCard = document.getElementById('teacher-password-card');
        const homeBackgroundImageInput = document.getElementById('home-background-image-input');
        const homeBackgroundImagePreview = document.getElementById('home-background-image-preview');
        const saveHomeBackgroundBtn = document.getElementById('save-home-background-btn');
        const deleteHomeBackgroundBtn = document.getElementById('delete-home-background-btn');
        const homeBackgroundMessage = document.getElementById('home-background-message');
        const exportQuestionsJsonBtn = document.getElementById('export-questions-json-btn');
        const importQuestionsJsonFile = document.getElementById('import-questions-json-file');
        const questionIoMessage = document.getElementById('question-io-message');
        const selectAllQuestionsCheckbox = document.getElementById('select-all-questions-checkbox');
        const deleteSelectedQuestionsBtn = document.getElementById('delete-selected-questions-btn');
        const changeTeacherLoginPasswordForm = document.getElementById('change-teacher-login-password-form');
        const teacherLoginPasswordInput = document.getElementById('teacher-login-password-input');
        const teacherLoginPasswordMessage = document.getElementById('teacher-login-password-message');
        const quizTitleDisplay = document.getElementById('quiz-title-display');
        const teacherControlsWrapper = document.getElementById('teacher-controls-wrapper');
        const teacherTopControls = document.getElementById('teacher-top-controls');
        const teacherTimerControls = document.getElementById('teacher-timer-controls');
        const globalQuestionInfoDisplay = document.getElementById('global-question-info-display');
        const sectionQuestionInfoDisplay = document.getElementById('section-question-info-display');
        const timerDisplay = document.getElementById('timer-display');
        const timeEndedMessage = document.getElementById('time-ended-message');
        const startTimerManuallyBtn = document.getElementById('start-timer-manually-btn');
        const pauseResumeQuizTimerBtn = document.getElementById('pause-resume-quiz-timer-btn');
        const restartQuizTimerBtn = document.getElementById('restart-quiz-timer-btn');
        const teacherMainActionButtons = document.getElementById('teacher-main-action-buttons');
        const teacherShowQuestionBtn = document.getElementById('teacher-show-question-btn');
        const questionContainer = document.getElementById('question-container');
        const quizQuestionNumberEl = document.getElementById('quiz-question-number');
        const quizQuestionTextEl = document.getElementById('quiz-question-text');
        const quizQuestionImageEl = document.getElementById('quiz-question-image');
        const teacherQuestionActions = document.getElementById('teacher-question-actions');
        const teacherShowCorrectAnswerBtn = document.getElementById('teacher-show-correct-answer-btn');
        const showAnswerBtn = document.getElementById('show-answer-btn');
        const correctAnswerDisplayArea = document.getElementById('correct-answer-display-area');
        const correctAnswerDisplayText = document.getElementById('correct-answer-display-text');
        const answerInputSectionContainer = document.getElementById('answer-input-section-dynamic');
        const evaluationControls = document.getElementById('evaluation-controls');
        const evaluateSaveBtn = document.getElementById('evaluate-save-btn');
        const allAnswersRecordedMessageDynamic = document.getElementById('all-answers-recorded-message-dynamic');
        const quizControlsAfterAnswers = document.getElementById('quiz-controls-after-answers');
        const previousQuestionBtn = document.getElementById('previous-question-btn');
        const nextQuestionProceedBtn = document.getElementById('next-question-proceed-btn');
        const liveScoreboardSection = document.getElementById('live-scoreboard-section');
        const playerScoresThead = document.getElementById('player-scores-thead');
        const playerScoresTbody = document.getElementById('player-scores-tbody');
        const finalQuizTitleDisplay = document.getElementById('final-quiz-title-display');
        const winnerNamesEl = document.getElementById('winner-names');
        const winnerTextDisplay = document.getElementById('winner-text-display');
        const finalPlayerScoresThead = document.getElementById('final-player-scores-thead');
        const finalPlayerScoresTbody = document.getElementById('final-player-scores-tbody');
        const backToHomeFromResultsBtn = document.getElementById('back-to-home-from-results-btn');
        const passwordPromptModal = $('#password-prompt-modal');
        const modalPasswordInput = document.getElementById('modal-password-input');
        const modalPasswordError = document.getElementById('modal-password-error');
        const modalPasswordSubmitBtn = document.getElementById('modal-password-submit-btn');
        const passwordPromptMessage = document.getElementById('password-prompt-message');
        const themeSelect = document.getElementById('theme-select');
        const increaseFontSizeBtn = document.getElementById('increase-font-size');
        const decreaseFontSizeBtn = document.getElementById('decrease-font-size');
        const currentFontSizeDisplay = document.getElementById('current-font-size-display');
        const toggleSoundEffectsCheckbox = document.getElementById('toggle-sound-effects');
        const countdownSound = document.getElementById('countdown-sound');
        const correctAnswerSound = document.getElementById('correct-answer-sound');
        const incorrectAnswerSound = document.getElementById('incorrect-answer-sound');
        const timeUpSound = document.getElementById('time-up-sound');
        const quizEndApplauseSound = document.getElementById('quiz-end-applause-sound');
        const previewQuizBtn = document.getElementById('preview-quiz-btn');
        const quizPreviewArea = document.getElementById('quiz-preview-area');
        const previewTitleDisplay = document.getElementById('preview-title-display');
        const previewQuestionContainer = document.getElementById('preview-question-container');
        const previewQuestionNumberEl = document.getElementById('preview-question-number');
        const previewQuestionTextEl = document.getElementById('preview-question-text');
        const previewQuestionImageEl = document.getElementById('preview-question-image');
        const previewCorrectAnswerDisplayArea = document.getElementById('preview-correct-answer-display-area');
        const previewCorrectAnswerDisplayText = document.getElementById('preview-correct-answer-display-text');
        const previewPreviousQuestionBtn = document.getElementById('preview-previous-question-btn');
        const previewShowAnswerBtn = document.getElementById('preview-show-answer-btn');
        const previewNextQuestionBtn = document.getElementById('preview-next-question-btn');
        const previewNextYedekQuestionBtn = document.getElementById('preview-next-yedek-question-btn');
        const previewExitBtn = document.getElementById('preview-exit-btn');
        const noPreviewQuestionsMessage = document.getElementById('no-preview-questions-message');
        const previewNavigationButtons = document.getElementById('preview-navigation-buttons');
        const questionNavigationButtonsContainer = document.getElementById('question-navigation-buttons-container');
        const csvExportButtonAdmin = document.getElementById('export-answers-csv-admin-btn');
        const csvExportButtonResults = document.getElementById('export-answers-csv-results-btn');
        const importAnswersCsvFile = document.getElementById('import-answers-csv-file');
        const uploadAnswersCsvBtn = document.getElementById('upload-answers-csv-btn');

        // YENİ ÖĞRETMEN CSV İŞLEMLERİ İÇİN ELEMENTLER
        const teacherCsvOperationsDiv = document.getElementById('teacher-csv-operations');
        const exportScoresCsvTeacherBtn = document.getElementById('export-scores-csv-teacher-btn');
        const importScoresCsvFileTeacher = document.getElementById('import-scores-csv-file-teacher');
        const importScoresCsvTriggerBtn = document.getElementById('import-scores-csv-trigger-btn');
        const teacherCsvMessage = document.getElementById('teacher-csv-message');


        let passwordModalCallback = null;
        const BASE_GRADE_LEVELS_NUMERIC = [5, 6, 7, 8];
        const GRADE_LEVELS = [
            ...BASE_GRADE_LEVELS_NUMERIC,
            ...BASE_GRADE_LEVELS_NUMERIC.map(g => `${g}_YEDEK`)
        ];
        const DEFAULT_BRANCHES = ["A Şubesi", "B Şubesi", "C Şubesi", "D Şubesi", "E Şubesi"];
        const CORRECT_ANSWER_POINTS = 10;
        const QUIZ_DATA_BASE_KEY = 'ciySchoolQuiz_V20_';
        const ADMIN_USERNAME_KEY = `${QUIZ_DATA_BASE_KEY}adminUser`;
        const ADMIN_PASSWORD_KEY = `${QUIZ_DATA_BASE_KEY}adminPass`;
        const HOME_BACKGROUND_IMAGE_KEY = `${QUIZ_DATA_BASE_KEY}homeBgImage`;
        const DEFAULT_TEACHER_LOGIN_PASSWORD = "2345";
        const DEFAULT_ADMIN_USERNAME = "admin";
        const DEFAULT_ADMIN_PASSWORD = "2345";
        const FONT_SIZE_KEY = `${QUIZ_DATA_BASE_KEY}fontSize`;
        const THEME_KEY = `${QUIZ_DATA_BASE_KEY}theme`;
        const SOUND_EFFECTS_KEY = `${QUIZ_DATA_BASE_KEY}soundEffects`;
        const MAX_YEDEK_QUESTIONS_TO_SHOW = 5;
        const YEDEK_START_INDEX = 20;

        let currentGradeLevel = null;
        let quizTitle = "";
        let players = [];
        let questions = [];
        let currentQuestionIndex = 0;
        let questionTimerInterval;
        let timeLeft = 0;
        let isScoreboardVisible = false;
        let timerStartedThisQuestion = false;
        let timerPausedThisQuestion = false;
        let editingQuestionId = null;
        let isAdminLoggedIn = false;
        let isQuizInProgress = false;
        let currentUserRole = null;
        let tempLoginType = null;
        let startFromQuestion21Mode = false;
        let currentPreviewQuestionIndex = 0;
        let previewQuestions = [];
        let soundEffectsEnabled = true;
        let yedekQuestionsShownCount = 0;
        let unlockedUpToQuestionIndex = 0;

        const embedded5thGradeMainQuestions = [
          {
            "id": 1748366153642, "section": "5. Sınıf - Konu Türkçe", "text": "Hangi kelime fiil köküdür? EK-OYUN-EKMEKLER-TELEVİZYON",
            "correctAnswerTexts": ["EK"], "timeLimit": 60, "nextQuestionPassword": "s3", "image": null
          },
          {
            "id": 1748366153762, "section": "5. Sınıf - Konu Türkçe", "text": "Hangi kelimenin eş seslisi yoktur? YÜZ-GÖL-KIR",
            "correctAnswerTexts": ["GÖL"], "timeLimit": 60, "nextQuestionPassword": "s5", "image": null
          },
          {
            "id": 1748366153822, "section": "5. Sınıf - Konu Türkçe", "text": "‘’Her sabah aynı şeyleri görmekten iştahım kapandı.’’ Cümlesine hakim olan duygu nedir?",
            "correctAnswerTexts": ["bıkkınlık"], "timeLimit": 60, "nextQuestionPassword": "s8", "image": null
          },
          {
            "id": 1748366153901, "section": "5. Sınıf - Konu Matematik", "text": "80 – (7 x 6) : 2 işleminin sonucu kaçtır?",
            "correctAnswerTexts": ["59"], "timeLimit": 120, "nextQuestionPassword": "s12", "image": null
          },
          {
            "id": 1748366154007, "section": "5. Sınıf - Konu Matematik", "text": "Buket’in hangi derste soruları doğru cevaplama oranı en fazladır? Türkçede 17/20, Fen bilimlerinde %76, İngilizcede 0,8",
            "correctAnswerTexts": ["Türkçe"], "timeLimit": 120, "nextQuestionPassword": "s15", "image": null
          },
          {
            "id": 1748366154172, "section": "5. Sınıf - Konu Matematik", "text": "2023 yılında toplam kaç kişi kan bağışı yapmıştır? Kastamonu’dan 19673 kişi, Balıkesir’den 67385 kişi.",
            "correctAnswerTexts": ["87058"], "timeLimit": 120, "nextQuestionPassword": "s20", "image": null
          },
          {
            "id": 1748366154218, "section": "5. Sınıf - Konu Fen Bilimleri", "text": "Dünya’nın Güneş ve Ay arasında olduğu evre nedir? Ay’ın Dünya’ya bakan yüzeyi tamamen aydınlıktır.",
            "correctAnswerTexts": ["Dolunay"], "timeLimit": 60, "nextQuestionPassword": "s2", "image": null
          },
          {
            "id": 1748366154310, "section": "5. Sınıf - Konu Fen Bilimleri", "text": "Dünyadaki ağırlığı 30N olan cismin Ay’daki kütlesi kaçtır?",
            "correctAnswerTexts": ["3 kg", "3kg"], "timeLimit": 60, "nextQuestionPassword": "s4", "image": null
          },
          {
            "id": 1748366154462, "section": "5. Sınıf - Konu Fen Bilimleri", "text": "Hayvan hücrelerinde hücre içi sindirimde görevli organel nedir?",
            "correctAnswerTexts": ["Lizozom"], "timeLimit": 60, "nextQuestionPassword": "s6", "image": null
          },
          {
            "id": 1748366154575, "section": "5. Sınıf - Konu Sosyal Bilgiler", "text": "Çivi yazısını bulup tarihi çağları başlatan uygarlık kimdir?",
            "correctAnswerTexts": ["Sümerliler", "Sümerler"], "timeLimit": 60, "nextQuestionPassword": "s7", "image": null
          },
          {
            "id": 1748366154680, "section": "5. Sınıf - Konu Sosyal Bilgiler", "text": "Haritalardaki küçültme oranına ne denir?",
            "correctAnswerTexts": ["Ölçek"], "timeLimit": 60, "nextQuestionPassword": "s9", "image": null
          },
          {
            "id": 1748366154790, "section": "5. Sınıf - Konu Sosyal Bilgiler", "text": "Bir bölgenin veya ülkenin yeryüzü şekillerini gösteren harita çeşidi hangisidir?",
            "correctAnswerTexts": ["Fiziki harita", "fiziki"], "timeLimit": 60, "nextQuestionPassword": "s11", "image": null
          },
          {
            "id": 1748366154900, "section": "5. Sınıf - Konu İngilizce", "text": "What is the name of our school?",
            "correctAnswerTexts": ["Çavuşoğlu İsmail Yeşilyurt İmam Hatip Middle School.", "Çavuşoğlu İsmail Yeşilyurt İHO"], "timeLimit": 60, "nextQuestionPassword": "s13", "image": null
          },
          {
            "id": 1748366155010, "section": "5. Sınıf - Konu İngilizce", "text": "What colour is the sea?",
            "correctAnswerTexts": ["Blue", "Mavi"], "timeLimit": 60, "nextQuestionPassword": "s14", "image": null
          },
          {
            "id": 1748366155120, "section": "5. Sınıf - Konu İngilizce", "text": "How many days are there in a week?",
            "correctAnswerTexts": ["Seven (7)", "Seven", "7"], "timeLimit": 60, "nextQuestionPassword": "s16", "image": null
          },
          {
            "id": 1748366155230, "section": "5. Sınıf - Konu Din Kültürü", "text": "‘’Allah’a inanmakla birlikte başka varlıkları da Tanrı kabul etmek, Allah’a ortak koşmak’’ hangi kavramla ifade edilir?",
            "correctAnswerTexts": ["Şirk"], "timeLimit": 60, "nextQuestionPassword": "s17", "image": null
          },
          {
            "id": 1748366155340, "section": "5. Sınıf - Konu Din Kültürü", "text": "Kur’an-ı Kerim’de övülen beş büyük peygambere verilen isim nedir?",
            "correctAnswerTexts": ["Ülül azm peygamberler", "ulul azm", "ülülazm"], "timeLimit": 60, "nextQuestionPassword": "s18", "image": null
          },
          {
            "id": 1748366155450, "section": "5. Sınıf - Konu Müzik", "text": "Sol anahtarı hangi notadan (sesten) başlayarak çizilir?",
            "correctAnswerTexts": ["Sol notasından başlar.", "sol", "sol notası"], "timeLimit": 60, "nextQuestionPassword": "s19", "image": null
          },
          {
            "id": 1748366155560, "section": "5. Sınıf - Konu Görsel Sanatlar", "text": "Mor hangi renklerin karışımından oluşur?",
            "correctAnswerTexts": ["Kırmızı – Mavi", "kırmızı mavi", "mavi kırmızı"], "timeLimit": 60, "nextQuestionPassword": "s1", "image": null
          },
          {
            "id": 1748366155670, "section": "5. Sınıf - Konu Bilişim Teknolojileri", "text": "Bilgisayarın beyni olarak adlandırılan ve tüm işlemleri yapan parçasına ne ad verilir?",
            "correctAnswerTexts": ["İşlemci (CPU)", "İşlemci", "CPU"], "timeLimit": 60, "nextQuestionPassword": "s2", "image": null
          },
          {
            "id": 1748366153647, "section": "5. Sınıf - Konu Türkçe (Yedek)", "text": "Tezhip - Ebru - Çini – Heykel. Yukarıdakilerden hangisi farklıdır?",
            "correctAnswerTexts": ["Heykel"], "timeLimit": 60, "nextQuestionPassword": "yedek1", "image": null
          },
          {
            "id": 1748366153767, "section": "5. Sınıf - Konu Matematik (Yedek)", "text": "Ölçüsü 30° olan açının bütünler açısı kaçtır?",
            "correctAnswerTexts": ["150"], "timeLimit": 60, "nextQuestionPassword": "yedek2", "image": null
          },
          {
            "id": 1748366153827, "section": "5. Sınıf - Konu Fen Bilimleri (Yedek)", "text": "20. yüzyıl insan yaşamını icatlarıyla büyük bir şekilde etkileyen mucit ve iş insanıdır. Elektrik enerjisi üretimi, kitle iletişimi, ses kaydı, sinema gibi birçok alanda cihazlar geliştirmiştir. 1879'da bir elektrik ampulü icat eden bilim insanı kimdir?",
            "correctAnswerTexts": ["Thomas Alva Edison", "Edison"], "timeLimit": 60, "nextQuestionPassword": "yedek3", "image": null
          },
          {
            "id": 1748366153907, "section": "5. Sınıf - Konu Sosyal Bilgiler (Yedek)", "text": "Mahalle ve köyleri yöneten halk tarafından seçilen yönetici kimdir?",
            "correctAnswerTexts": ["Muhtar"], "timeLimit": 60, "nextQuestionPassword": "yedek4", "image": null
          },
          {
            "id": 1748366154009, "section": "5. Sınıf - Konu İngilizce (Yedek)", "text": "What is the English name of ‘Yunanistan’?",
            "correctAnswerTexts": ["Greece"], "timeLimit": 60, "nextQuestionPassword": null, "image": null
          }
        ];
        const embedded5thGradeYedekQuestions = [
          {
            "id": 1748366159001, "section": "5. Sınıf Yedek Bankası - Konu 1", "text": "Yedek Bankası Soru 1: 'Alfabe' kelimesi kaç harften oluşur?",
            "correctAnswerTexts": ["6"], "timeLimit": 30, "nextQuestionPassword": "yb2", "image": null
          },
          {
            "id": 1748366159002, "section": "5. Sınıf Yedek Bankası - Konu 2", "text": "Yedek Bankası Soru 2: Türkiye'nin başkenti neresidir?",
            "correctAnswerTexts": ["Ankara"], "timeLimit": 30, "nextQuestionPassword": "yb3", "image": null
          },
          {
            "id": 1748366159003, "section": "5. Sınıf Yedek Bankası - Konu 3", "text": "Yedek Bankası Soru 3: Bir yılda kaç mevsim vardır?",
            "correctAnswerTexts": ["4", "dört"], "timeLimit": 30, "nextQuestionPassword": "yb4", "image": null
          },
          {
            "id": 1748366159004, "section": "5. Sınıf Yedek Bankası - Konu 4", "text": "Yedek Bankası Soru 4: En büyük gezegen hangisidir?",
            "correctAnswerTexts": ["Jüpiter"], "timeLimit": 30, "nextQuestionPassword": "yb5", "image": null
          },
          {
            "id": 1748366159005, "section": "5. Sınıf Yedek Bankası - Konu 5", "text": "Yedek Bankası Soru 5: 'Kırmızı' rengin İngilizcesi nedir?",
            "correctAnswerTexts": ["Red"], "timeLimit": 30, "nextQuestionPassword": null, "image": null
          }
        ];

        function generateCSVContent(gradeLevelToExport, playersToExport, questionsToExport) {
            if (!playersToExport || !questionsToExport || questionsToExport.length === 0) {
                 const isYedekBank = typeof gradeLevelToExport === 'string' && gradeLevelToExport.includes('_YEDEK');
                 // For yedek banks, if there are no players, we can still export if questions exist (e.g. for template)
                 // but if there are no questions, there's nothing to export.
                 if (isYedekBank && (!playersToExport || playersToExport.length === 0) && questionsToExport && questionsToExport.length > 0) {
                     // Allow proceeding for yedek banks without players if there are questions (e.g. to create a template)
                 } else if (!questionsToExport || questionsToExport.length === 0) {
                     console.warn("generateCSVContent: No questions to export.");
                     return null;
                 } else if (!playersToExport || playersToExport.length === 0) {
                     console.warn("generateCSVContent: No players to export answers for (for non-yedek banks).");
                     return null;
                 }
            }

            let csvRows = [];
            const headers = [
                "Sınıf Seviyesi", "Yarışmacı Adı", "Soru No", "Soru Metni (Kısaltılmış)",
                "Verilen Cevap", "Doğru Cevap(lar)", "Değerlendirme", "Alınan Puan", "Soru Bölümü"
            ];
            csvRows.push(headers.map(h => `"${h.replace(/"/g, '""')}"`).join(','));

            const gradeDisplayName = (typeof gradeLevelToExport === 'string' && gradeLevelToExport.includes('_YEDEK'))
                ? `${String(gradeLevelToExport).split('_')[0]}. Sınıf Yedek Bankası`
                : `${gradeLevelToExport}. Sınıf`;

            if (playersToExport && playersToExport.length > 0) {
                playersToExport.forEach(player => {
                    if (player.answers && player.answers.length > 0) {
                        player.answers.forEach(answer => {
                            const question = questionsToExport.find(q => q.id === answer.questionId);
                            if (question) {
                                const row = [
                                    `"${gradeDisplayName.replace(/"/g, '""')}"`,
                                    `"${player.name.replace(/"/g, '""')}"`,
                                    questionsToExport.indexOf(question) + 1,
                                    `"${question.text.substring(0, 70).replace(/"/g, '""').replace(/\n/g, ' ') + (question.text.length > 70 ? '...' : '')}"`,
                                    `"${(answer.answerText || '').replace(/"/g, '""').replace(/\n/g, ' ')}"`,
                                    `"${question.correctAnswerTexts.join(' / ').replace(/"/g, '""')}"`,
                                    answer.state === 'correct' ? "Doğru" : (answer.state === 'incorrect' ? "Yanlış" : "Beklemede/Değerlendirilmedi"),
                                    answer.points || 0,
                                    `"${(question.section || 'Genel').replace(/"/g, '""')}"`
                                ];
                                csvRows.push(row.join(','));
                            }
                        });
                    }
                });
            } else if (typeof gradeLevelToExport === 'string' && gradeLevelToExport.includes('_YEDEK') && questionsToExport.length > 0) {
                // For yedek banks with no players, we might just list questions as a template
                questionsToExport.forEach((question, index) => {
                     const row = [
                        `"${gradeDisplayName.replace(/"/g, '""')}"`,
                        "", // No player name
                        index + 1,
                        `"${question.text.substring(0, 70).replace(/"/g, '""').replace(/\n/g, ' ') + (question.text.length > 70 ? '...' : '')}"`,
                        "", // No given answer
                        `"${question.correctAnswerTexts.join(' / ').replace(/"/g, '""')}"`,
                        "Beklemede/Değerlendirilmedi",
                        0,
                        `"${(question.section || 'Genel').replace(/"/g, '""')}"`
                    ];
                    csvRows.push(row.join(','));
                });
            }


            return csvRows.length > 1 ? csvRows.join('\n') : null; // ensure there's more than just headers
        }

        function downloadCSV(csvContent, filename) {
            if (!csvContent) {
                alert("İndirilecek CSV verisi bulunamadı.");
                return;
            }
            const BOM = "\uFEFF";
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } else {
                alert("Tarayıcınız otomatik CSV indirmeyi desteklemiyor.");
            }
        }


        function parseCSVLine(line) {
            const result = [];
            let currentField = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    if (inQuotes && i + 1 < line.length && line[i+1] === '"') {
                        currentField += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(currentField.trim());
                    currentField = '';
                } else {
                    currentField += char;
                }
            }
            result.push(currentField.trim());
            return result;
        }

        async function handleCsvAnswersUpload() { // Admin panel CSV upload
            if (!isAdminLoggedIn || !currentGradeLevel) {
                alert("Lütfen önce bir sınıf düzeyi seçin ve admin girişi yapın.");
                return;
            }
            if (!importAnswersCsvFile.files || importAnswersCsvFile.files.length === 0) {
                if(questionIoMessage) {
                    questionIoMessage.textContent = "Lütfen önce bir CSV dosyası seçin.";
                    questionIoMessage.className = 'mt-2 text-warning';
                }
                return;
            }

            const file = importAnswersCsvFile.files[0];
            const reader = new FileReader();

            reader.onload = async (event) => {
                const csvData = event.target.result;
                const lines = csvData.split(/\r\n|\n/);

                if (lines.length < 2) {
                     if(questionIoMessage) {
                        questionIoMessage.textContent = "CSV dosyası boş veya sadece başlık satırı içeriyor.";
                        questionIoMessage.className = 'mt-2 text-danger';
                     }
                    return;
                }

                const headerLine = lines[0];
                const headersFromCsv = parseCSVLine(headerLine.toLowerCase());
                const headerMap = {};
                const expectedMinHeaders = ["sınıf seviyesi", "yarışmacı adı", "soru no", "değerlendirme", "alınan puan"];
                const optionalHeaders = ["verilen cevap"];

                let missingHeaders = [];
                expectedMinHeaders.forEach(eh => {
                    const index = headersFromCsv.indexOf(eh);
                    if (index === -1) missingHeaders.push(eh);
                    else headerMap[eh.replace(/\s+/g, '_')] = index;
                });

                if (missingHeaders.length > 0) {
                    if(questionIoMessage) {
                        questionIoMessage.textContent = `CSV dosyasında zorunlu başlık(lar) eksik: '${missingHeaders.join(', ')}'. Lütfen indirdiğiniz CSV formatına benzer bir dosya kullanın.`;
                        questionIoMessage.className = 'mt-2 text-danger';
                    }
                    return;
                }

                optionalHeaders.forEach(oh => {
                     const index = headersFromCsv.indexOf(oh);
                     if(index !== -1) headerMap[oh.replace(/\s+/g, '_')] = index;
                });


                const currentGradeDisplayNameAdmin = (typeof currentGradeLevel === 'string' && currentGradeLevel.includes('_YEDEK'))
                    ? `${String(currentGradeLevel).split('_')[0]}. Sınıf Yedek Bankası`
                    : `${currentGradeLevel}. Sınıf`;

                let updatedPlayersCount = 0;
                let newPlayersAddedCount = 0;
                let updatedAnswersCount = 0;
                let errors = [];

                let tempPlayers = JSON.parse(JSON.stringify(players));
                const currentQuestionsList = JSON.parse(JSON.stringify(questions));

                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i];
                    if (line.trim() === '') continue;

                    const values = parseCSVLine(line);
                     if (values.length < Math.max(...Object.values(headerMap)) + 1) {
                        errors.push(`Satır ${i+1}: Yetersiz sütun sayısı (beklenen en az ${Math.max(...Object.values(headerMap)) + 1}, bulunan ${values.length}).`);
                        continue;
                    }

                    const csvGradeLevelFromFile = values[headerMap.sınıf_seviyesi];
                    const playerNameFromFile = values[headerMap.yarışmacı_adı];
                    const questionNumStrFromFile = values[headerMap.soru_no];
                    const evaluationFromFile = values[headerMap.değerlendirme];
                    const pointsStrFromFile = values[headerMap.alınan_puan];
                    const givenAnswerFromFile = headerMap.verilen_cevap !== undefined ? values[headerMap.verilen_cevap] : '';


                    if (!playerNameFromFile || !questionNumStrFromFile || !evaluationFromFile || !pointsStrFromFile) {
                        errors.push(`Satır ${i+1}: Eksik zorunlu veri (Yarışmacı, Soru No, Değerlendirme veya Puan).`);
                        continue;
                    }

                    if (csvGradeLevelFromFile && csvGradeLevelFromFile.toLowerCase() !== currentGradeDisplayNameAdmin.toLowerCase()) {
                        const errorMsg = `CSV'deki sınıf seviyesi (${csvGradeLevelFromFile}) seçili olanla (${currentGradeDisplayNameAdmin}) eşleşmiyor. Bu satır atlandı.`;
                        if (!errors.includes(errorMsg)) errors.push(errorMsg);
                        continue;
                    }

                    const questionIndexFromFile = parseInt(questionNumStrFromFile) - 1;
                    const pointsFromFile = parseInt(pointsStrFromFile);

                    if (isNaN(questionIndexFromFile) || questionIndexFromFile < 0 || questionIndexFromFile >= currentQuestionsList.length) {
                        errors.push(`Satır ${i+1} (${playerNameFromFile}): Geçersiz soru numarası '${questionNumStrFromFile}'. Bu sınıf için ${currentQuestionsList.length} soru var.`);
                        continue;
                    }
                    if (isNaN(pointsFromFile)) {
                        errors.push(`Satır ${i+1} (${playerNameFromFile}, Soru ${questionNumStrFromFile}): Geçersiz puan '${pointsStrFromFile}'.`);
                        continue;
                    }

                    const questionIdToUpdate = currentQuestionsList[questionIndexFromFile].id;
                    let playerToUpdate = tempPlayers.find(p => p.name.toLowerCase() === playerNameFromFile.toLowerCase());
                    let isNewPlayerInLoop = false;

                    if (!playerToUpdate) {
                        if (typeof currentGradeLevel === 'string' && currentGradeLevel.includes('_YEDEK')) {
                            errors.push(`Satır ${i+1}: ${playerNameFromFile} adlı oyuncu yedek bankada bulunamadı ve yeni oyuncu eklenemez.`);
                            continue;
                        }
                        playerToUpdate = {
                            id: Date.now() + tempPlayers.length + Math.floor(Math.random()*1000) + i,
                            name: playerNameFromFile,
                            score: 0,
                            answers: []
                        };
                        currentQuestionsList.forEach(q => {
                            playerToUpdate.answers.push({ questionId: q.id, answerText: '', state: 'pending', points: 0 });
                        });
                        tempPlayers.push(playerToUpdate);
                        newPlayersAddedCount++;
                        isNewPlayerInLoop = true;
                    }

                    let answerEntryToUpdate = playerToUpdate.answers.find(ans => ans.questionId === questionIdToUpdate);
                    if (!answerEntryToUpdate) {
                        answerEntryToUpdate = { questionId: questionIdToUpdate, answerText: '', state: 'pending', points: 0 };
                        playerToUpdate.answers.push(answerEntryToUpdate);
                    }

                    answerEntryToUpdate.points = pointsFromFile;
                    if (evaluationFromFile.toLowerCase() === 'doğru') {
                        answerEntryToUpdate.state = 'correct';
                    } else if (evaluationFromFile.toLowerCase() === 'yanlış') {
                        answerEntryToUpdate.state = 'incorrect';
                    } else {
                        answerEntryToUpdate.state = 'pending';
                    }
                    if(givenAnswerFromFile) answerEntryToUpdate.answerText = givenAnswerFromFile;

                    updatedAnswersCount++;
                    if (!isNewPlayerInLoop && !tempPlayers.find(p=>p.id === playerToUpdate.id)._markedUpdated) {
                        updatedPlayersCount++;
                        tempPlayers.find(p=>p.id === playerToUpdate.id)._markedUpdated = true; // Geçici işaretleme
                    }
                }
                tempPlayers.forEach(p => delete p._markedUpdated); // Geçici işaretlemeyi temizle

                tempPlayers.forEach(p => {
                    p.score = p.answers.reduce((total, ans) => total + (ans.points || 0), 0);
                });

                players = tempPlayers;
                savePersistentPlayers();
                loadDataForCurrentGrade(true);

                let successMessage = `${updatedAnswersCount} cevap kaydı güncellendi/oluşturuldu.`;
                if (newPlayersAddedCount > 0) successMessage += ` ${newPlayersAddedCount} yeni yarışmacı eklendi.`;
                else if (updatedPlayersCount > 0) successMessage = `${updatedPlayersCount} mevcut yarışmacının kayıtları güncellendi (${updatedAnswersCount} cevap).`;

                if (updatedAnswersCount === 0 && newPlayersAddedCount === 0 && errors.length === 0) successMessage = "CSV'den işlenecek uygun veri bulunamadı veya değişiklik yapılmadı.";


                if (errors.length > 0) {
                    if(questionIoMessage) {
                        questionIoMessage.innerHTML = `<b>Yükleme Sonucu:</b><br>${successMessage}<br><b>Hatalar/Uyarılar (${errors.length}):</b><br> - ${errors.slice(0,5).join('<br> - ')}${errors.length > 5 ? '<br>...ve daha fazla.' : ''}`;
                        questionIoMessage.className = 'mt-2 alert alert-warning';
                    }
                } else {
                     if(questionIoMessage) {
                        questionIoMessage.textContent = `Yükleme Başarılı: ${successMessage}`;
                        questionIoMessage.className = 'mt-2 text-success';
                    }
                }
                importAnswersCsvFile.value = '';
            };

            reader.onerror = () => {
                if(questionIoMessage) {
                    questionIoMessage.textContent = "CSV dosyası okunurken bir hata oluştu.";
                    questionIoMessage.className = 'mt-2 text-danger';
                }
                importAnswersCsvFile.value = '';
            };

            reader.readAsText(file, 'UTF-8');
        }

        // YENİ: ÖĞRETMEN TARAFINDA PUANLARI CSV'DEN YÜKLEME FONKSİYONU
        function processTeacherScoresCSV(csvData) {
            if (!isQuizInProgress || currentUserRole !== 'teacher' || !currentGradeLevel || players.length === 0 || questions.length === 0) {
                if (teacherCsvMessage) {
                    teacherCsvMessage.textContent = "Puanları yüklemek için aktif bir öğretmen oturumu, yarışmacı ve soru olmalıdır.";
                    teacherCsvMessage.className = 'mt-2 text-danger small';
                }
                return;
            }

            const lines = csvData.split(/\r\n|\n/);
            if (lines.length < 2) {
                if (teacherCsvMessage) {
                    teacherCsvMessage.textContent = "CSV dosyası boş veya sadece başlık satırı içeriyor.";
                    teacherCsvMessage.className = 'mt-2 text-danger small';
                }
                return;
            }

            const headerLine = lines[0];
            const headersFromCsv = parseCSVLine(headerLine.toLowerCase());
            const headerMap = {};
            const expectedMinHeaders = ["sınıf seviyesi", "yarışmacı adı", "soru no", "değerlendirme", "alınan puan"];
            const optionalHeaders = ["verilen cevap"];

            let missingHeaders = [];
            expectedMinHeaders.forEach(eh => {
                const index = headersFromCsv.indexOf(eh);
                if (index === -1) missingHeaders.push(eh);
                else headerMap[eh.replace(/\s+/g, '_')] = index;
            });

            if (missingHeaders.length > 0) {
                if (teacherCsvMessage) {
                    teacherCsvMessage.textContent = `CSV'de eksik başlık(lar): ${missingHeaders.join(', ')}.`;
                    teacherCsvMessage.className = 'mt-2 text-danger small';
                }
                return;
            }
            optionalHeaders.forEach(oh => {
                const index = headersFromCsv.indexOf(oh);
                if(index !== -1) headerMap[oh.replace(/\s+/g, '_')] = index;
            });

            const currentQuizGradeDisplayName = (typeof currentGradeLevel === 'string' && currentGradeLevel.includes('_YEDEK'))
                ? `${String(currentGradeLevel).split('_')[0]}. Sınıf Yedek Bankası`
                : `${currentGradeLevel}. Sınıf`;

            let updatedPlayerAnswersCount = 0;
            let errors = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                if (line.trim() === '') continue;

                const values = parseCSVLine(line);
                if (values.length < Math.max(...Object.values(headerMap)) + 1) {
                    errors.push(`Satır ${i+1}: Yetersiz sütun.`);
                    continue;
                }

                const csvGradeFromFile = values[headerMap.sınıf_seviyesi];
                const playerNameFromFile = values[headerMap.yarışmacı_adı];
                const questionNumStrFromFile = values[headerMap.soru_no];
                const evaluationFromFile = values[headerMap.değerlendirme];
                const pointsStrFromFile = values[headerMap.alınan_puan];
                const givenAnswerFromFile = headerMap.verilen_cevap !== undefined ? values[headerMap.verilen_cevap] : '';


                if (!playerNameFromFile || !questionNumStrFromFile || !evaluationFromFile || !pointsStrFromFile) {
                    errors.push(`Satır ${i+1}: Eksik veri.`);
                    continue;
                }

                if (csvGradeFromFile && csvGradeFromFile.toLowerCase() !== currentQuizGradeDisplayName.toLowerCase()) {
                    const errorMsg = `CSV'deki sınıf (${csvGradeFromFile}) aktif yarışma sınıfı (${currentQuizGradeDisplayName}) ile eşleşmiyor. Satır atlandı.`;
                    if (!errors.includes(errorMsg)) errors.push(errorMsg);
                    continue;
                }

                const playerToUpdate = players.find(p => p.name.toLowerCase() === playerNameFromFile.toLowerCase());
                if (!playerToUpdate) {
                    errors.push(`Satır ${i+1}: Yarışmacı "${playerNameFromFile}" aktif yarışmada bulunamadı.`);
                    continue;
                }

                const questionIndexFromFile = parseInt(questionNumStrFromFile) - 1;
                if (isNaN(questionIndexFromFile) || questionIndexFromFile < 0 || questionIndexFromFile >= questions.length) {
                    errors.push(`Satır ${i+1} (${playerNameFromFile}): Geçersiz soru no '${questionNumStrFromFile}'.`);
                    continue;
                }
                const questionIdToUpdate = questions[questionIndexFromFile].id;

                const pointsFromFile = parseInt(pointsStrFromFile);
                if (isNaN(pointsFromFile)) {
                    errors.push(`Satır ${i+1} (${playerNameFromFile}, Soru ${questionNumStrFromFile}): Geçersiz puan '${pointsStrFromFile}'.`);
                    continue;
                }

                let answerEntry = playerToUpdate.answers.find(ans => ans.questionId === questionIdToUpdate);
                if (!answerEntry) {
                    answerEntry = { questionId: questionIdToUpdate, answerText: '', state: 'pending', points: 0 };
                    playerToUpdate.answers.push(answerEntry);
                }

                answerEntry.points = pointsFromFile;
                if (evaluationFromFile.toLowerCase() === 'doğru') answerEntry.state = 'correct';
                else if (evaluationFromFile.toLowerCase() === 'yanlış') answerEntry.state = 'incorrect';
                else answerEntry.state = 'pending';
                if (givenAnswerFromFile) answerEntry.answerText = givenAnswerFromFile;

                updatedPlayerAnswersCount++;

                // Update UI if this is the current question being evaluated
                if (questionIndexFromFile === currentQuestionIndex) {
                    const answerTextarea = document.querySelector(`#answer-input-section-dynamic textarea[data-player-id="${playerToUpdate.id}"]`);
                    if (answerTextarea) answerTextarea.value = answerEntry.answerText || '';

                    const decisionButtons = document.querySelectorAll(`#player-answer-row-${playerToUpdate.id} .admin-decision-buttons button`);
                    decisionButtons.forEach(btn => {
                        btn.classList.remove('active', 'btn-success-modern', 'btn-danger-modern');
                        if (btn.dataset.decision === 'correct') btn.classList.add('btn-outline-success');
                        else btn.classList.add('btn-outline-danger');

                        if (btn.dataset.decision === answerEntry.state) {
                            if(answerEntry.state === 'correct') {btn.classList.remove('btn-outline-success'); btn.classList.add('btn-success-modern', 'active');}
                            if(answerEntry.state === 'incorrect') {btn.classList.remove('btn-outline-danger'); btn.classList.add('btn-danger-modern', 'active');}
                        }
                    });
                }
            }

            players.forEach(p => {
                p.score = p.answers.reduce((total, ans) => total + (ans.points || 0), 0);
            });

            savePersistentPlayers();
            saveQuizState();
            updateScoreboard(isScoreboardVisible);

            let feedbackMsg = `${updatedPlayerAnswersCount} puan/cevap kaydı CSV'den yüklendi ve aktif yarışmaya uygulandı.`;
            if (errors.length > 0) {
                feedbackMsg += `<br><b>Hatalar/Uyarılar (${errors.length}):</b><br> - ${errors.slice(0, 3).join('<br> - ')}${errors.length > 3 ? '<br>...ve daha fazla.' : ''}`;
                if (teacherCsvMessage) teacherCsvMessage.className = 'mt-2 alert alert-warning small';
            } else {
                if (teacherCsvMessage) teacherCsvMessage.className = 'mt-2 text-success small';
            }
            if (teacherCsvMessage) teacherCsvMessage.innerHTML = feedbackMsg;
        }


        if (uploadAnswersCsvBtn) {
            uploadAnswersCsvBtn.addEventListener('click', handleCsvAnswersUpload);
        }
        if (exportScoresCsvTeacherBtn) {
            exportScoresCsvTeacherBtn.addEventListener('click', () => {
                if (!isQuizInProgress || currentUserRole !== 'teacher' || !currentGradeLevel || players.length === 0 || questions.length === 0) {
                    if(teacherCsvMessage) {
                        teacherCsvMessage.textContent = "Puanları indirmek için aktif bir öğretmen oturumu, yarışmacı ve soru olmalıdır.";
                        teacherCsvMessage.className = 'mt-2 text-warning small';
                    }
                    return;
                }
                const csvData = generateCSVContent(currentGradeLevel, players, questions);
                if (csvData) {
                    const gradeFilePart = String(currentGradeLevel).replace('_YEDEK', '_YEDEK_Bankasi');
                    const dateSuffix = new Date().toISOString().slice(0, 10);
                    downloadCSV(csvData, `puanlar_ogretmen_${gradeFilePart}_${dateSuffix}.csv`);
                    if(teacherCsvMessage) {
                        teacherCsvMessage.textContent = "Mevcut puanlar CSV olarak indirildi.";
                        teacherCsvMessage.className = 'mt-2 text-success small';
                    }
                } else {
                    if(teacherCsvMessage) {
                        teacherCsvMessage.textContent = "İndirilecek puan verisi bulunamadı.";
                        teacherCsvMessage.className = 'mt-2 text-warning small';
                    }
                }
            });
        }
        if (importScoresCsvTriggerBtn) {
            importScoresCsvTriggerBtn.addEventListener('click', () => {
                if (importScoresCsvFileTeacher) importScoresCsvFileTeacher.click();
            });
        }
        if (importScoresCsvFileTeacher) {
            importScoresCsvFileTeacher.addEventListener('change', (event) => {
                if (!isQuizInProgress || currentUserRole !== 'teacher') return;
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        processTeacherScoresCSV(e.target.result);
                    } catch (error) {
                        if (teacherCsvMessage) {
                            teacherCsvMessage.textContent = `CSV işlenirken hata: ${error.message}`;
                            teacherCsvMessage.className = 'mt-2 text-danger small';
                        }
                    } finally {
                        importScoresCsvFileTeacher.value = ''; // Reset file input
                    }
                };
                reader.onerror = () => {
                    if (teacherCsvMessage) {
                        teacherCsvMessage.textContent = "CSV dosyası okunurken hata.";
                        teacherCsvMessage.className = 'mt-2 text-danger small';
                    }
                    importScoresCsvFileTeacher.value = '';
                };
                reader.readAsText(file, 'UTF-8');
            });
        }


        function getLocalStorageKey(dataType, gradeLevel = currentGradeLevel) {
            if (!gradeLevel && (dataType === 'questions' || dataType === 'players' || dataType === 'teacherPass' || dataType === 'quizState')) {
                console.error("getLocalStorageKey: gradeLevel is required for data type:", dataType);
                return null;
            }
            const gradePrefix = gradeLevel ? `GRADE_${gradeLevel}_` : '';
            return `${QUIZ_DATA_BASE_KEY}${gradePrefix}${dataType}`;
        }

        function generateRandomPassword() {
            const randomNumber = Math.floor(Math.random() * 20) + 1;
            return `s${randomNumber}`;
        }

        const generateDefaultPlayersForGrade = (grade) => {
            const isYedek = typeof grade === 'string' && grade.includes('_YEDEK');
            if (isYedek) return [];

            const playersArr = [];
            if (BASE_GRADE_LEVELS_NUMERIC.includes(parseInt(String(grade).split('_')[0]))) {
                DEFAULT_BRANCHES.forEach((branchName, index) => {
                    playersArr.push({ id: Date.now() + index + Math.floor(Math.random()*100), name: branchName, score: 0, answers: [] });
                });
            }
            return playersArr;
        };

        const generateDefaultQuestionsForGrade = (grade) => {
            const isYedek = typeof grade === 'string' && grade.includes('_YEDEK');
            const gradeNumPart = String(grade).split('_')[0];

            if (parseInt(gradeNumPart) === 5) {
                if (isYedek) {
                    return JSON.parse(JSON.stringify(embedded5thGradeYedekQuestions.map((q, index) => ({
                        ...q,
                        id: q.id || (Date.now() + 100000 + index + Math.floor(Math.random()*100))
                    }))));
                } else {
                    return JSON.parse(JSON.stringify(embedded5thGradeMainQuestions.map((q, index) => ({
                        ...q,
                        id: q.id || (Date.now() + 200000 + index + Math.floor(Math.random()*100))
                    }))));
                }
            }

            const q_list = [];
            const gradeLabel = isYedek ? `${gradeNumPart}. Sınıf Yedek Bankası` : `${gradeNumPart}. Sınıf`;
            if (isYedek) {
                 for (let i = 1; i <= 5; i++) {
                    q_list.push({
                        id: Date.now() + (BASE_GRADE_LEVELS_NUMERIC.indexOf(parseInt(gradeNumPart)) * 10000) + i * 100 + Math.floor(Math.random()*100) + 70000,
                        section: `${gradeLabel} - Yedek Konu ${i} (Varsayılan)`,
                        text: `${gradeLabel} - Yedek Soru ${i}: Cevap "YEDEK CEVAP ${i}" (Varsayılan)`,
                        correctAnswerTexts: [`YEDEK CEVAP ${i}`],
                        timeLimit: 30, nextQuestionPassword: (i < 5) ? `b_${i+1}` : null, image: null
                    });
                }
            } else {
                for (let i = 1; i <= 25; i++) {
                     let qText = `${gradeLabel} - ${i <= YEDEK_START_INDEX ? 'Ana Soru' : 'Yedek Soru'} ${i} (Varsayılan)`;
                     let qPassword = null;
                     if (i < 25) {
                         if (i <= YEDEK_START_INDEX) {
                            qPassword = generateRandomPassword();
                            if (i === 1 && qPassword === "s1") { qPassword = generateRandomPassword(); }
                         } else {
                            qPassword = `yedek${i - YEDEK_START_INDEX}`;
                         }
                     }
                    q_list.push({
                        id: Date.now() + (BASE_GRADE_LEVELS_NUMERIC.indexOf(parseInt(gradeNumPart)) + 1 * 10000) + i * 100 + Math.floor(Math.random()*100),
                        section: `${gradeLabel} - Konu ${i} (Varsayılan)`,
                        text: `${qText}: Cevap "Cevap${i}"`,
                        correctAnswerTexts: [`Cevap${i}`],
                        timeLimit: 60, nextQuestionPassword: qPassword, image: null
                    });
                }
            }
            return q_list;
        };

        async function initializeGradeSpecificData(grade) {
            const questionsKey = getLocalStorageKey('questions', grade);

            if (!localStorage.getItem(questionsKey)) {
                const defaultQs = generateDefaultQuestionsForGrade(grade);
                localStorage.setItem(questionsKey, JSON.stringify(defaultQs));
            }

            const isYedekGrade = typeof grade === 'string' && grade.includes('_YEDEK');
            if (!isYedekGrade) {
                const teacherPassKey = getLocalStorageKey('teacherPass', grade);
                if (!localStorage.getItem(teacherPassKey)) localStorage.setItem(teacherPassKey, DEFAULT_TEACHER_LOGIN_PASSWORD);

                const playersKey = getLocalStorageKey('players', grade);
                if (!localStorage.getItem(playersKey)) {
                    const defaultPs = generateDefaultPlayersForGrade(grade);
                    const currentGradeQuestionsFromStorage = JSON.parse(localStorage.getItem(questionsKey) || "[]");
                    defaultPs.forEach(player => {
                        player.answers = [];
                        currentGradeQuestionsFromStorage.forEach(q => {
                            player.answers.push({ questionId: q.id, answerText: '', state: 'pending', points: 0 });
                        });
                    });
                    localStorage.setItem(playersKey, JSON.stringify(defaultPs));
                } else {
                    let playersData = JSON.parse(localStorage.getItem(playersKey));
                    const currentGradeQuestionsFromStorage = JSON.parse(localStorage.getItem(questionsKey) || "[]");
                    playersData.forEach(player => {
                        if (!player.answers) player.answers = [];
                        const existingAnswerQuestionIds = new Set(player.answers.map(a => a.questionId));
                        currentGradeQuestionsFromStorage.forEach(q => {
                            if (!existingAnswerQuestionIds.has(q.id)) {
                                player.answers.push({ questionId: q.id, answerText: '', state: 'pending', points: 0 });
                            }
                        });
                        player.answers = player.answers.filter(ans => currentGradeQuestionsFromStorage.some(q => q.id === ans.questionId));
                    });
                    localStorage.setItem(playersKey, JSON.stringify(playersData));
                }


            } else {
                 const playersKey = getLocalStorageKey('players', grade);
                 if (!localStorage.getItem(playersKey)) {
                    localStorage.setItem(playersKey, JSON.stringify([]));
                 }
            }
        }


        function showPage(pageId) {
            homePageContainer.style.display = 'none';
            gradeSelectionPage.style.display = 'none';
            adminSection.style.display = 'none';
            quizArea.style.display = 'none';
            resultsArea.style.display = 'none';
            quizPreviewArea.style.display = 'none';
            if(adminManagementPanel) adminManagementPanel.style.display = 'none';
            if(adminLoginFormContainer) adminLoginFormContainer.style.display = 'none';
            if(showScoresHeaderBtn) showScoresHeaderBtn.style.display = 'none';
            if(questionNavigationButtonsContainer) questionNavigationButtonsContainer.style.display = 'none';
            if(teacherCsvOperationsDiv) teacherCsvOperationsDiv.style.display = 'none'; // Hide teacher CSV ops by default

            if (pageId === 'home') homePageContainer.style.display = 'flex';
            else if (pageId === 'grade-selection') gradeSelectionPage.style.display = 'flex';
            else if (pageId === 'admin-login') { adminSection.style.display = 'block'; adminLoginFormContainer.style.display = 'block'; }
            else if (pageId === 'admin-panel') { adminSection.style.display = 'block'; adminManagementPanel.style.display = 'block'; }
            else if (pageId === 'quiz') { quizArea.style.display = 'block'; if(showScoresHeaderBtn) showScoresHeaderBtn.style.display = 'inline-block'; if(questionNavigationButtonsContainer) questionNavigationButtonsContainer.style.display = 'flex';}
            else if (pageId === 'results') { resultsArea.style.display = 'block'; if(showScoresHeaderBtn) showScoresHeaderBtn.style.display = 'inline-block';}
            else if (pageId === 'quiz-preview') {
                quizPreviewArea.style.display = 'block';
                if(questionNavigationButtonsContainer) questionNavigationButtonsContainer.style.display = 'none';
            }


            updateHeaderButtonsVisibility();
            if(!['quiz', 'results', 'quiz-preview'].includes(pageId)){
                if(mainAppTitle) mainAppTitle.textContent = "Çavuşoğlu İsmail Yeşilyurt İHO - Bilgi Yarışması";
            }
            if (pageId === 'results' && winnerTextDisplay) {
                const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
                let gradient = 'var(--success-gradient)';
                if (currentTheme === 'dark') {
                    gradient = 'linear-gradient(135deg, #2f8cfe 0%, #00d2d2 100%)';
                } else if (currentTheme === 'vibrant') {
                    gradient = 'linear-gradient(135deg, #1dd1a1 0%, #48dbfb 100%)';
                }
                winnerTextDisplay.style.background = gradient;
                winnerTextDisplay.style.webkitBackgroundClip = 'text';
                winnerTextDisplay.style.webkitTextFillColor = 'transparent';
                winnerTextDisplay.style.backgroundClip = 'text';
            }
            if(pageId === 'quiz' && timeEndedMessage){
                 const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
                let gradient = 'var(--danger-gradient)';
                if (currentTheme === 'dark') {
                    gradient = 'linear-gradient(135deg, #e0527a 0%, #d9c530 100%)';
                } else if (currentTheme === 'vibrant') {
                    gradient = 'linear-gradient(135deg, #ff9f43 0%, #ff6b6b 100%)';
                }
                timeEndedMessage.style.background = gradient;
            }
        }

        function updateHeaderButtonsVisibility() {
            const isQuizActive = quizArea.style.display === 'block';
            const isResultsActive = resultsArea.style.display === 'block';
            const isPreviewActive = quizPreviewArea.style.display === 'block';
            if (currentUserRole === 'student' && isQuizActive) {
                if(adminPanelBtn) adminPanelBtn.style.display = 'none';
                if(resetAllDataBtn) resetAllDataBtn.style.display = 'none';
            } else {
                if(adminPanelBtn) adminPanelBtn.style.display = isAdminLoggedIn || !(isQuizActive || isResultsActive || isPreviewActive) ? 'inline-block' : 'none';
                if(resetAllDataBtn) resetAllDataBtn.style.display = isAdminLoggedIn && adminManagementPanel.style.display === 'block' ? 'inline-block' : 'none';
            }
            if(homeActionBtn) homeActionBtn.style.display = 'inline-block';
        }

        function initializeGlobalAdminCredentials() {
            if (!localStorage.getItem(ADMIN_USERNAME_KEY)) localStorage.setItem(ADMIN_USERNAME_KEY, DEFAULT_ADMIN_USERNAME);
            if (!localStorage.getItem(ADMIN_PASSWORD_KEY)) localStorage.setItem(ADMIN_PASSWORD_KEY, DEFAULT_ADMIN_PASSWORD);
        }

        studentLoginTypeBtn.addEventListener('click', () => {
            tempLoginType = 'student';
            startFromQuestion21Mode = false;
            prepareGradeSelectionPage('Öğrenci Girişi İçin Sınıf Seçin', false);
            showPage('grade-selection');
        });
        teacherLoginTypeBtn.addEventListener('click', () => {
            tempLoginType = 'teacher';
            startFromQuestion21Mode = false;
            prepareGradeSelectionPage('Öğretmen Girişi İçin Sınıf Seçin', false);
            showPage('grade-selection');
        });
        studentYedekLoginTypeBtn.addEventListener('click', () => {
            tempLoginType = 'student';
            startFromQuestion21Mode = true;
            prepareGradeSelectionPage('Yedek Soruları Görüntülemek İçin Ana Sınıfı Seçin', false);
            showPage('grade-selection');
        });


        backToHomeFromGradeSelectionBtn.addEventListener('click', () => showPage('home'));

        function prepareGradeSelectionPage(title, forYedekBankAdmin = false) {
            gradeSelectionTitle.textContent = title;
            gradeButtonsContainer.innerHTML = '';
            let levelsToDisplay;

            if (forYedekBankAdmin) {
                levelsToDisplay = GRADE_LEVELS.filter(g => typeof g === 'string' && g.includes('_YEDEK'));
            } else {
                levelsToDisplay = BASE_GRADE_LEVELS_NUMERIC;
            }

            levelsToDisplay.forEach(grade => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-primary-modern btn-modern btn-lg grade-selection-button';
                const gradeName = typeof grade === 'string' && grade.includes('_YEDEK')
                                  ? `${grade.split('_')[0]}. Sınıf Yedek Bankası`
                                  : `${grade}. Sınıf`;
                btn.textContent = gradeName;
                btn.dataset.grade = String(grade); // Ensure dataset.grade is always string
                btn.addEventListener('click', handleGradeSelection);
                gradeButtonsContainer.appendChild(btn);
            });
        }

        async function handleGradeSelection(event) {
            const selectedGradeStr = event.target.dataset.grade;
            currentGradeLevel = selectedGradeStr.includes('_YEDEK') ? selectedGradeStr : parseInt(selectedGradeStr);
            currentUserRole = tempLoginType;
            const gradeDisplayName = event.target.textContent;

            const isYedekBankForPreview = typeof currentGradeLevel === 'string' && currentGradeLevel.includes('_YEDEK');

            loadDataForCurrentGrade(false);

            if (startFromQuestion21Mode && !isYedekBankForPreview) {
                quizTitle = `${gradeDisplayName} - Yedek Sorular (${YEDEK_START_INDEX + 1}.den itibaren)`;
                if(mainAppTitle) mainAppTitle.textContent = quizTitle;
                startQuizForRole(YEDEK_START_INDEX, true);
            } else if (isYedekBankForPreview) {
                quizTitle = `${gradeDisplayName} Soru Bankası`;
                if(mainAppTitle) mainAppTitle.textContent = quizTitle;
                startQuizForRole(0, true);
            } else {
                quizTitle = `${gradeDisplayName} Bilgi Yarışması`;
                if(mainAppTitle) mainAppTitle.textContent = quizTitle;
                if (currentUserRole === 'teacher') {
                    const teacherPassKey = getLocalStorageKey('teacherPass', currentGradeLevel);
                    const requiredPassword = localStorage.getItem(teacherPassKey) || DEFAULT_TEACHER_LOGIN_PASSWORD;
                    showPasswordPromptModal(`Lütfen ${gradeDisplayName} öğretmen şifresini girin:`, requiredPassword, () => {
                        startQuizForRole(0, true);
                    });
                } else {
                    startQuizForRole(0, true);
                }
            }
        }


        function loadDataForCurrentGrade(forAdminPanel) {
            if (!currentGradeLevel) return;

            const questionsData = localStorage.getItem(getLocalStorageKey('questions', currentGradeLevel));
            questions = questionsData ? JSON.parse(questionsData) : [];

            const isYedekGrade = typeof currentGradeLevel === 'string' && currentGradeLevel.includes('_YEDEK');
            if (!isYedekGrade) {
                const playersData = localStorage.getItem(getLocalStorageKey('players', currentGradeLevel));
                players = playersData ? JSON.parse(playersData) : [];

                if (questions.length > 0) {
                    players.forEach(player => {
                        if(!player.answers) player.answers = [];
                        const currentAnswerIds = new Set(player.answers.map(a => a.questionId));
                        questions.forEach(q => {
                            if (!currentAnswerIds.has(q.id)) {
                                player.answers.push({ questionId: q.id, answerText: '', state: 'pending', points: 0 });
                            }
                        });
                        player.answers = player.answers.filter(ans => questions.some(q => q.id === ans.questionId));
                    });
                }
            } else {
                players = [];
            }


            if (forAdminPanel && isAdminLoggedIn) {
                if(playerListEl) renderPlayerList();
                if(existingQuestionsList) renderExistingQuestions();
                if(questionCountEl) updateQuestionCount();
                const selectedOptionText = adminGradeLevelSelect.options[adminGradeLevelSelect.selectedIndex]?.text ||
                                          (typeof currentGradeLevel === 'string' && currentGradeLevel.includes("_YEDEK")
                                           ? String(currentGradeLevel).replace('_YEDEK','. Sınıf Yedek Bankası')
                                           : `${currentGradeLevel}. Sınıf`);
                if(currentAdminGradeDisplayPlayers) currentAdminGradeDisplayPlayers.textContent = selectedOptionText;
                if(currentAdminGradeDisplayTeacherPass) currentAdminGradeDisplayTeacherPass.textContent = selectedOptionText;
                if(currentAdminGradeDisplayQuestions) currentAdminGradeDisplayQuestions.textContent = selectedOptionText;
                if(currentAdminGradeDisplayDataOp) currentAdminGradeDisplayDataOp.textContent = selectedOptionText;


                if (teacherPasswordCard) teacherPasswordCard.style.display = isYedekGrade ? 'none' : 'block';
                if(adminPanelPlayersCard) adminPanelPlayersCard.style.display = isYedekGrade ? 'none' : 'block';


                if(teacherLoginPasswordInput && !isYedekGrade) {
                    teacherLoginPasswordInput.value = localStorage.getItem(getLocalStorageKey('teacherPass', currentGradeLevel)) || DEFAULT_TEACHER_LOGIN_PASSWORD;
                }
                loadQuizStateForAdmin();
            }
        }

        if (adminPanelBtn) {
            adminPanelBtn.addEventListener('click', () => {
                if (isAdminLoggedIn) {
                    showPage('admin-panel');
                    if (!currentGradeLevel && GRADE_LEVELS.length > 0) {
                        adminGradeLevelSelect.value = String(BASE_GRADE_LEVELS_NUMERIC[0]);
                        adminGradeLevelSelect.dispatchEvent(new Event('change'));
                    } else if (currentGradeLevel) {
                         adminGradeLevelSelect.value = String(currentGradeLevel);
                         adminGradeLevelSelect.dispatchEvent(new Event('change'));
                    }
                } else {
                    showPage('admin-login');
                }
            });
        }
        if (adminLoginForm) {
            adminLoginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const username = adminUsernameInput.value;
                const password = adminPasswordInput.value;
                const storedUsername = localStorage.getItem(ADMIN_USERNAME_KEY);
                const storedPassword = localStorage.getItem(ADMIN_PASSWORD_KEY);
                if (username === storedUsername && password === storedPassword) {
                    isAdminLoggedIn = true;
                    adminLoginError.style.display = 'none';
                    showPage('admin-panel');
                     if (GRADE_LEVELS.length > 0) {
                        adminGradeLevelSelect.value = currentGradeLevel ? String(currentGradeLevel) : String(BASE_GRADE_LEVELS_NUMERIC[0]);
                        adminGradeLevelSelect.dispatchEvent(new Event('change'));
                    }
                } else {
                    isAdminLoggedIn = false;
                    adminLoginError.style.display = 'block';
                }
            });
        }
        if (adminLogoutBtn) {
            adminLogoutBtn.addEventListener('click', () => {
                isAdminLoggedIn = false;
                if(resetAllDataBtn) resetAllDataBtn.style.display = 'none';
                showPage('home');
            });
        }
        function populateAdminGradeSelect() {
            if (!adminGradeLevelSelect) return;
            adminGradeLevelSelect.innerHTML = '';
            const mainLevelsGroup = document.createElement('optgroup');
            mainLevelsGroup.label = "Ana Sınıf Düzeyleri";
            BASE_GRADE_LEVELS_NUMERIC.forEach(grade => {
                const option = document.createElement('option');
                option.value = String(grade);
                option.textContent = `${grade}. Sınıf Yarışması`;
                mainLevelsGroup.appendChild(option);
            });
            adminGradeLevelSelect.appendChild(mainLevelsGroup);
            const yedekLevelsGroup = document.createElement('optgroup');
            yedekLevelsGroup.label = "Ayrı Yedek Soru Bankaları";
            BASE_GRADE_LEVELS_NUMERIC.forEach(grade => {
                const yedekValue = `${grade}_YEDEK`;
                const option = document.createElement('option');
                option.value = yedekValue;
                option.textContent = `${grade}. Sınıf Yedek Bankası`;
                yedekLevelsGroup.appendChild(option);
            });
            adminGradeLevelSelect.appendChild(yedekLevelsGroup);
        }
        if (adminGradeLevelSelect) {
             adminGradeLevelSelect.addEventListener('change', () => {
                const selectedGradeValue = adminGradeLevelSelect.value;
                currentGradeLevel = selectedGradeValue.includes('_YEDEK') ? selectedGradeValue : parseInt(selectedGradeValue);

                const selectedOptionText = adminGradeLevelSelect.options[adminGradeLevelSelect.selectedIndex].text;
                quizTitle = `${selectedOptionText} Yönetimi`;
                if(mainAppTitle) mainAppTitle.textContent = quizTitle;
                loadDataForCurrentGrade(true);
                resetQuestionForm();
            });
        }
        if (changeAdminPasswordForm) {
            changeAdminPasswordForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!isAdminLoggedIn) return;
                const currentPass = currentAdminPasswordInput.value;
                const newPass = newAdminPasswordInput.value;
                const confirmPass = confirmNewAdminPasswordInput.value;
                const storedPassword = localStorage.getItem(ADMIN_PASSWORD_KEY);
                changePasswordMessage.textContent = '';
                changePasswordMessage.className = 'mt-2';
                if (currentPass !== storedPassword) {
                    changePasswordMessage.textContent = 'Mevcut admin şifresi yanlış!';
                    changePasswordMessage.classList.add('text-danger'); return;
                }
                if (newPass.length < 4) {
                    changePasswordMessage.textContent = 'Yeni admin şifre en az 4 karakter olmalı!';
                    changePasswordMessage.classList.add('text-danger'); return;
                }
                if (newPass !== confirmPass) {
                    changePasswordMessage.textContent = 'Yeni admin şifreler eşleşmiyor!';
                    changePasswordMessage.classList.add('text-danger'); return;
                }
                localStorage.setItem(ADMIN_PASSWORD_KEY, newPass);
                changePasswordMessage.textContent = 'Admin şifresi başarıyla değiştirildi!';
                changePasswordMessage.classList.add('text-success');
                changeAdminPasswordForm.reset();
            });
        }
        if (changeTeacherLoginPasswordForm) {
            changeTeacherLoginPasswordForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!isAdminLoggedIn || !currentGradeLevel || (typeof currentGradeLevel === 'string' && currentGradeLevel.includes('_YEDEK'))) {
                    teacherLoginPasswordMessage.textContent = 'Yedek bankalar için öğretmen şifresi ayarlanamaz.';
                    teacherLoginPasswordMessage.className = 'mt-2 text-warning';
                    return;
                }
                const newTeacherPass = teacherLoginPasswordInput.value.trim();
                teacherLoginPasswordMessage.textContent = '';
                teacherLoginPasswordMessage.className = 'mt-2';
                if (newTeacherPass.length < 4) {
                    teacherLoginPasswordMessage.textContent = 'Öğretmen şifresi en az 4 karakter olmalı!';
                    teacherLoginPasswordMessage.classList.add('text-danger'); return;
                }
                localStorage.setItem(getLocalStorageKey('teacherPass', currentGradeLevel), newTeacherPass);
                teacherLoginPasswordMessage.textContent = `${currentGradeLevel}. Sınıf öğretmen şifresi başarıyla kaydedildi!`;
                teacherLoginPasswordMessage.classList.add('text-success');
            });
        }
        if (resetAllDataBtn) {
            resetAllDataBtn.addEventListener('click', async () => {
                if (!isAdminLoggedIn || !currentGradeLevel) {
                    alert("Lütfen önce bir sınıf düzeyi veya soru bankası seçin.");
                    return;
                }
                const gradeDisplayName = adminGradeLevelSelect.options[adminGradeLevelSelect.selectedIndex].text;
                const isYedekGrade = typeof currentGradeLevel === 'string' && currentGradeLevel.includes('_YEDEK');
                let confirmationMessage = `UYARI: "${gradeDisplayName}" için kaydedilmiş TÜM SORULARI kalıcı olarak silecektir!`;
                if (!isYedekGrade) {
                    confirmationMessage += ` Ayrıca yarışmacıları, skorları ve yarışma durumunu da silecektir.`;
                }
                confirmationMessage += ` Bu işlem varsayılanları (veya 5. sınıf için gömülü soruları) geri yükleyecektir. Emin misiniz?`;

                if (confirm(confirmationMessage)) {
                    localStorage.removeItem(getLocalStorageKey('quizState', currentGradeLevel));
                    localStorage.removeItem(getLocalStorageKey('players', currentGradeLevel));
                    localStorage.removeItem(getLocalStorageKey('questions', currentGradeLevel));
                    if (!isYedekGrade) {
                        localStorage.removeItem(getLocalStorageKey('teacherPass', currentGradeLevel));
                    }
                    await initializeGradeSpecificData(currentGradeLevel);
                    loadDataForCurrentGrade(true);
                    alert(`"${gradeDisplayName}" için tüm veriler sıfırlandı ve varsayılanlar/gömülü sorular yüklendi.`);
                }
            });
        }
        if (addPlayerForm) {
            addPlayerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!isAdminLoggedIn || !currentGradeLevel || (typeof currentGradeLevel === 'string' && currentGradeLevel.includes('_YEDEK'))) return;
                const playerNameVal = playerNameInput.value.trim();
                if (playerNameVal) {
                    if (!players.find(p => p.name.toLowerCase() === playerNameVal.toLowerCase())) {
                        const newPlayer = {
                            id: Date.now() + Math.floor(Math.random()*100), name: playerNameVal, score: 0, answers: []
                        };
                        initializePlayerAnswersForPlayer(newPlayer);
                        players.push(newPlayer);
                        playerNameInput.value = '';
                        renderPlayerList();
                        savePersistentPlayers();
                    } else { alert("Bu isimde bir yarışmacı zaten mevcut!"); }
                }
            });
        }
        function renderPlayerList() {
            if (!playerListEl) return;
            playerListEl.innerHTML = '';
            const isYedekGrade = typeof currentGradeLevel === 'string' && currentGradeLevel.includes('_YEDEK');
            if (isYedekGrade || players.length === 0) {
                playerListEl.innerHTML = `<li class="list-group-item text-muted text-center">${isYedekGrade ? 'Yedek soru bankaları için yarışmacı yönetimi yapılamaz.' : 'Henüz yarışmacı eklenmedi.'}</li>`;
            } else {
                players.forEach(player => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center animate__animated animate__fadeInUp';
                    li.style.borderRadius = '8px'; li.style.marginBottom = '0.5rem';
                    const nameSpan = document.createElement('span');
                    nameSpan.innerHTML = `<i class="fas fa-user-circle mr-2 text-primary"></i>${player.name}`;
                    li.appendChild(nameSpan);
                    const delBtn = document.createElement('button');
                    delBtn.className = 'btn btn-danger-modern btn-modern btn-sm py-1 px-2';
                    delBtn.style.fontSize = '0.8rem';
                    delBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                    delBtn.title = "Yarışmacıyı Sil";
                    delBtn.onclick = () => { if (!isAdminLoggedIn || !currentGradeLevel) return; deletePlayer(player.id); };
                    li.appendChild(delBtn); playerListEl.appendChild(li);
                });
            }
        }
        function deletePlayer(id) {
            if (!isAdminLoggedIn || !currentGradeLevel || (typeof currentGradeLevel === 'string' && currentGradeLevel.includes('_YEDEK'))) return;
            players = players.filter(p => p.id !== id);
            renderPlayerList();
            savePersistentPlayers();
        }
        function savePersistentPlayers() {
             if (!currentGradeLevel || (typeof currentGradeLevel === 'string' && currentGradeLevel.includes('_YEDEK'))) return;
            try {
                players.forEach(p => { if (!p.answers) p.answers = []; });
                localStorage.setItem(getLocalStorageKey('players', currentGradeLevel), JSON.stringify(players));
            } catch (error) { console.error("Kalıcı oyuncu verileri kaydedilemedi:", error); }
        }
        if(addQuestionForm) {
            addQuestionForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!isAdminLoggedIn || !currentGradeLevel) return;
                const selectedTimeLimitRadio = document.querySelector('input[name="questionTimeLimit"]:checked');
                if (!selectedTimeLimitRadio) { alert("Lütfen bir soru süresi seçin."); return; }
                const questionData = {
                    section: questionSectionEl.value.trim() || "Genel",
                    text: questionTextEl.value.trim(),
                    image: imagePreviewEl && imagePreviewEl.src.startsWith('data:image') ? imagePreviewEl.src : null,
                    correctAnswerTexts: correctAnswerTextInputEl.value.trim().split(',').map(ans => ans.trim()).filter(ans => ans),
                    timeLimit: parseInt(selectedTimeLimitRadio.value),
                    nextQuestionPassword: nextQuestionPasswordInputEl.value.trim() || null
                };
                if (!questionData.text || questionData.correctAnswerTexts.length === 0) {
                    alert('Soru metnini ve en az bir doğru cevap metnini doldurun.'); return;
                }
                if (editingQuestionId) {
                    const qIndex = questions.findIndex(q => q.id === editingQuestionId);
                    if (qIndex > -1) {
                        questions[qIndex] = { ...questions[qIndex], ...questionData };
                        alert('Soru güncellendi!');
                    }
                } else {
                    const newQuestion = { id: Date.now() + Math.floor(Math.random()*100), ...questionData };
                    questions.push(newQuestion);
                    if (!(typeof currentGradeLevel === 'string' && currentGradeLevel.includes('_YEDEK'))) {
                        players.forEach(player => {
                            if (!player.answers) player.answers = [];
                            player.answers.push({ questionId: newQuestion.id, answerText: '', state: 'pending', points: 0 });
                        });
                        savePersistentPlayers();
                    }
                    alert('Soru eklendi!');
                }
                saveQuestions(); renderExistingQuestions(); updateQuestionCount(); resetQuestionForm();
            });
        }
        function saveQuestions() {
            if (!currentGradeLevel) return;
            try { localStorage.setItem(getLocalStorageKey('questions', currentGradeLevel), JSON.stringify(questions)); }
            catch (error) { console.error("Soruları kaydetme hatası:", error); }
        }
        function renderExistingQuestions() {
            if(!existingQuestionsList) return;
            existingQuestionsList.innerHTML = '';
            if (!questions || questions.length === 0) {
                existingQuestionsList.innerHTML = '<li class="list-group-item text-muted text-center">Soru yok.</li>';
                if(selectAllQuestionsCheckbox) { selectAllQuestionsCheckbox.checked = false; selectAllQuestionsCheckbox.disabled = true; }
                if(deleteSelectedQuestionsBtn) deleteSelectedQuestionsBtn.disabled = true;
            } else {
                if(selectAllQuestionsCheckbox) selectAllQuestionsCheckbox.disabled = false;
                if(deleteSelectedQuestionsBtn) deleteSelectedQuestionsBtn.disabled = false;
                questions.forEach((q, index) => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center p-2 animate__animated animate__fadeIn existing-question-item';
                    li.style.borderRadius = '8px'; li.style.marginBottom = '0.3rem';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'question-select-checkbox mr-2';
                    checkbox.dataset.questionId = q.id;
                    checkbox.addEventListener('change', updateSelectAllCheckboxState);
                    li.appendChild(checkbox);
                    const summaryDiv = document.createElement('div');
                    summaryDiv.className = 'question-summary flex-grow-1';
                    const correctAnswerPreview = q.correctAnswerTexts && q.correctAnswerTexts.length > 0
                        ? q.correctAnswerTexts[0].substring(0,15) + (q.correctAnswerTexts[0].length > 15 ? '...' : '')
                        : 'Cevap Yok';
                    summaryDiv.innerHTML = `
                        <span class="badge bg-primary text-white mr-1">${index + 1}</span>
                        <span class="badge bg-info text-white mr-2">${q.section || 'Genel'}</span>
                        ${q.text.substring(0, 15)}${q.text.length > 15 ? '...' : ''}
                        (Cvp: ${correctAnswerPreview})
                        (${q.timeLimit || '30'}s)${q.image ? ' <i class="fas fa-image text-muted ml-1"></i>' : ''}
                        ${q.nextQuestionPassword ? ' <i class="fas fa-key text-warning ml-1" title="Şifreli geçiş: ' + q.nextQuestionPassword + '"></i>' : ''}
                    `;
                    li.appendChild(summaryDiv);
                    const controlButtonsDiv = document.createElement('div');
                    controlButtonsDiv.className = 'btn-group-vertical ml-2';
                    const moveUpBtn = document.createElement('button');
                    const moveDownBtn = document.createElement('button');
                    moveUpBtn.className = 'btn btn-outline-secondary btn-sm btn-move';
                    moveUpBtn.innerHTML = '<i class="fas fa-arrow-up"></i>';
                    moveUpBtn.title = "Yukarı Taşı";
                    moveUpBtn.onclick = () => { if (!isAdminLoggedIn) return; moveQuestion(index, -1); };
                    moveUpBtn.disabled = index === 0;
                    controlButtonsDiv.appendChild(moveUpBtn);
                    moveDownBtn.className = 'btn btn-outline-secondary btn-sm btn-move';
                    moveDownBtn.innerHTML = '<i class="fas fa-arrow-down"></i>';
                    moveDownBtn.title = "Aşağı Taşı";
                    moveDownBtn.onclick = () => { if (!isAdminLoggedIn) return; moveQuestion(index, 1); };
                    moveDownBtn.disabled = index === questions.length - 1;
                    controlButtonsDiv.appendChild(moveDownBtn);
                    const editDelBtnGroup = document.createElement('div');
                    editDelBtnGroup.className = 'btn-group ml-2';
                    const editBtn = document.createElement('button');
                    const delBtn = document.createElement('button');
                     editBtn.className = 'btn btn-outline-warning btn-sm'; editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                    editBtn.title = "Düzenle";
                    editBtn.onclick = () => { if (!isAdminLoggedIn) return; populateFormForEdit(q.id); };
                    editDelBtnGroup.appendChild(editBtn);
                    delBtn.className = 'btn btn-outline-danger btn-sm'; delBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                    delBtn.title = "Sil";
                    delBtn.onclick = () => { if (!isAdminLoggedIn) return; deleteQuestion(q.id); };
                    editDelBtnGroup.appendChild(delBtn);
                    const allControls = document.createElement('div');
                    allControls.className = 'd-flex align-items-center';
                    allControls.appendChild(controlButtonsDiv);
                    allControls.appendChild(editDelBtnGroup);
                    li.appendChild(allControls);
                    existingQuestionsList.appendChild(li);
                });
            }
            updateSelectAllCheckboxState();
        }
        function updateSelectAllCheckboxState() {
            if (!selectAllQuestionsCheckbox || !existingQuestionsList) return;
            const allCheckboxes = existingQuestionsList.querySelectorAll('.question-select-checkbox');
            if (allCheckboxes.length === 0) {
                selectAllQuestionsCheckbox.checked = false;
                selectAllQuestionsCheckbox.indeterminate = false;
                return;
            }
            const checkedCount = Array.from(allCheckboxes).filter(cb => cb.checked).length;
            if (checkedCount === 0) {
                selectAllQuestionsCheckbox.checked = false; selectAllQuestionsCheckbox.indeterminate = false;
            } else if (checkedCount === allCheckboxes.length) {
                selectAllQuestionsCheckbox.checked = true; selectAllQuestionsCheckbox.indeterminate = false;
            } else {
                selectAllQuestionsCheckbox.checked = false; selectAllQuestionsCheckbox.indeterminate = true;
            }
        }
        if (selectAllQuestionsCheckbox) {
            selectAllQuestionsCheckbox.addEventListener('change', () => {
                if (!existingQuestionsList) return;
                const allCheckboxes = existingQuestionsList.querySelectorAll('.question-select-checkbox');
                allCheckboxes.forEach(cb => cb.checked = selectAllQuestionsCheckbox.checked);
            });
        }
        if (deleteSelectedQuestionsBtn) {
            deleteSelectedQuestionsBtn.addEventListener('click', () => {
                if (!isAdminLoggedIn || !currentGradeLevel || !existingQuestionsList) return;
                const selectedCheckboxes = Array.from(existingQuestionsList.querySelectorAll('.question-select-checkbox:checked'));
                if (selectedCheckboxes.length === 0) {
                    alert("Silmek için lütfen en az bir soru seçin."); return;
                }
                if (confirm(`${selectedCheckboxes.length} adet soruyu silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.`)) {
                    const idsToDelete = selectedCheckboxes.map(cb => parseInt(cb.dataset.questionId));
                    questions = questions.filter(q => !idsToDelete.includes(q.id));
                    if (!(typeof currentGradeLevel === 'string' && currentGradeLevel.includes('_YEDEK'))) {
                        players.forEach(player => {
                            if(player.answers) player.answers = player.answers.filter(ans => !idsToDelete.includes(ans.questionId));
                        });
                        savePersistentPlayers();
                    }
                    saveQuestions();
                    renderExistingQuestions();
                    updateQuestionCount();
                    resetQuestionForm();
                    alert(`${idsToDelete.length} soru başarıyla silindi.`);
                }
            });
        }
        function populateFormForEdit(questionId) {
            if (!isAdminLoggedIn) return;
            const questionToEdit = questions.find(q => q.id === questionId);
            if (!questionToEdit) return;
            editingQuestionId = questionId;
            if(editingQuestionIdInput) editingQuestionIdInput.value = questionId;
            if(questionFormTitle) questionFormTitle.textContent = "Soruyu Düzenle";
            if(submitQuestionBtn) {
                submitQuestionBtn.innerHTML = '<i class="fas fa-save mr-1"></i>Soruyu Güncelle';
                submitQuestionBtn.classList.remove('btn-primary-modern'); submitQuestionBtn.classList.add('btn-warning-modern');
            }
            if(cancelEditBtn) cancelEditBtn.style.display = 'inline-block';
            if(questionSectionEl) questionSectionEl.value = questionToEdit.section || '';
            if(questionTextEl) questionTextEl.value = questionToEdit.text;
            if(correctAnswerTextInputEl) correctAnswerTextInputEl.value = questionToEdit.correctAnswerTexts.join(', ');
            if(nextQuestionPasswordInputEl) nextQuestionPasswordInputEl.value = questionToEdit.nextQuestionPassword || '';
            const timeLimitRadio = document.querySelector(`input[name="questionTimeLimit"][value="${questionToEdit.timeLimit || 30}"]`);
            if (timeLimitRadio) timeLimitRadio.checked = true;
            else { const defaultRadio = document.querySelector('input[name="questionTimeLimit"][value="30"]'); if(defaultRadio) defaultRadio.checked = true; }
            if (questionToEdit.image && imagePreviewEl) { imagePreviewEl.src = questionToEdit.image; imagePreviewEl.style.display = 'block'; }
            else if(imagePreviewEl) { imagePreviewEl.src = '#'; imagePreviewEl.style.display = 'none'; }
            if(questionImageEl) questionImageEl.value = '';
            if(adminPanelQuestions) adminPanelQuestions.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        function resetQuestionForm() {
            if (!addQuestionForm) return;
            addQuestionForm.reset();
            if(imagePreviewEl) { imagePreviewEl.src = '#'; imagePreviewEl.style.display = 'none';}
            if(questionImageEl) questionImageEl.value = '';
            if(correctAnswerTextInputEl) correctAnswerTextInputEl.value = '';
            if(nextQuestionPasswordInputEl) nextQuestionPasswordInputEl.value = '';
            if(editingQuestionIdInput) editingQuestionIdInput.value = '';
            editingQuestionId = null;
            if(questionFormTitle) questionFormTitle.textContent = "Soru Ekle";
            if(submitQuestionBtn) {
                submitQuestionBtn.innerHTML = '<i class="fas fa-plus mr-1"></i>Soruyu Ekle';
                submitQuestionBtn.classList.remove('btn-warning-modern'); submitQuestionBtn.classList.add('btn-primary-modern');
            }
            if(cancelEditBtn) cancelEditBtn.style.display = 'none';
            const defaultTimeRadio = document.querySelector('input[name="questionTimeLimit"][value="30"]');
            if (defaultTimeRadio) defaultTimeRadio.checked = true;
        }
        function updateQuestionCount() {
            if(questionCountEl) questionCountEl.textContent = (questions && questions.length) ? questions.length : "0";
        }
        function deleteQuestion(id) {
            if (!isAdminLoggedIn || !currentGradeLevel) return;
            if (confirm('Bu soruyu silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.')) {
                questions = questions.filter(q => q.id !== id);
                 if (!(typeof currentGradeLevel === 'string' && currentGradeLevel.includes('_YEDEK'))) {
                    players.forEach(player => {
                        if(player.answers) player.answers = player.answers.filter(ans => ans.questionId !== id);
                    });
                    savePersistentPlayers();
                 }
                saveQuestions();
                renderExistingQuestions();
                updateQuestionCount();
                if (editingQuestionId === id) resetQuestionForm();
            }
        }
        function moveQuestion(index, direction) {
            if (!isAdminLoggedIn || !currentGradeLevel) return;
            if (direction === -1 && index > 0) {
                [questions[index], questions[index - 1]] = [questions[index - 1], questions[index]];
            } else if (direction === 1 && index < questions.length - 1) {
                [questions[index], questions[index + 1]] = [questions[index + 1], questions[index]];
            }
            saveQuestions();
            renderExistingQuestions();
            if (editingQuestionId && questions.findIndex(q => q.id === editingQuestionId) !== index) {
                resetQuestionForm();
            }
        }

        function renderQuestionNavigationButtons() {
            if (!questionNavigationButtonsContainer || !questions || questions.length === 0 || quizArea.style.display === 'none') {
                if(questionNavigationButtonsContainer) questionNavigationButtonsContainer.style.display = 'none';
                return;
            }

            questionNavigationButtonsContainer.innerHTML = '';
            questionNavigationButtonsContainer.style.display = 'flex';

            questions.forEach((q, index) => {
                const button = document.createElement('button');
                button.className = 'btn btn-sm m-1';
                button.textContent = index + 1;
                button.dataset.questionIndex = index;
                button.disabled = false;

                const isYedekQuestionStyle = index >= YEDEK_START_INDEX && !(typeof currentGradeLevel === 'string' && currentGradeLevel.includes('_YEDEK'));

                if (index === currentQuestionIndex) {
                    button.classList.add(isYedekQuestionStyle ? 'btn-warning-modern' : 'btn-primary-modern', 'active');
                } else if (currentUserRole === 'teacher' || index <= unlockedUpToQuestionIndex) {
                    button.classList.add(isYedekQuestionStyle ? 'btn-outline-warning-modern' : 'btn-outline-info-modern');
                } else {
                    button.classList.add('btn-outline-secondary-modern');
                }

                if (isYedekQuestionStyle) {
                    button.classList.add('btn-nav-yedek');
                }

                button.addEventListener('click', () => handleQuestionNavigationClick(index));
                questionNavigationButtonsContainer.appendChild(button);
            });
        }

        function handleQuestionNavigationClick(targetIndex) {
            if (targetIndex === currentQuestionIndex && currentUserRole === 'student') return;

            const performLoadQuestion = () => {
                currentQuestionIndex = targetIndex;
                timeLeft = questions[currentQuestionIndex]?.timeLimit || 30;
                timerStartedThisQuestion = false;
                timerPausedThisQuestion = false;
                loadQuestion();
            };

            if (currentUserRole === 'teacher') {
                 if (evaluationControls.style.display === 'block'){
                    alert("Lütfen önce mevcut değerlendirmeyi kaydedin veya bir sonraki soruya geçin.");
                    return;
                 }
                unlockedUpToQuestionIndex = Math.max(unlockedUpToQuestionIndex, targetIndex);
                performLoadQuestion();
                return;
            }

            if (targetIndex <= unlockedUpToQuestionIndex) {
                performLoadQuestion();
            } else {
                const passwordCheckQuestionIndex = targetIndex - 1;

                if (passwordCheckQuestionIndex < 0) {
                    unlockedUpToQuestionIndex = Math.max(unlockedUpToQuestionIndex, targetIndex);
                    performLoadQuestion();
                    return;
                }

                const questionForPassword = questions[passwordCheckQuestionIndex];
                const requiredPassword = questionForPassword ? questionForPassword.nextQuestionPassword : null;

                if (requiredPassword && requiredPassword.trim() !== "") {
                    showPasswordPromptModal(
                        `Soru ${targetIndex + 1}'e geçmek için şifreyi girin (Bu şifre Soru ${passwordCheckQuestionIndex + 1}'in sonunda belirtilmiştir):`,
                        requiredPassword,
                        () => {
                            unlockedUpToQuestionIndex = Math.max(unlockedUpToQuestionIndex, targetIndex);
                            performLoadQuestion();
                        }
                    );
                } else {
                    unlockedUpToQuestionIndex = Math.max(unlockedUpToQuestionIndex, targetIndex);
                    performLoadQuestion();
                }
            }
        }


        function startQuizForRole(startIndex = 0, isNewStart = false) {
            if (!currentGradeLevel) { alert("Sınıf düzeyi seçilmedi!"); return; }

            const isYedekBankSelectedForPreview = typeof currentGradeLevel === 'string' && currentGradeLevel.includes('_YEDEK');
            let gradeDisplayNameForTitle = "";

            if (isAdminLoggedIn && adminGradeLevelSelect && adminGradeLevelSelect.options[adminGradeLevelSelect.selectedIndex] && String(adminGradeLevelSelect.value) === String(currentGradeLevel)) {
                gradeDisplayNameForTitle = adminGradeLevelSelect.options[adminGradeLevelSelect.selectedIndex].text;
            } else {
                 const tempGradeBtn = Array.from(gradeButtonsContainer.children).find(btn => btn.dataset.grade === String(currentGradeLevel));
                 gradeDisplayNameForTitle = tempGradeBtn ? tempGradeBtn.textContent :
                                           (isYedekBankSelectedForPreview ? String(currentGradeLevel).replace('_YEDEK', '. Sınıf Yedek Bankası')
                                                                          : `${currentGradeLevel}. Sınıf`);
            }


            if ( (startFromQuestion21Mode && !isYedekBankSelectedForPreview) || isYedekBankSelectedForPreview ) {
                let previewTitleText = "";
                let effectiveStartIndexForPreview = startIndex;
                yedekQuestionsShownCount = 0;

                if (startFromQuestion21Mode && !isYedekBankSelectedForPreview) {
                    previewTitleText = `${gradeDisplayNameForTitle} - Yedek Sorular (${YEDEK_START_INDEX + 1}.den itibaren)`;
                    effectiveStartIndexForPreview = YEDEK_START_INDEX;
                } else {
                    previewTitleText = `${gradeDisplayNameForTitle} Soru Bankası`;
                    effectiveStartIndexForPreview = 0;
                }


                if(mainAppTitle) mainAppTitle.textContent = previewTitleText;
                if(previewTitleDisplay) previewTitleDisplay.textContent = previewTitleText;

                previewQuestions = [...questions];

                if (previewQuestions.length === 0) {
                    alert('Bu soru bankası için soru bulunmuyor. Lütfen admin panelinden soru ekleyin.');
                    showPage('home'); return;
                }
                if (effectiveStartIndexForPreview >= previewQuestions.length) {
                    alert(`Bu soru bankasında ${effectiveStartIndexForPreview + 1}. soru bulunmuyor. Toplam ${previewQuestions.length} soru var.`);
                    showPage('home'); return;
                }

                showPage('quiz-preview');
                if(noPreviewQuestionsMessage) noPreviewQuestionsMessage.style.display = 'none';
                if(previewQuestionContainer) previewQuestionContainer.style.display = 'block';
                if(previewNavigationButtons) previewNavigationButtons.style.display = 'flex';

                if (startFromQuestion21Mode && !isYedekBankSelectedForPreview) {
                    if(previewPreviousQuestionBtn) previewPreviousQuestionBtn.style.display = 'none';
                    if(previewShowAnswerBtn) previewShowAnswerBtn.style.display = 'none';
                    if(previewNextQuestionBtn) previewNextQuestionBtn.style.display = 'none';
                    if(previewNextYedekQuestionBtn) previewNextYedekQuestionBtn.style.display = 'inline-block';
                } else {
                    if(previewPreviousQuestionBtn) previewPreviousQuestionBtn.style.display = 'inline-block';
                    if(previewShowAnswerBtn) previewShowAnswerBtn.style.display = 'inline-block';
                    if(previewNextQuestionBtn) previewNextQuestionBtn.style.display = 'inline-block';
                    if(previewNextYedekQuestionBtn) previewNextYedekQuestionBtn.style.display = 'none';
                }

                currentPreviewQuestionIndex = effectiveStartIndexForPreview;
                loadPreviewQuestion();
                return;
            }

            if(quizTitleDisplay) quizTitleDisplay.textContent = `${gradeDisplayNameForTitle} Bilgi Yarışması`;
            if (questions.length === 0) {
                alert('Bu sınıf düzeyi için soru bulunmuyor. Lütfen admin panelinden soru ekleyin.');
                if (isAdminLoggedIn) showPage('admin-panel'); else showPage('home');
                return;
            }
            if (players.length === 0 && currentUserRole === 'teacher' && isNewStart) {
                 if (!confirm("Bu sınıf için yarışmacı eklenmemiş. Yarışmacısız devam etmek istiyor musunuz (sadece soruları göstermek için)?")) {
                    if (isAdminLoggedIn) showPage('admin-panel'); else showPage('home');
                    return;
                 }
            }

            if (isNewStart) {
                clearQuizState();
                currentQuestionIndex = startIndex;
                unlockedUpToQuestionIndex = startIndex;
                if (!(typeof currentGradeLevel === 'string' && currentGradeLevel.includes('_YEDEK'))) {
                    players.forEach(p => {
                        p.score = 0;
                        initializePlayerAnswersForPlayer(p);
                    });
                }
                timerStartedThisQuestion = false;
                timeLeft = questions[currentQuestionIndex]?.timeLimit || 30;
                savePersistentPlayers();
            } else {
                 const savedStateData = localStorage.getItem(getLocalStorageKey('quizState', currentGradeLevel));
                 if(savedStateData) {
                    const savedState = JSON.parse(savedStateData);
                    currentQuestionIndex = savedState.currentQuestionIndex || 0;
                    unlockedUpToQuestionIndex = savedState.unlockedUpToQuestionIndex || currentQuestionIndex;
                    timerStartedThisQuestion = savedState.timerStartedThisQuestion || false;
                    timeLeft = savedState.timeLeft || (questions[currentQuestionIndex]?.timeLimit || 30);
                 } else {
                    currentQuestionIndex = startIndex;
                    unlockedUpToQuestionIndex = startIndex;
                    timerStartedThisQuestion = false;
                    timeLeft = questions[currentQuestionIndex]?.timeLimit || 30;
                 }
            }

            if (currentQuestionIndex >= questions.length) currentQuestionIndex = 0;

            isQuizInProgress = true;
            isScoreboardVisible = false;
            if(liveScoreboardSection) liveScoreboardSection.style.display = 'none';
            showPage('quiz');
            loadQuestion();
        }


        function initializePlayerAnswersForPlayer(player) {
            player.answers = [];
            const currentQuestionsForGrade = JSON.parse(localStorage.getItem(getLocalStorageKey('questions', currentGradeLevel)) || "[]");
            currentQuestionsForGrade.forEach(q => {
                player.answers.push({
                    questionId: q.id, answerText: '', state: 'pending', points: 0
                });
            });
        }
        function saveQuizState() {
            if (!isQuizInProgress || !currentGradeLevel || (typeof currentGradeLevel === 'string' && currentGradeLevel.includes('_YEDEK'))) return;
            const state = {
                currentQuestionIndex,
                isQuizInProgress: true,
                currentUserRole,
                timerStartedThisQuestion,
                timeLeft,
                unlockedUpToQuestionIndex
            };
            localStorage.setItem(getLocalStorageKey('quizState', currentGradeLevel), JSON.stringify(state));
        }
        function loadQuizStateForAdmin() {
            if (!currentGradeLevel || (typeof currentGradeLevel === 'string' && currentGradeLevel.includes('_YEDEK'))) {
                if(continueQuizBtnContainer) continueQuizBtnContainer.style.display = 'none';
                return;
            }
            const savedStateData = localStorage.getItem(getLocalStorageKey('quizState', currentGradeLevel));
            if (savedStateData) {
                const state = JSON.parse(savedStateData);
                if (state.isQuizInProgress && questions.length > 0 && state.currentUserRole === 'teacher') {
                     if(continueQuizBtnContainer) continueQuizBtnContainer.style.display = 'block';
                     return;
                }
            }
            if(continueQuizBtnContainer) continueQuizBtnContainer.style.display = 'none';
        }
        if (continueQuizBtn) {
            continueQuizBtn.addEventListener('click', () => {
                 if (!currentGradeLevel || !isAdminLoggedIn || (typeof currentGradeLevel === 'string' && currentGradeLevel.includes('_YEDEK'))) return;
                 loadDataForCurrentGrade(true);
                 currentUserRole = 'teacher';
                 startQuizForRole(0, false);
            });
        }
        function clearQuizState() {
            if (!currentGradeLevel || (typeof currentGradeLevel === 'string' && currentGradeLevel.includes('_YEDEK'))) return;
            localStorage.removeItem(getLocalStorageKey('quizState', currentGradeLevel));
            isQuizInProgress = false;
            unlockedUpToQuestionIndex = 0;
            if(continueQuizBtnContainer) continueQuizBtnContainer.style.display = 'none';
        }
        if(teacherShowQuestionBtn){
            teacherShowQuestionBtn.addEventListener('click', () => {
                if (currentUserRole !== 'teacher') return;
                if (questionContainer.style.display === 'none' || questionContainer.style.display === '') {
                    questionContainer.style.display = 'block';
                    if(teacherQuestionActions) teacherQuestionActions.style.display = 'block';
                    teacherShowQuestionBtn.innerHTML = '<i class="fas fa-eye-slash mr-1"></i> Soruyu Gizle';
                    teacherShowQuestionBtn.classList.remove('btn-primary-modern');
                    teacherShowQuestionBtn.classList.add('btn-warning-modern');
                } else {
                    questionContainer.style.display = 'none';
                    if(teacherQuestionActions) teacherQuestionActions.style.display = 'none';
                    if(correctAnswerDisplayArea) correctAnswerDisplayArea.style.display = 'none';
                    teacherShowQuestionBtn.innerHTML = '<i class="fas fa-eye mr-1"></i> Soruyu Göster';
                    teacherShowQuestionBtn.classList.remove('btn-warning-modern');
                    teacherShowQuestionBtn.classList.add('btn-primary-modern');
                }
            });
        }
        function resetQuizAreaForNewQuestion() {
            if(questionContainer) questionContainer.style.display = 'none';
            if(quizQuestionImageEl) quizQuestionImageEl.style.display = 'none';
            if(correctAnswerDisplayArea) correctAnswerDisplayArea.style.display = 'none';
            if(timeEndedMessage) timeEndedMessage.style.display = 'none';
            if(quizControlsAfterAnswers) quizControlsAfterAnswers.style.display = 'block';
            if(teacherControlsWrapper) teacherControlsWrapper.style.display = 'none';
            if(teacherTopControls) teacherTopControls.style.display = 'none';
            if(teacherTimerControls) teacherTimerControls.style.display = 'block';
            if(startTimerManuallyBtn) startTimerManuallyBtn.style.display = 'inline-block';
            if(pauseResumeQuizTimerBtn) pauseResumeQuizTimerBtn.style.display = 'none';
            if(restartQuizTimerBtn) restartQuizTimerBtn.style.display = 'none';
            if(teacherMainActionButtons) teacherMainActionButtons.style.display = 'block';
            if(teacherShowQuestionBtn) {
                teacherShowQuestionBtn.innerHTML = '<i class="fas fa-eye mr-1"></i> Soruyu Göster';
                teacherShowQuestionBtn.classList.remove('btn-warning-modern');
                teacherShowQuestionBtn.classList.add('btn-primary-modern');
                teacherShowQuestionBtn.style.display = 'inline-block';
            }
            if(teacherQuestionActions) teacherQuestionActions.style.display = 'none';
            if(answerInputSectionContainer) answerInputSectionContainer.style.display = 'none';
            if(evaluationControls) evaluationControls.style.display = 'none';
            if(teacherCsvOperationsDiv) teacherCsvOperationsDiv.style.display = 'none'; // YENİ: Öğretmen CSV işlemlerini gizle
            if(teacherCsvMessage) teacherCsvMessage.textContent = ''; // YENİ: Öğretmen CSV mesajını temizle
            if(allAnswersRecordedMessageDynamic) allAnswersRecordedMessageDynamic.style.display = 'none';

            clearInterval(questionTimerInterval);
            if (countdownSound && !countdownSound.paused) { countdownSound.pause(); countdownSound.currentTime = 0; }
            if (timeUpSound && !timeUpSound.paused) { timeUpSound.pause(); timeUpSound.currentTime = 0; }
        }

        function loadQuestion() {
             if (!isQuizInProgress || currentQuestionIndex >= questions.length) {
                if (isQuizInProgress && !(typeof currentGradeLevel === 'string' && currentGradeLevel.includes('_YEDEK')) && currentUserRole === 'teacher') {
                    showResults();
                } else if (isQuizInProgress && currentUserRole === 'student') {
                    alert("Yarışma bitti. Ana sayfaya yönlendiriliyorsunuz.");
                    showPage('home');
                    clearQuizState();
                } else if (isQuizInProgress) {
                     showPage('home');
                }
                return;
            }
            const currentQuestion = questions[currentQuestionIndex];
            if (!currentQuestion) {
                console.error(`Soru yüklenemedi: index ${currentQuestionIndex}, toplam soru ${questions.length}`);
                if (isQuizInProgress && !(typeof currentGradeLevel === 'string' && currentGradeLevel.includes('_YEDEK'))) showResults();
                else showPage('home');
                return;
            }
            resetQuizAreaForNewQuestion();

            const sectionInfo = getSectionInfoForQuestion(currentQuestionIndex);
            if(globalQuestionInfoDisplay) globalQuestionInfoDisplay.innerHTML = `<span class="badge bg-secondary text-white">Soru: ${currentQuestionIndex + 1} / ${questions.length}</span>`;
            if(sectionQuestionInfoDisplay) sectionQuestionInfoDisplay.innerHTML = `<span class="badge bg-primary text-white">Bölüm (${sectionInfo.name}): ${sectionInfo.num} / ${sectionInfo.total}</span>`;
            if(quizQuestionNumberEl) quizQuestionNumberEl.textContent = `${currentQuestionIndex + 1}.`;
            if(quizQuestionTextEl) quizQuestionTextEl.innerHTML = currentQuestion.text;
            if(quizQuestionImageEl) {
                quizQuestionImageEl.style.display = currentQuestion.image ? 'block' : 'none';
                if (currentQuestion.image) quizQuestionImageEl.src = currentQuestion.image;
            }

            if(previousQuestionBtn) {
                let canGoBack = false;
                if (currentUserRole === 'teacher') {
                    canGoBack = currentQuestionIndex > 0 && evaluationControls.style.display === 'none';
                } else {
                    canGoBack = currentQuestionIndex > 0;
                }
                previousQuestionBtn.style.display = canGoBack ? 'inline-block' : 'none';
                previousQuestionBtn.disabled = !canGoBack;
            }


            if (currentUserRole === 'teacher') {
                if(teacherControlsWrapper) teacherControlsWrapper.style.display = 'block';
                if(teacherTopControls) teacherTopControls.style.display = 'block';
                if(timerDisplay) {
                    timerDisplay.textContent = timeLeft.toString().padStart(2, '0');
                    timerDisplay.className = "";
                }
                if (timerStartedThisQuestion && !timerPausedThisQuestion && timeLeft > 0) {
                    if(startTimerManuallyBtn) startTimerManuallyBtn.style.display = 'none';
                    if(pauseResumeQuizTimerBtn) {
                        pauseResumeQuizTimerBtn.innerHTML = '<i class="fas fa-pause mr-1"></i>Duraklat';
                        pauseResumeQuizTimerBtn.classList.remove('btn-success-modern');
                        pauseResumeQuizTimerBtn.classList.add('btn-warning-modern');
                        pauseResumeQuizTimerBtn.style.display = 'inline-block';
                    }
                    if(restartQuizTimerBtn) restartQuizTimerBtn.style.display = 'inline-block';
                    runQuizAreaTimer();
                } else if (timerStartedThisQuestion && timerPausedThisQuestion) {
                    if(startTimerManuallyBtn) startTimerManuallyBtn.style.display = 'none';
                     if(pauseResumeQuizTimerBtn) {
                        pauseResumeQuizTimerBtn.innerHTML = '<i class="fas fa-play mr-1"></i>Devam Et';
                        pauseResumeQuizTimerBtn.classList.remove('btn-warning-modern');
                        pauseResumeQuizTimerBtn.classList.add('btn-success-modern');
                        pauseResumeQuizTimerBtn.style.display = 'inline-block';
                    }
                    if(restartQuizTimerBtn) restartQuizTimerBtn.style.display = 'inline-block';
                    if(timerDisplay) timerDisplay.classList.add('paused');
                } else {
                    if(startTimerManuallyBtn) startTimerManuallyBtn.style.display = (timeLeft > 0) ? 'inline-block' : 'none';
                    if(pauseResumeQuizTimerBtn) pauseResumeQuizTimerBtn.style.display = 'none';
                    if(restartQuizTimerBtn) restartQuizTimerBtn.style.display = (timeLeft <= 0 && timerStartedThisQuestion) ? 'inline-block' : 'none';
                     if(timeLeft <=0 && timerDisplay) timerDisplay.classList.add('ended');
                }
                if(nextQuestionProceedBtn) nextQuestionProceedBtn.disabled = evaluationControls.style.display === 'block';
            } else if (currentUserRole === 'student') {
                if(teacherControlsWrapper) teacherControlsWrapper.style.display = 'none';
                if(questionContainer) questionContainer.style.display = 'block';
                if(teacherQuestionActions) teacherQuestionActions.style.display = 'none';
                if(correctAnswerDisplayArea) correctAnswerDisplayArea.style.display = 'none';
                if(nextQuestionProceedBtn) nextQuestionProceedBtn.disabled = false;
                if(teacherTimerControls) teacherTimerControls.style.display = 'none';
            }
            renderQuestionNavigationButtons();
            saveQuizState();
            if (!(typeof currentGradeLevel === 'string' && currentGradeLevel.includes('_YEDEK')) && currentUserRole === 'teacher') {
                savePersistentPlayers();
            }
        }
        function getSectionInfoForQuestion(globalIndex) {
            if (globalIndex < 0 || globalIndex >= questions.length) return { name: "Bilinmiyor", num: 0, total: 0 };
            const currentQ = questions[globalIndex];
            const sectionName = currentQ.section || "Genel";
            let sectionNum = 0; let sectionTotal = 0;
            for (let i = 0; i < questions.length; i++) {
                if ((questions[i].section || "Genel") === sectionName) {
                    sectionTotal++;
                    if (i <= globalIndex) {
                         sectionNum++;
                    }
                }
            }
            return { name: sectionName, num: sectionNum, total: sectionTotal };
        }
        if (startTimerManuallyBtn) { startTimerManuallyBtn.addEventListener('click', () => {
            if (currentUserRole !== 'teacher' || timerStartedThisQuestion || timeLeft <= 0) return;
                timerStartedThisQuestion = true;
                timerPausedThisQuestion = false;
                startTimerManuallyBtn.style.display = 'none';
                if(pauseResumeQuizTimerBtn) {
                    pauseResumeQuizTimerBtn.innerHTML = '<i class="fas fa-pause mr-1"></i>Duraklat';
                    pauseResumeQuizTimerBtn.classList.remove('btn-success-modern');
                    pauseResumeQuizTimerBtn.classList.add('btn-warning-modern');
                    pauseResumeQuizTimerBtn.style.display = 'inline-block';
                }
                if(restartQuizTimerBtn) restartQuizTimerBtn.style.display = 'inline-block';
                runQuizAreaTimer();
                saveQuizState();
        }); }
        if(pauseResumeQuizTimerBtn){ pauseResumeQuizTimerBtn.addEventListener('click', function() {
            if (currentUserRole !== 'teacher' || !timerStartedThisQuestion || timeLeft <= 0) return;
                timerPausedThisQuestion = !timerPausedThisQuestion;
                if (timerPausedThisQuestion) {
                    clearInterval(questionTimerInterval);
                    if (countdownSound && !countdownSound.paused) countdownSound.pause();
                    if (timeUpSound && !timeUpSound.paused) timeUpSound.pause();
                    this.innerHTML = '<i class="fas fa-play mr-1"></i>Devam Et';
                    this.classList.remove('btn-warning-modern'); this.classList.add('btn-success-modern');
                    if(timerDisplay && timeLeft > 0) {timerDisplay.classList.remove('running', 'ending'); timerDisplay.classList.add('paused');}
                    if(restartQuizTimerBtn) restartQuizTimerBtn.style.display = 'inline-block';
                } else {
                    this.innerHTML = '<i class="fas fa-pause mr-1"></i>Duraklat';
                    this.classList.remove('btn-success-modern'); this.classList.add('btn-warning-modern');
                    if(timerDisplay) timerDisplay.classList.remove('paused');
                    if(restartQuizTimerBtn) restartQuizTimerBtn.style.display = 'inline-block';
                    runQuizAreaTimer();
                }
                saveQuizState();
        }); }

        if (restartQuizTimerBtn) {
            restartQuizTimerBtn.addEventListener('click', () => {
                if (currentUserRole !== 'teacher' || !timerStartedThisQuestion || !questions[currentQuestionIndex]) return;

                clearInterval(questionTimerInterval);
                if (countdownSound && !countdownSound.paused) { countdownSound.pause(); countdownSound.currentTime = 0; }
                if (timeUpSound && !timeUpSound.paused) { timeUpSound.pause(); timeUpSound.currentTime = 0; }

                timeLeft = questions[currentQuestionIndex].timeLimit || 30;
                timerPausedThisQuestion = false;

                if (timerDisplay) {
                    timerDisplay.textContent = timeLeft.toString().padStart(2, '0');
                    timerDisplay.className = "";
                }
                if (timeEndedMessage) timeEndedMessage.style.display = 'none';

                if (startTimerManuallyBtn) startTimerManuallyBtn.style.display = 'none';
                if (pauseResumeQuizTimerBtn) {
                    pauseResumeQuizTimerBtn.innerHTML = '<i class="fas fa-pause mr-1"></i>Duraklat';
                    pauseResumeQuizTimerBtn.classList.remove('btn-success-modern');
                    pauseResumeQuizTimerBtn.classList.add('btn-warning-modern');
                    pauseResumeQuizTimerBtn.style.display = 'inline-block';
                }
                runQuizAreaTimer();
                saveQuizState();
            });
        }


        function runQuizAreaTimer() {
            clearInterval(questionTimerInterval);
            if (timeLeft <= 0) return;

            if (timerDisplay) {
                timerDisplay.classList.remove('ended', 'paused');
                timerDisplay.classList.add('running');
            }

            if (timeLeft > 10) {
                if (timeUpSound && !timeUpSound.paused) { timeUpSound.pause(); timeUpSound.currentTime = 0; }
                playSound(countdownSound);
            } else if (timeLeft > 0 && timeLeft <= 10) {
                if (countdownSound && !countdownSound.paused) { countdownSound.pause(); countdownSound.currentTime = 0; }
                if (timeUpSound && timeUpSound.paused && soundEffectsEnabled) {
                    playSound(timeUpSound);
                }
                if(timerDisplay && !timerDisplay.classList.contains('ending')) timerDisplay.classList.add('ending');
            }


            questionTimerInterval = setInterval(() => {
                if (timerPausedThisQuestion) {
                    return;
                }
                timeLeft--;
                if (timerDisplay) timerDisplay.textContent = timeLeft.toString().padStart(2, '0');

                if (timeLeft <= 0) {
                    clearInterval(questionTimerInterval);
                    if (countdownSound && !countdownSound.paused) { countdownSound.pause(); countdownSound.currentTime = 0;}
                    if (timeUpSound && !timeUpSound.paused) { timeUpSound.pause(); timeUpSound.currentTime = 0; }
                    if (timerDisplay) {
                        timerDisplay.classList.remove('running', 'ending', 'paused');
                        timerDisplay.classList.add('ended');
                    }
                    if (timeEndedMessage) timeEndedMessage.style.display = 'block';
                    if (pauseResumeQuizTimerBtn) pauseResumeQuizTimerBtn.style.display = 'none';
                    if (startTimerManuallyBtn) startTimerManuallyBtn.style.display = 'none';
                    if (restartQuizTimerBtn) restartQuizTimerBtn.style.display = 'inline-block';
                } else if (timeLeft <= 10 && timeLeft > 0) {
                    if (countdownSound && !countdownSound.paused) {
                        countdownSound.pause(); countdownSound.currentTime = 0;
                    }
                    if (timeUpSound && timeUpSound.paused && soundEffectsEnabled) {
                         playSound(timeUpSound);
                    }
                    if (timerDisplay && !timerDisplay.classList.contains('ending')) timerDisplay.classList.add('ending');
                } else {
                    if (timeUpSound && !timeUpSound.paused) {
                        timeUpSound.pause(); timeUpSound.currentTime = 0;
                    }
                    playSound(countdownSound);
                    if (timerDisplay) timerDisplay.classList.remove('ending');
                    if (restartQuizTimerBtn) restartQuizTimerBtn.style.display = 'inline-block';
                }
                saveQuizState();
            }, 1000);
        }

        if(teacherShowCorrectAnswerBtn){ teacherShowCorrectAnswerBtn.addEventListener('click', () => {
            if (currentUserRole !== 'teacher') return;
                if (questionContainer.style.display === 'none' || questionContainer.style.display === '') {
                    alert("Önce soruyu gösterin.");
                    return;
                }
                const currentQuestion = questions[currentQuestionIndex];
                if(correctAnswerDisplayText) correctAnswerDisplayText.innerHTML = currentQuestion.correctAnswerTexts.join(' / ');
                if(correctAnswerDisplayArea) correctAnswerDisplayArea.style.display = 'block';
                if(nextQuestionProceedBtn) nextQuestionProceedBtn.disabled = false;
                 if(previousQuestionBtn && currentQuestionIndex > 0) previousQuestionBtn.disabled = false;
        }); }
        if(showAnswerBtn) { showAnswerBtn.addEventListener('click', () => {
            if (currentUserRole !== 'teacher') return;
             if (questionContainer.style.display === 'none' || questionContainer.style.display === '') {
                alert("Cevapları almak için önce soruyu göstermelisiniz.");
                return;
            }
            timerPausedThisQuestion = true;
            clearInterval(questionTimerInterval);
            if (countdownSound && !countdownSound.paused) { countdownSound.pause(); }
            if (timeUpSound && !timeUpSound.paused) { timeUpSound.pause(); }

            if(pauseResumeQuizTimerBtn && pauseResumeQuizTimerBtn.style.display !== 'none') {
                 pauseResumeQuizTimerBtn.innerHTML = '<i class="fas fa-play mr-1"></i>Devam Et';
                 pauseResumeQuizTimerBtn.classList.remove('btn-warning-modern');
                 pauseResumeQuizTimerBtn.classList.add('btn-success-modern');
                 if(timerDisplay && timeLeft > 0) timerDisplay.classList.add('paused');
            }
            if(restartQuizTimerBtn) restartQuizTimerBtn.style.display = 'inline-block';
            saveQuizState();

            if(answerInputSectionContainer) {
                answerInputSectionContainer.style.display = 'block';
                answerInputSectionContainer.innerHTML = '';
            }
            if(teacherCsvMessage) teacherCsvMessage.textContent = ''; // Clear previous CSV messages

            if (players.length === 0) {
                if(answerInputSectionContainer) answerInputSectionContainer.innerHTML = '<p class="text-center text-muted">Değerlendirilecek yarışmacı bulunmuyor.</p>';
                if(evaluationControls) evaluationControls.style.display = 'none';
                if(teacherCsvOperationsDiv) teacherCsvOperationsDiv.style.display = 'none'; // YENİ
                if(nextQuestionProceedBtn) nextQuestionProceedBtn.disabled = false;
                 if(previousQuestionBtn && currentQuestionIndex > 0) previousQuestionBtn.disabled = false;
                return;
            }

            if(teacherCsvOperationsDiv) teacherCsvOperationsDiv.style.display = 'block'; // YENİ: CSV butonlarını göster
            if(evaluationControls) evaluationControls.style.display = 'block'; // YENİ: Değerlendirme butonunu göster (asıl kaydetme)

            const playerAnswerList = document.createElement('div');
            playerAnswerList.className = 'list-group col-lg-10 offset-lg-1 col-md-12 mt-3';
            if(answerInputSectionContainer) answerInputSectionContainer.appendChild(playerAnswerList);
            const currentQuestionData = questions[currentQuestionIndex];
            players.forEach(player => {
                let playerAnswerForThisQ = player.answers.find(ans => ans.questionId === currentQuestionData.id);
                if (!playerAnswerForThisQ) {
                    playerAnswerForThisQ = { questionId: currentQuestionData.id, answerText: '', state: 'pending', points: 0 };
                    if(!player.answers) player.answers = [];
                    player.answers.push(playerAnswerForThisQ);
                }
                const playerRowDiv = document.createElement('div');
                playerRowDiv.className = 'player-answer-row-openended animate__animated animate__fadeInUp';
                playerRowDiv.id = `player-answer-row-${player.id}`;
                const playerInfoLine = document.createElement('div');
                playerInfoLine.className = 'player-info-line';
                const playerNameSpan = document.createElement('span');
                playerNameSpan.innerHTML = `<i class="fas fa-user mr-2"></i>${player.name}`;
                playerInfoLine.appendChild(playerNameSpan);
                const adminDecisionButtons = document.createElement('div');
                adminDecisionButtons.className = 'btn-group admin-decision-buttons';
                const correctButton = document.createElement('button');
                correctButton.className = 'btn btn-outline-success btn-modern btn-sm py-1 px-2';
                correctButton.innerHTML = '<i class="fas fa-check mr-1"></i> Doğru';
                correctButton.dataset.playerId = player.id; correctButton.dataset.decision = 'correct';
                const incorrectButton = document.createElement('button');
                incorrectButton.className = 'btn btn-outline-danger btn-modern btn-sm py-1 px-2 ml-2';
                incorrectButton.innerHTML = '<i class="fas fa-times mr-1"></i> Yanlış';
                incorrectButton.dataset.playerId = player.id; incorrectButton.dataset.decision = 'incorrect';
                if (playerAnswerForThisQ.state === 'correct') {
                    correctButton.classList.remove('btn-outline-success');
                    correctButton.classList.add('btn-success-modern', 'active');
                } else if (playerAnswerForThisQ.state === 'incorrect') {
                    incorrectButton.classList.remove('btn-outline-danger');
                    incorrectButton.classList.add('btn-danger-modern', 'active');
                }
                correctButton.onclick = evaluatePlayerAnswer;
                incorrectButton.onclick = evaluatePlayerAnswer;
                adminDecisionButtons.appendChild(correctButton);
                adminDecisionButtons.appendChild(incorrectButton);
                playerInfoLine.appendChild(adminDecisionButtons);
                playerRowDiv.appendChild(playerInfoLine);
                const answerTextarea = document.createElement('textarea');
                answerTextarea.className = 'form-control form-control-modern player-answer-textarea';
                answerTextarea.placeholder = `${player.name} için cevap girin`;
                answerTextarea.dataset.playerId = player.id;
                answerTextarea.value = playerAnswerForThisQ.answerText || '';
                answerTextarea.rows = 2;
                answerTextarea.oninput = (e) => {
                    const pId = parseInt(e.target.dataset.playerId);
                    const p = players.find(pl => pl.id === pId);
                    const qId = questions[currentQuestionIndex].id;
                    if (p) {
                        let ansEntry = p.answers.find(a => a.questionId === qId);
                        if (ansEntry) {
                            ansEntry.answerText = e.target.value;
                        } else {
                            p.answers.push({ questionId: qId, answerText: e.target.value, state: 'pending', points: 0 });
                        }
                    }
                };
                playerRowDiv.appendChild(answerTextarea);
                playerAnswerList.appendChild(playerRowDiv);
            });
            updateScoreboard(false);
            if(nextQuestionProceedBtn) nextQuestionProceedBtn.disabled = true;
            if(previousQuestionBtn) previousQuestionBtn.disabled = true;
        }); }

        function evaluatePlayerAnswer(event) {
            const clickedButton = event.target.closest('button');
            if (!clickedButton) return;
            const playerId = parseInt(clickedButton.dataset.playerId);
            const decision = clickedButton.dataset.decision;
            const player = players.find(p => p.id === playerId);
            if (!player) return;
            const currentQuestionId = questions[currentQuestionIndex].id;
            let playerAnswerForThisQ = player.answers.find(ans => ans.questionId === currentQuestionId);
            if (!playerAnswerForThisQ) return;

            const playerRowButtons = document.querySelectorAll(`#player-answer-row-${playerId} .admin-decision-buttons button`);
            playerRowButtons.forEach(btn => {
                btn.classList.remove('active', 'btn-success-modern', 'btn-danger-modern');
                if (btn.dataset.decision === 'correct') btn.classList.add('btn-outline-success');
                else btn.classList.add('btn-outline-danger');
            });

            if (playerAnswerForThisQ.state === decision) {
                playerAnswerForThisQ.state = 'pending';
                playerAnswerForThisQ.points = 0;
            } else {
                playerAnswerForThisQ.state = decision;
                if (decision === 'correct') {
                    playerAnswerForThisQ.points = CORRECT_ANSWER_POINTS;
                    clickedButton.classList.remove('btn-outline-success');
                    clickedButton.classList.add('btn-success-modern', 'active');
                    playSound(correctAnswerSound);
                } else {
                    playerAnswerForThisQ.points = 0;
                    clickedButton.classList.remove('btn-outline-danger');
                    clickedButton.classList.add('btn-danger-modern', 'active');
                    playSound(incorrectAnswerSound);
                }
            }
        }


        if(evaluateSaveBtn) { evaluateSaveBtn.addEventListener('click', () => {
            if (currentUserRole !== 'teacher') return;
                players.forEach(player => {
                    player.score = player.answers.reduce((total, ans) => total + (ans.points || 0), 0);
                });
                savePersistentPlayers();
                saveQuizState();
                alert("Değerlendirmeler kaydedildi!");
                if(nextQuestionProceedBtn) nextQuestionProceedBtn.disabled = false;
                if(previousQuestionBtn && currentQuestionIndex > 0) previousQuestionBtn.disabled = false;
                if(allAnswersRecordedMessageDynamic) allAnswersRecordedMessageDynamic.style.display = 'block';
                if(evaluationControls) evaluationControls.style.display = 'none';
                if(teacherCsvOperationsDiv) teacherCsvOperationsDiv.style.display = 'none'; // YENİ: CSV butonlarını gizle
                if(teacherCsvMessage) teacherCsvMessage.textContent = ''; // YENİ: CSV mesajını temizle
                updateScoreboard(isScoreboardVisible);
        }); }
        if(showScoresHeaderBtn) { showScoresHeaderBtn.addEventListener('click', () => {
            if (quizArea.style.display !== 'block' && resultsArea.style.display !== 'block') {
                     alert("Puan tablosu sadece yarışma sırasında veya sonunda görüntülenebilir.");
                     return;
                 }
                isScoreboardVisible = !isScoreboardVisible;
                if (liveScoreboardSection) {
                    if (isScoreboardVisible) {
                        updateScoreboard(true);
                        liveScoreboardSection.classList.remove('animate__fadeOutDown');
                        liveScoreboardSection.classList.add('animate__animated', 'animate__fadeInUp');
                        liveScoreboardSection.scrollIntoView({ behavior: 'smooth' });
                    } else {
                        liveScoreboardSection.classList.remove('animate__fadeInUp');
                        liveScoreboardSection.classList.add('animate__animated', 'animate__fadeOutDown');
                         setTimeout(() => { if(!isScoreboardVisible && liveScoreboardSection) liveScoreboardSection.style.display = 'none';}, 500);
                    }
                }
        }); }

        if(nextQuestionProceedBtn){
            nextQuestionProceedBtn.addEventListener('click', () => {
                 if (evaluationControls.style.display === 'block'){ // hala değerlendirme kaydedilmemişse
                    alert("Lütfen önce mevcut değerlendirmeyi kaydedin.");
                    return;
                 }
                 // YENİ: Değerlendirme kaydedildikten sonra CSV butonları gizlenmiş olmalı.
                 // Bu kontrol gereksiz olabilir ama zararı olmaz.
                 if (teacherCsvOperationsDiv && teacherCsvOperationsDiv.style.display === 'block') {
                     teacherCsvOperationsDiv.style.display = 'none';
                     if(teacherCsvMessage) teacherCsvMessage.textContent = '';
                 }

                if (currentQuestionIndex >= questions.length - 1) {
                    proceedToNextQuestionActual();
                    return;
                }

                const currentQ = questions[currentQuestionIndex];
                const requiredPasswordForNext = currentQ.nextQuestionPassword;

                if (currentUserRole === 'teacher' || !requiredPasswordForNext || requiredPasswordForNext.trim() === "") {
                    proceedToNextQuestionActual();
                } else {
                    showPasswordPromptModal(
                        `Sonraki soruya (Soru ${currentQuestionIndex + 2}) geçmek için şifreyi girin:`,
                        requiredPasswordForNext,
                        () => {
                            proceedToNextQuestionActual();
                        }
                    );
                }
            });
        }


        if(previousQuestionBtn) {
            previousQuestionBtn.addEventListener('click', () => {
                 if (currentQuestionIndex <= 0) return;
                 if (currentUserRole === 'teacher' && evaluationControls.style.display === 'block'){
                    alert("Lütfen önce mevcut değerlendirmeyi kaydedin.");
                    return;
                 }
                 // YENİ: CSV butonlarını da gizle
                  if (teacherCsvOperationsDiv && teacherCsvOperationsDiv.style.display === 'block') {
                     teacherCsvOperationsDiv.style.display = 'none';
                     if(teacherCsvMessage) teacherCsvMessage.textContent = '';
                 }

                 currentQuestionIndex--;
                 timeLeft = questions[currentQuestionIndex]?.timeLimit || 30;
                 timerStartedThisQuestion = false;
                 timerPausedThisQuestion = false;
                 loadQuestion();
            });
        }

        function proceedToNextQuestionActual() {
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                unlockedUpToQuestionIndex = Math.max(unlockedUpToQuestionIndex, currentQuestionIndex);
                timeLeft = questions[currentQuestionIndex]?.timeLimit || 30;
                timerStartedThisQuestion = false;
                timerPausedThisQuestion = false;
                loadQuestion();
            } else {
                if (currentUserRole === 'student') {
                    alert("Yarışma bitti! Ana sayfaya yönlendiriliyorsunuz.");
                    showPage('home');
                    clearQuizState();
                } else if (typeof currentGradeLevel === 'string' && currentGradeLevel.includes('_YEDEK')) {
                    if (isAdminLoggedIn) showPage('admin-panel'); else showPage('home');
                } else {
                    showResults();
                }
            }
        }
        function updateScoreboardHeaders(theadElement) {
            theadElement.innerHTML = '';
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <th class="rank">Sıra</th>
                <th class="player-name">Yarışmacı</th>
            `;
            questions.forEach((q, index) => {
                const th = document.createElement('th');
                th.className = 'question-header-cell';
                th.textContent = `S${index + 1}`;
                th.title = q.text.substring(0,30) + (q.text.length > 30 ? '...' : '');
                tr.appendChild(th);
            });
            tr.innerHTML += `<th class="player-score">Toplam Puan</th>`;
            theadElement.appendChild(tr);
        }
        function updateScoreboard(forceShow = false) {
             if (!playerScoresTbody || !playerScoresThead || (typeof currentGradeLevel === 'string' && currentGradeLevel.includes('_YEDEK'))) {
                if(liveScoreboardSection) liveScoreboardSection.style.display = 'none';
                return;
            }
            if (players.length === 0 && currentUserRole !== 'student') {
                if(liveScoreboardSection) liveScoreboardSection.style.display = 'none';
                isScoreboardVisible = false;
                return;
            } else if (currentUserRole === 'student') {
                 if(liveScoreboardSection) liveScoreboardSection.style.display = 'none';
                 isScoreboardVisible = false;
                 return;
            }

            updateScoreboardHeaders(playerScoresThead);
            playerScoresTbody.innerHTML = '';
            const tempPlayers = players.map(p => {
                const currentTotalScore = p.answers.reduce((total, ans) => total + (ans.points || 0), 0);
                return {...p, score: currentTotalScore};
            });


            const sortedPlayers = [...tempPlayers].sort((a, b) => b.score - a.score || a.name.localeCompare(b.name));
            let rank = 0; let lastScore = -Infinity; let actualRank = 0;
            sortedPlayers.forEach((player) => {
                actualRank++; if (player.score !== lastScore) rank = actualRank; lastScore = player.score;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="rank">${rank}</td>
                    <td class="player-name">${player.name}</td>
                `;
                questions.forEach(q_ref => {
                    const td = document.createElement('td');
                    td.className = 'question-score-cell';
                    const playerAnswer = player.answers.find(ans => ans.questionId === q_ref.id);
                    if (playerAnswer) {
                        if (playerAnswer.state === 'correct') {
                            td.innerHTML = `<i class="fas fa-check text-success" title="${playerAnswer.points} puan"></i>`;
                        } else if (playerAnswer.state === 'incorrect') {
                            td.innerHTML = `<i class="fas fa-times text-danger" title="0 puan"></i>`;
                        } else {
                            td.textContent = '-';
                        }
                    } else {
                        td.textContent = '-';
                    }
                    tr.appendChild(td);
                });
                tr.innerHTML += `<td class="player-score">${player.score}</td>`;
                if (rank === 1) tr.classList.add('rank-1');
                else if (rank === 2) tr.classList.add('rank-2');
                else if (rank === 3) tr.classList.add('rank-3');
                playerScoresTbody.appendChild(tr);
            });
            if (forceShow && liveScoreboardSection && isScoreboardVisible) {
                liveScoreboardSection.style.display = 'block';
                 if (!liveScoreboardSection.classList.contains('animate__fadeInUp')) {
                    liveScoreboardSection.classList.remove('animate__fadeOutDown');
                    liveScoreboardSection.classList.add('animate__animated', 'animate__fadeInUp');
                }
            }
        }
        function showResults() {
            if (typeof currentGradeLevel === 'string' && currentGradeLevel.includes('_YEDEK')) {
                if (isAdminLoggedIn) showPage('admin-panel'); else showPage('home');
                return;
            }
            if (currentUserRole === 'student') {
                alert("Yarışma bitti! Ana sayfaya yönlendiriliyorsunuz.");
                showPage('home');
                clearQuizState();
                return;
            }

            showPage('results');
            isQuizInProgress = false;
            clearQuizState();
            let gradeDisplayNameForResult = "";
             if (isAdminLoggedIn && adminGradeLevelSelect && adminGradeLevelSelect.options[adminGradeLevelSelect.selectedIndex] && String(adminGradeLevelSelect.value) === String(currentGradeLevel)) {
                gradeDisplayNameForResult = adminGradeLevelSelect.options[adminGradeLevelSelect.selectedIndex].text;
            } else {
                const tempGradeBtn = Array.from(gradeButtonsContainer.children).find(btn => btn.dataset.grade === String(currentGradeLevel));
                gradeDisplayNameForResult = tempGradeBtn ? tempGradeBtn.textContent : ( (typeof currentGradeLevel === 'string' && currentGradeLevel.includes("_YEDEK")) ? String(currentGradeLevel).replace('_YEDEK', '. Sınıf Yedek Bankası') : `${currentGradeLevel}. Sınıf`);
            }


            if(finalQuizTitleDisplay) finalQuizTitleDisplay.textContent = `${gradeDisplayNameForResult} Bilgi Yarışması - Sonuçlar`;
            if(mainAppTitle) mainAppTitle.textContent = `${gradeDisplayNameForResult} Bilgi Yarışması - Sonuçlar`;

            updateScoreboardHeaders(finalPlayerScoresThead);
            if(finalPlayerScoresTbody) finalPlayerScoresTbody.innerHTML = '';
            const finalPlayers = players.map(p => {
                const finalScore = p.answers.reduce((total, ans) => total + (ans.points || 0), 0);
                return {...p, score: finalScore};
            });

            const sortedPlayers = [...finalPlayers].sort((a, b) => b.score - a.score || a.name.localeCompare(b.name));
            let winners = [];
            let highestScore = -Infinity;
            if (sortedPlayers.length > 0) {
                highestScore = sortedPlayers[0].score;
                if (highestScore >= 0) { // Allow 0 score winners if that's the highest
                    winners = sortedPlayers.filter(p => p.score === highestScore);
                }
            }
            if(winnerNamesEl) winnerNamesEl.textContent = winners.length > 0 ? winners.map(w => w.name).join(', ') : (players.length > 0 ? "Kazanan Yok" : "Yarışmacı Yok");
            let rank = 0; let lastScoreVal = -Infinity; let actualRank = 0;
            sortedPlayers.forEach((player) => {
                actualRank++; if (player.score !== lastScoreVal) rank = actualRank; lastScoreVal = player.score;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="rank">${rank}</td>
                    <td class="player-name">${player.name}</td>
                `;
                questions.forEach(q_ref => {
                    const td = document.createElement('td');
                    td.className = 'question-score-cell';
                    const playerAnswer = player.answers.find(ans => ans.questionId === q_ref.id);
                    if (playerAnswer) {
                        if (playerAnswer.state === 'correct') {
                            td.innerHTML = `<i class="fas fa-check text-success" title="${playerAnswer.points} puan"></i>`;
                        } else if (playerAnswer.state === 'incorrect') {
                            td.innerHTML = `<i class="fas fa-times text-danger" title="0 puan"></i>`;
                        } else {
                            td.textContent = '-';
                        }
                    } else {
                        td.textContent = '-';
                    }
                    tr.appendChild(td);
                });
                tr.innerHTML += `<td class="player-score">${player.score}</td>`;
                if (rank === 1 && winners.some(w => w.id === player.id)) tr.classList.add('rank-1');
                else if (rank === 2) tr.classList.add('rank-2');
                else if (rank === 3) tr.classList.add('rank-3');
                if(finalPlayerScoresTbody) finalPlayerScoresTbody.appendChild(tr);
            });
            playSound(quizEndApplauseSound);
        }
        if (backToHomeFromResultsBtn) { backToHomeFromResultsBtn.addEventListener('click', () => {
             showPage('home');
            if (countdownSound && !countdownSound.paused) { countdownSound.pause(); countdownSound.currentTime = 0; }
            if (timeUpSound && !timeUpSound.paused) { timeUpSound.pause(); timeUpSound.currentTime = 0; }
            if (quizEndApplauseSound && !quizEndApplauseSound.paused) { quizEndApplauseSound.pause(); quizEndApplauseSound.currentTime = 0; }
        }); }
        function showPasswordPromptModal(message, expectedPassword, callbackOnSuccess) {
            passwordPromptMessage.textContent = message;
            modalPasswordInput.value = '';
            modalPasswordError.style.display = 'none';
            passwordModalCallback = { expected: expectedPassword, success: callbackOnSuccess };
            passwordPromptModal.modal('show');
        }
        if(modalPasswordSubmitBtn) {
             modalPasswordSubmitBtn.addEventListener('click', () => {
                if (!passwordModalCallback) return;
                const enteredPassword = modalPasswordInput.value;
                if (enteredPassword === passwordModalCallback.expected) {
                    passwordPromptModal.modal('hide');
                    if (passwordModalCallback.success) passwordModalCallback.success();
                } else {
                    modalPasswordError.style.display = 'block';
                }
                passwordModalCallback = null;
            });
        }
       if(modalPasswordInput){
            modalPasswordInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    if(modalPasswordSubmitBtn) modalPasswordSubmitBtn.click();
                }
            });
       }
        function loadHomeBackgroundImage() {
            const imageDataUrl = localStorage.getItem(HOME_BACKGROUND_IMAGE_KEY);
            if (imageDataUrl && homeBackgroundImageDisplay) {
                homeBackgroundImageDisplay.src = imageDataUrl;
                homeBackgroundImageDisplay.style.display = 'block';
            } else if (homeBackgroundImageDisplay) {
                homeBackgroundImageDisplay.style.display = 'none';
                homeBackgroundImageDisplay.src = '#';
            }
            if (isAdminLoggedIn && homeBackgroundImagePreview) {
                 if (imageDataUrl) {
                    homeBackgroundImagePreview.src = imageDataUrl;
                    homeBackgroundImagePreview.style.display = 'block';
                } else {
                    homeBackgroundImagePreview.style.display = 'none';
                    homeBackgroundImagePreview.src = '#';
                }
            }
        }
        if (homeBackgroundImageInput) { homeBackgroundImageInput.addEventListener('change', function(event) {
            if (!isAdminLoggedIn) return;
            const file = event.target.files[0];
            if (file && homeBackgroundImagePreview) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    homeBackgroundImagePreview.src = e.target.result;
                    homeBackgroundImagePreview.style.display = 'block';
                }
                reader.readAsDataURL(file);
            } else if (homeBackgroundImagePreview) {
                homeBackgroundImagePreview.src = '#';
                homeBackgroundImagePreview.style.display = 'none';
            }
        }); }
        if (saveHomeBackgroundBtn) { saveHomeBackgroundBtn.addEventListener('click', () => {
            if (!isAdminLoggedIn) return;
            if (homeBackgroundImagePreview && homeBackgroundImagePreview.src !== '#' && homeBackgroundImagePreview.style.display !== 'none' && homeBackgroundImagePreview.src.startsWith('data:image')) {
                try {
                    localStorage.setItem(HOME_BACKGROUND_IMAGE_KEY, homeBackgroundImagePreview.src);
                    if (homeBackgroundMessage) {
                        homeBackgroundMessage.textContent = 'Arka plan resmi başarıyla kaydedildi.';
                        homeBackgroundMessage.className = 'mt-2 text-success';
                    }
                    loadHomeBackgroundImage();
                } catch (e) {
                    if (homeBackgroundMessage) {
                        homeBackgroundMessage.textContent = 'Resim kaydedilemedi. Boyutu çok büyük olabilir veya localStorage dolu.';
                        homeBackgroundMessage.className = 'mt-2 text-danger';
                    }
                }
            } else if (homeBackgroundMessage) {
                homeBackgroundMessage.textContent = 'Lütfen önce bir resim seçin ve yükleyin.';
                homeBackgroundMessage.className = 'mt-2 text-warning';
            }
        }); }
        if (deleteHomeBackgroundBtn) { deleteHomeBackgroundBtn.addEventListener('click', () => {
            if (!isAdminLoggedIn) return;
            if (confirm("Ana sayfa arka plan resmini silmek istediğinizden emin misiniz?")) {
                localStorage.removeItem(HOME_BACKGROUND_IMAGE_KEY);
                if (homeBackgroundImageInput) homeBackgroundImageInput.value = null;
                if (homeBackgroundImagePreview) {
                    homeBackgroundImagePreview.src = '#';
                    homeBackgroundImagePreview.style.display = 'none';
                }
                if (homeBackgroundMessage) {
                    homeBackgroundMessage.textContent = 'Arka plan resmi silindi.';
                    homeBackgroundMessage.className = 'mt-2 text-info';
                }
                loadHomeBackgroundImage();
            }
        }); }
        if (exportQuestionsJsonBtn) { exportQuestionsJsonBtn.addEventListener('click', () => {
            if (!isAdminLoggedIn || !currentGradeLevel) {
                alert("Lütfen önce bir sınıf düzeyi seçin."); return;
            }
            if (questions.length === 0) {
                if(questionIoMessage) { questionIoMessage.textContent = "Dışa aktarılacak soru bulunmuyor."; questionIoMessage.className = 'mt-2 text-warning'; }
                return;
            }
            const questionsToExport = questions.map(q => {
                const { image, ...rest } = q; // Resim base64 olduğu için JSON'a dahil etme
                return rest;
            });
            const jsonData = JSON.stringify(questionsToExport, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const gradeFileName = String(currentGradeLevel).replace('_', '-');
            a.download = `bilgi_yarismasi_sorular_${gradeFileName}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url);
            if(questionIoMessage) { questionIoMessage.textContent = `${questionsToExport.length} soru JSON olarak indirildi.`; questionIoMessage.className = 'mt-2 text-success'; }
        });}
        if (importQuestionsJsonFile) { importQuestionsJsonFile.addEventListener('change', (event) => {
             if (!isAdminLoggedIn || !currentGradeLevel) {
                alert("Soruları içe aktarmak için lütfen önce bir sınıf düzeyi seçin.");
                importQuestionsJsonFile.value = ''; return;
            }
            const file = event.target.files[0];
            if (!file) { return; }
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedQs = JSON.parse(e.target.result);
                    if (!Array.isArray(importedQs)) throw new Error("JSON dosyası bir dizi içermelidir.");
                    let importedCount = 0;
                    const currentQuestionIds = new Set(questions.map(q => q.id));
                    importedQs.forEach(iq => {
                        if (iq.text && iq.correctAnswerTexts && Array.isArray(iq.correctAnswerTexts) && iq.correctAnswerTexts.length > 0) {
                            let newId = iq.id || Date.now() + importedCount * 10 + Math.floor(Math.random()*10);
                            while(currentQuestionIds.has(newId)){
                                newId = Date.now() + importedCount * 10 + Math.floor(Math.random()*10) + 1; // Ensure unique ID
                            }
                            const newQuestion = {
                                id: newId,
                                section: iq.section || "Genel",
                                text: iq.text, image: null, // Resim JSON'dan gelmez, manuel eklenmeli
                                correctAnswerTexts: iq.correctAnswerTexts,
                                timeLimit: parseInt(iq.timeLimit) || 30,
                                nextQuestionPassword: iq.nextQuestionPassword || null
                            };
                            questions.push(newQuestion);
                            currentQuestionIds.add(newId);
                            if (!(typeof currentGradeLevel === 'string' && currentGradeLevel.includes('_YEDEK'))) {
                                players.forEach(player => {
                                    if (!player.answers) player.answers = [];
                                    player.answers.push({ questionId: newQuestion.id, answerText: '', state: 'pending', points: 0 });
                                });
                            }
                            importedCount++;
                        }
                    });
                    if (importedCount > 0) {
                        saveQuestions();
                        if (!(typeof currentGradeLevel === 'string' && currentGradeLevel.includes('_YEDEK'))) {
                            savePersistentPlayers();
                        }
                        renderExistingQuestions(); updateQuestionCount();
                        const gradeDisplayName = adminGradeLevelSelect.options[adminGradeLevelSelect.selectedIndex].text;
                        if(questionIoMessage) { questionIoMessage.textContent = `${importedCount} soru "${gradeDisplayName}" bankasına aktarıldı.`; questionIoMessage.className = 'mt-2 text-success'; }
                    } else {
                         if(questionIoMessage) { questionIoMessage.textContent = "JSON dosyasında geçerli soru bulunamadı."; questionIoMessage.className = 'mt-2 text-danger'; }
                    }
                } catch (error) {
                     if(questionIoMessage) { questionIoMessage.textContent = `Hata: ${error.message}`; questionIoMessage.className = 'mt-2 text-danger'; }
                } finally { importQuestionsJsonFile.value = ''; }
            };
            reader.onerror = () => { if(questionIoMessage) {questionIoMessage.textContent = "Dosya okunurken hata."; questionIoMessage.className = 'mt-2 text-danger';} };
            reader.readAsText(file);
        });}

        if (csvExportButtonAdmin) {
            csvExportButtonAdmin.addEventListener('click', () => {
                if (!isAdminLoggedIn || !currentGradeLevel) {
                    alert("Lütfen önce bir sınıf düzeyi veya soru bankası seçin.");
                    return;
                }
                const csvData = generateCSVContent(currentGradeLevel, players, questions);
                if (csvData) {
                    const gradeFilePart = String(currentGradeLevel).replace('_YEDEK', '_YEDEK_Bankasi');
                    downloadCSV(csvData, `cevaplar_admin_${gradeFilePart}.csv`);
                     if(questionIoMessage) { questionIoMessage.textContent = `Cevaplar CSV olarak indirildi.`; questionIoMessage.className = 'mt-2 text-success'; }
                } else {
                    alert("Bu sınıf/banka için kaydedilmiş cevap verisi bulunmuyor veya yarışmacı/soru yok.");
                     if(questionIoMessage) { questionIoMessage.textContent = `İndirilecek cevap verisi yok.`; questionIoMessage.className = 'mt-2 text-warning'; }
                }
            });
        }

        if (csvExportButtonResults) {
            csvExportButtonResults.addEventListener('click', () => {
                if (!currentGradeLevel || !players || players.length === 0 || !questions || questions.length === 0) {
                     alert("Sonuçları indirilecek aktif bir yarışma verisi bulunamadı.");
                     return;
                }
                const csvData = generateCSVContent(currentGradeLevel, players, questions);
                 if (csvData) {
                    const gradeFilePart = String(currentGradeLevel).replace('_YEDEK', '_YEDEK_Bankasi');
                    downloadCSV(csvData, `cevaplar_sonuclar_${gradeFilePart}.csv`);
                } else {
                    alert("Bu yarışma için kaydedilmiş cevap verisi bulunmuyor.");
                }
            });
        }

        function applyTheme(themeName) {
            document.documentElement.setAttribute('data-theme', themeName);
            localStorage.setItem(THEME_KEY, themeName);
            if(themeSelect) themeSelect.value = themeName;
            if (timeEndedMessage) {
                 let gradient = 'var(--danger-gradient)';
                if (themeName === 'dark') gradient = 'linear-gradient(135deg, #e0527a 0%, #d9c530 100%)';
                else if (themeName === 'vibrant') gradient = 'linear-gradient(135deg, #ff9f43 0%, #ff6b6b 100%)';
                timeEndedMessage.style.background = gradient;
            }
            if (winnerTextDisplay) {
                 let gradient = 'var(--success-gradient)';
                if (themeName === 'dark') gradient = 'linear-gradient(135deg, #2f8cfe 0%, #00d2d2 100%)';
                else if (themeName === 'vibrant') gradient = 'linear-gradient(135deg, #1dd1a1 0%, #48dbfb 100%)';
                winnerTextDisplay.style.background = gradient;
            }
        }
        function loadTheme() {
            const savedTheme = localStorage.getItem(THEME_KEY) || 'light';
            applyTheme(savedTheme);
        }
        function updateFontSize(newSize) {
            const newSizePx = `${newSize}px`;
            document.documentElement.style.setProperty('--font-base-size', newSizePx);
            if(currentFontSizeDisplay) currentFontSizeDisplay.value = newSizePx;
            localStorage.setItem(FONT_SIZE_KEY, newSize);
        }
        function loadFontSize() {
            let savedSize = parseInt(localStorage.getItem(FONT_SIZE_KEY));
            if (isNaN(savedSize) || savedSize < 10 || savedSize > 24) {
                savedSize = 16;
            }
            updateFontSize(savedSize);
        }
        function loadSoundEffectsSetting() {
            const savedState = localStorage.getItem(SOUND_EFFECTS_KEY);
            soundEffectsEnabled = savedState === null ? true : (savedState === 'true');
            if(toggleSoundEffectsCheckbox) toggleSoundEffectsCheckbox.checked = soundEffectsEnabled;
        }
        function playSound(soundElement) {
            if (soundEffectsEnabled && soundElement && soundElement.readyState >= 2) {
                if (soundElement !== timeUpSound && !soundElement.paused) {
                    soundElement.pause();
                    soundElement.currentTime = 0;
                } else if (soundElement.paused) {
                    soundElement.currentTime = 0;
                }
                soundElement.play().catch(error => console.warn("Ses çalınamadı:", error.name, error.message, soundElement.src));
            }
        }

        function startQuizPreview() {
            startFromQuestion21Mode = false;
            if (!currentGradeLevel) {
                alert("Lütfen önce önizlemek için bir sınıf düzeyi veya soru bankası seçin.");
                return;
            }
            previewQuestions = [...questions];
            const gradeDisplayName = adminGradeLevelSelect.options[adminGradeLevelSelect.selectedIndex].text;
            if(previewTitleDisplay) previewTitleDisplay.textContent = `${gradeDisplayName} - Soru Önizleme (1.den itibaren)`;
            showPage('quiz-preview');
            if (previewQuestions.length === 0) {
                if(noPreviewQuestionsMessage) noPreviewQuestionsMessage.style.display = 'block';
                if(previewQuestionContainer) previewQuestionContainer.style.display = 'none';
                if(previewNavigationButtons) previewNavigationButtons.style.display = 'none';
                return;
            }
            if(noPreviewQuestionsMessage) noPreviewQuestionsMessage.style.display = 'none';
            if(previewQuestionContainer) previewQuestionContainer.style.display = 'block';
            if(previewNavigationButtons) previewNavigationButtons.style.display = 'flex';

            if(previewPreviousQuestionBtn) previewPreviousQuestionBtn.style.display = 'inline-block';
            if(previewShowAnswerBtn) previewShowAnswerBtn.style.display = 'inline-block';
            if(previewNextQuestionBtn) previewNextQuestionBtn.style.display = 'inline-block';
            if(previewNextYedekQuestionBtn) previewNextYedekQuestionBtn.style.display = 'none';

            currentPreviewQuestionIndex = 0;
            loadPreviewQuestion();
        }
        function loadPreviewQuestion() {
            if (currentPreviewQuestionIndex < 0 || currentPreviewQuestionIndex >= previewQuestions.length) {
                if (startFromQuestion21Mode) {
                    alert("Tüm yedek sorular gösterildi veya limite ulaşıldı.");
                    showPage('home');
                }
                return;
            }
            const question = previewQuestions[currentPreviewQuestionIndex];
            if(!question){
                 console.error("Önizleme sorusu bulunamadı: index", currentPreviewQuestionIndex);
                 if (isAdminLoggedIn) showPage('admin-panel'); else showPage('home');
                 return;
            }
            if(previewQuestionNumberEl) previewQuestionNumberEl.textContent = `${currentPreviewQuestionIndex + 1}.`;
            if(previewQuestionTextEl) previewQuestionTextEl.innerHTML = question.text;
            if (question.image && previewQuestionImageEl) {
                previewQuestionImageEl.src = question.image;
                previewQuestionImageEl.style.display = 'block';
            } else if (previewQuestionImageEl) {
                previewQuestionImageEl.style.display = 'none';
                previewQuestionImageEl.src = '#';
            }

            if (startFromQuestion21Mode) {
                if(previewCorrectAnswerDisplayArea) previewCorrectAnswerDisplayArea.style.display = 'none';
                if(previewShowAnswerBtn) previewShowAnswerBtn.style.display = 'none';
                if(previewPreviousQuestionBtn) previewPreviousQuestionBtn.style.display = 'none';
                if(previewNextQuestionBtn) previewNextQuestionBtn.style.display = 'none';

                if (previewNextYedekQuestionBtn) {
                    const hasMoreQuestionsToDisplayInLimit = yedekQuestionsShownCount < MAX_YEDEK_QUESTIONS_TO_SHOW -1;
                    const hasMorePhysicalQuestions = currentPreviewQuestionIndex < previewQuestions.length - 1;
                    const showNextButton = question.nextQuestionPassword && hasMoreQuestionsToDisplayInLimit && hasMorePhysicalQuestions;
                    previewNextYedekQuestionBtn.style.display = showNextButton ? 'inline-block' : 'none';
                }
            } else {
                if(previewCorrectAnswerDisplayArea) previewCorrectAnswerDisplayArea.style.display = 'none';
                if(previewShowAnswerBtn) {
                    previewShowAnswerBtn.innerHTML = '<i class="fas fa-check-circle mr-1"></i>Cevabı Göster';
                    previewShowAnswerBtn.disabled = false;
                    previewShowAnswerBtn.style.display = 'inline-block';
                }
                if(previewPreviousQuestionBtn) {
                     previewPreviousQuestionBtn.disabled = currentPreviewQuestionIndex === 0;
                     previewPreviousQuestionBtn.style.display = 'inline-block';
                }
                if(previewNextQuestionBtn) {
                    previewNextQuestionBtn.disabled = currentPreviewQuestionIndex === previewQuestions.length - 1;
                    previewNextQuestionBtn.style.display = 'inline-block';
                }
                if(previewNextYedekQuestionBtn) previewNextYedekQuestionBtn.style.display = 'none';
            }
        }


        if (themeSelect) {
            themeSelect.addEventListener('change', (e) => applyTheme(e.target.value));
        }
        if (increaseFontSizeBtn) {
            increaseFontSizeBtn.addEventListener('click', () => {
                let currentSize = parseInt(localStorage.getItem(FONT_SIZE_KEY)) || 16;
                if (currentSize < 24) updateFontSize(currentSize + 1);
            });
        }
        if (decreaseFontSizeBtn) {
            decreaseFontSizeBtn.addEventListener('click', () => {
                let currentSize = parseInt(localStorage.getItem(FONT_SIZE_KEY)) || 16;
                if (currentSize > 10) updateFontSize(currentSize - 1);
            });
        }
        if (toggleSoundEffectsCheckbox) {
            toggleSoundEffectsCheckbox.addEventListener('change', (e) => {
                soundEffectsEnabled = e.target.checked;
                localStorage.setItem(SOUND_EFFECTS_KEY, soundEffectsEnabled.toString());
                if (!soundEffectsEnabled) {
                    if (countdownSound && !countdownSound.paused) { countdownSound.pause(); countdownSound.currentTime = 0;}
                    if (timeUpSound && !timeUpSound.paused) { timeUpSound.pause(); timeUpSound.currentTime = 0;}
                }
            });
        }
        if (previewQuizBtn) {
            previewQuizBtn.addEventListener('click', startQuizPreview);
        }
        if (previewExitBtn) {
            previewExitBtn.addEventListener('click', () => {
                startFromQuestion21Mode = false;
                yedekQuestionsShownCount = 0;
                if (isAdminLoggedIn && adminManagementPanel.style.display === 'block') {
                     showPage('admin-panel');
                } else {
                    showPage('home');
                }
            });
        }
        if (previewPreviousQuestionBtn) {
            previewPreviousQuestionBtn.addEventListener('click', () => {
                if (currentPreviewQuestionIndex > 0) {
                    currentPreviewQuestionIndex--;
                    loadPreviewQuestion();
                }
            });
        }
        if (previewNextQuestionBtn) {
            previewNextQuestionBtn.addEventListener('click', () => {
                if (currentPreviewQuestionIndex < previewQuestions.length - 1) {
                    currentPreviewQuestionIndex++;
                    loadPreviewQuestion();
                }
            });
        }
        if (previewShowAnswerBtn) {
            previewShowAnswerBtn.addEventListener('click', () => {
                if (!previewQuestions || previewQuestions.length === 0 || currentPreviewQuestionIndex >= previewQuestions.length) return;
                const question = previewQuestions[currentPreviewQuestionIndex];
                if (previewCorrectAnswerDisplayArea.style.display === 'none') {
                    if(previewCorrectAnswerDisplayText) previewCorrectAnswerDisplayText.innerHTML = question.correctAnswerTexts.join(' / ');
                    previewCorrectAnswerDisplayArea.style.display = 'block';
                    previewShowAnswerBtn.innerHTML = '<i class="fas fa-eye-slash mr-1"></i>Cevabı Gizle';
                } else {
                    previewCorrectAnswerDisplayArea.style.display = 'none';
                    previewShowAnswerBtn.innerHTML = '<i class="fas fa-check-circle mr-1"></i>Cevabı Göster';
                }
            });
        }

        if (previewNextYedekQuestionBtn) {
            previewNextYedekQuestionBtn.addEventListener('click', () => {
                if (!startFromQuestion21Mode ||
                    yedekQuestionsShownCount >= MAX_YEDEK_QUESTIONS_TO_SHOW -1 ||
                    currentPreviewQuestionIndex >= previewQuestions.length -1 ) {
                    alert("Gösterilecek başka yedek soru yok veya gösterim limitine ulaşıldı.");
                    showPage('home');
                    return;
                }
                const currentYedekQuestion = previewQuestions[currentPreviewQuestionIndex];
                if (currentYedekQuestion && currentYedekQuestion.nextQuestionPassword) {
                    showPasswordPromptModal(
                        `Sonraki yedek soruya (Soru ${currentPreviewQuestionIndex + 2}) geçmek için şifreyi girin:`,
                        currentYedekQuestion.nextQuestionPassword,
                        () => {
                            yedekQuestionsShownCount++;
                            currentPreviewQuestionIndex++;
                            loadPreviewQuestion();
                        }
                    );
                } else {
                    alert("Sonraki yedek soruya geçilemiyor (şifre yok veya son soru).");
                    if (yedekQuestionsShownCount >= MAX_YEDEK_QUESTIONS_TO_SHOW -1 || currentPreviewQuestionIndex >= previewQuestions.length - 1) {
                        showPage('home');
                    }
                }
            });
        }

        async function initializeApp() {
            initializeGlobalAdminCredentials();
            const initializationPromises = GRADE_LEVELS.map(grade => initializeGradeSpecificData(grade));
            await Promise.all(initializationPromises);

            populateAdminGradeSelect();
            loadHomeBackgroundImage();
            loadTheme();
            loadFontSize();
            loadSoundEffectsSetting();

            showPage('home');
        }

        initializeApp();

        if (homeActionBtn) {
            homeActionBtn.addEventListener('click', () => {
                if (questionTimerInterval) clearInterval(questionTimerInterval);
                [countdownSound, correctAnswerSound, incorrectAnswerSound, timeUpSound, quizEndApplauseSound].forEach(sound => {
                    if (sound && !sound.paused) {
                        sound.pause();
                        sound.currentTime = 0;
                    }
                });

                isQuizInProgress = false;
                currentUserRole = null;
                tempLoginType = null;
                startFromQuestion21Mode = false;
                yedekQuestionsShownCount = 0;
                unlockedUpToQuestionIndex = 0;
                players = [];
                questions = [];
                currentQuestionIndex = 0;
                editingQuestionId = null;

                if(mainAppTitle) mainAppTitle.textContent = "Çavuşoğlu İsmail Yeşilyurt İHO - Bilgi Yarışması";
                showPage('home');
            });
        }
    });
    </script>
</body>
</html>
